!function(h){Craft.CraftSupportWidget=Garnish.Base.extend({widgetId:0,envInfo:null,loading:!1,$widget:null,$pane:null,$screens:null,$currentScreen:null,$nextScreen:null,screens:null,currentScreen:null,$helpBody:null,$feedbackBody:null,init:function(t,e){this.widgetId=t,this.envInfo=e,(Craft.CraftSupportWidget.widgets[this.widgetId]=this).$widget=h("#widget"+t),this.$pane=this.$widget.find("> .front > .pane"),this.$screens=this.$pane.find("> .body > .cs-screen"),this.screens={},this.$currentScreen=this.initScreen(Craft.CraftSupportWidget.SCREEN_HOME).$screen},getScreen:function(t){return this.$screens.filter(".cs-screen-"+t+":first")},initScreen:function(t){return void 0===this.screens[t]?this.screens[t]=this.loadScreen(t):this.screens[t].reinit(),this.screens[t]},loadScreen:function(t){var e=this.getScreen(t);switch(t){case Craft.CraftSupportWidget.SCREEN_HOME:return new s(this,t,e);case Craft.CraftSupportWidget.SCREEN_HELP:return new i(this,t,e);case Craft.CraftSupportWidget.SCREEN_FEEDBACK:return new r(this,t,e);default:throw"Invalid screen: "+t}},gotoScreen:function(t){this.$nextScreen&&(this.$currentScreen.velocity("stop").css({opacity:0,display:"none"}),this.$nextScreen.velocity("stop").css({opacity:1}),this.$pane.velocity("stop"),this.handleScreenAnimationComplete()),this.$nextScreen=this.getScreen(t).css({display:"block",position:"absolute",left:"0px",top:"0px",width:this.$pane.width()+"px"}),this.$pane.height(this.$pane.height()),this.$currentScreen.velocity({opacity:0},{display:"none"}),this.$nextScreen.velocity({opacity:1}),this.$pane.velocity({height:this.$nextScreen.outerHeight()},{complete:h.proxy(this,"handleScreenAnimationComplete")}),this.currentScreen=this.initScreen(t)},handleScreenAnimationComplete:function(){this.$pane.height("auto"),this.$nextScreen.css({position:"relative",width:"auto"}),this.$currentScreen=this.$nextScreen,this.$nextScreen=null}},{widgets:{},SCREEN_HOME:"home",SCREEN_HELP:"help",SCREEN_FEEDBACK:"feedback"});var t=Garnish.Base.extend({widget:null,screen:null,$screen:null,init:function(t,e,s){this.widget=t,this.screen=e,this.$screen=s,this.afterInit()},afterInit:h.noop,reinit:h.noop}),s=t.extend({afterInit:function(){var t=this.$screen.children(".cs-opt");this.addListener(t,"click","handleOptionClick")},handleOptionClick:function(t){var e=h.attr(t.currentTarget,"data-screen");this.widget.gotoScreen(e)}}),o=t.extend({$body:null,$formContainer:null,mode:null,bodyStartHeight:null,$searchResultsContainer:null,$searchResults:null,$searchForm:null,$searchParams:null,$searchSubmit:null,searchTimeout:null,showingResults:!1,$supportForm:null,$supportMessage:null,$supportAttachment:null,$supportSubmit:null,$supportSpinner:null,$supportErrorList:null,$supportIframe:null,sendingSupportTicket:!1,afterInit:function(){this.$body=this.$screen.find(".cs-body-text:first").trigger("focus"),this.$formContainer=this.$screen.children(".cs-forms"),this.$searchResultsContainer=this.$screen.children(".cs-search-results-container:first"),this.$searchResults=this.$searchResultsContainer.find(".cs-search-results:first"),this.$searchForm=this.$formContainer.children(".cs-search-form:first"),this.$searchParams=this.$searchForm.children(".cs-search-params:first"),this.$searchSubmit=this.$searchForm.children(".submit:first"),this.addListener(this.$searchForm,"submit","handleSearchFormSubmit"),this.addListener(this.$searchForm.find("> p > a"),"click","handleSupportLinkClick"),this.$supportForm=this.$formContainer.children(".cs-support-form:first"),this.$supportMessage=this.$supportForm.children("input.cs-support-message");var t=this.$supportForm.children(".cs-support-more");this.$supportAttachment=t.find(".cs-support-attachment:first"),this.$supportSubmit=this.$supportForm.children(".submit:first"),this.$supportSpinner=this.$supportForm.children(".spinner:first"),this.$supportIframe=this.$screen.children("iframe"),this.addListener(this.$supportForm,"submit","handleSupportFormSubmit"),this.bodyStartHeight=this.$body.height(),this.addListener(this.$body,"textchange","handleBodyTextChange"),this.addListener(this.$body,"keydown","handleBodyKeydown"),this.prepForSearch(!1)},handleSearchFormSubmit:function(t){this.$body.val()||t.preventDefault()},handleBodyTextChange:function(){var t=this.$body.val();if(this.mode===o.MODE_SEARCH)if(this.clearSearchTimeout(),this.searchTimeout=setTimeout(h.proxy(this,"search"),500),t){this.$searchParams.html("");var e=this.getFormParams(t);for(var s in e)e.hasOwnProperty(s)&&h("<input/>",{type:"hidden",name:s,value:e[s]}).appendTo(this.$searchParams);this.$searchSubmit.removeClass("disabled")}else this.$searchSubmit.addClass("disabled");else t?(this.$supportMessage.val(t),this.$supportSubmit.removeClass("disabled")):this.$supportSubmit.addClass("disabled")},handleBodyKeydown:function(t){switch(t.keyCode){case Garnish.ESC_KEY:this.mode===o.MODE_SEARCH?this.widget.gotoScreen(Craft.CraftSupportWidget.SCREEN_HOME):this.sendingSupportTicket||this.prepForSearch(!0);break;case Garnish.RETURN_KEY:Garnish.isCtrlKeyPressed(t)&&(this.mode===o.MODE_SEARCH?this.$searchForm.trigger("submit"):this.$supportForm.trigger("submit"))}},handleSupportLinkClick:function(){this.prepForSupport(!0)},clearSearchTimeout:function(){this.searchTimeout&&(clearTimeout(this.searchTimeout),this.searchTimeout=null)},search:function(){if(this.clearSearchTimeout(),this.$body.val()){var t=this.getSearchUrl(this.$body.val());h.ajax({url:t,dataType:"json",success:h.proxy(this,"handleSearchSuccess"),error:h.proxy(this,"hideSearchResults")})}else this.hideSearchResults()},handleSearchSuccess:function(t){if(this.mode===o.MODE_SEARCH){var e=this.getSearchResults(t);if(e.length){var s;this.showingResults?s=this.$searchResultsContainer.height():(this.$searchResultsContainer.removeClass("hidden"),s=0,this.showingResults=!0,this.$screen.addClass("with-results")),this.$searchResults.html("");for(var i=Math.min(e.length,20),r=0;r<i;r++)this.$searchResults.append(h("<li>").append(h("<a>",{href:this.getSearchResultUrl(e[r]),target:"_blank",html:'<span class="status '+this.getSearchResultStatus(e[r])+'"></span>'+this.getSearchResultText(e[r])})));var n=this.$searchResultsContainer.height("auto").height();this.$searchResultsContainer.velocity("stop").height(s).velocity({height:n},{complete:h.proxy(function(){this.$searchResultsContainer.height("auto")},this)})}else this.hideSearchResults()}},hideSearchResults:function(){this.mode===o.MODE_SEARCH&&this.showingResults&&(this.$searchResultsContainer.velocity("stop").height(this.$searchResultsContainer.height()).velocity({height:0},{complete:h.proxy(function(){this.$searchResultsContainer.addClass("hidden")},this)}),this.showingResults=!1,this.$screen.removeClass("with-results"))},handleSupportFormSubmit:function(t){this.$body.val()&&!this.sendingSupportTicket?(this.sendingSupportTicket=!0,this.$supportSubmit.addClass("active"),this.$supportSpinner.removeClass("hidden")):t.preventDefault()},reinit:function(){this.$body.trigger("focus")},prepForSearch:function(t){this.mode=o.MODE_SEARCH,this.$body.velocity("stop").trigger("focus"),this.$supportErrorList&&(this.$supportErrorList.remove(),this.$supportErrorList=null),t?this.$body.velocity({height:this.bodyStartHeight}):this.$body.height(this.bodyStartHeight),this.swapForms(this.$supportForm,this.$searchForm,t),this.handleBodyTextChange(),this.search()},prepForSupport:function(t){this.clearSearchTimeout(),this.hideSearchResults(),this.mode=o.MODE_SUPPORT,this.$body.velocity("stop").trigger("focus"),t?this.$body.velocity({height:2*this.bodyStartHeight}):this.$body.height(2*this.bodyStartHeight),this.swapForms(this.$searchForm,this.$supportForm,t),this.handleBodyTextChange()},swapForms:function(t,e,s){if(s){this.$formContainer.height(this.$formContainer.height());var i=this.$formContainer.width();t.velocity("stop").css({position:"absolute",top:0,left:0,width:i}).velocity({opacity:0},{complete:function(){t.addClass("hidden").css({position:"relative",width:"auto"})}}),e.velocity("stop").removeClass("hidden").css({position:"absolute",top:0,left:0,width:i}).velocity({opacity:1},{complete:function(){e.css({position:"relative",width:"auto"})}}),this.$formContainer.velocity("stop").velocity({height:e.height()},{complete:h.proxy(function(){this.$formContainer.css({height:"auto"})},this)})}else t.addClass("hidden"),e.removeClass("hidden")},parseSupportResponse:function(t){if(this.sendingSupportTicket=!1,this.$supportSubmit.removeClass("active"),this.$supportSpinner.addClass("hidden"),this.$supportErrorList&&this.$supportErrorList.children().remove(),t.errors)for(var e in this.$supportErrorList||(this.$supportErrorList=h('<ul class="errors"/>').insertAfter(this.$supportForm)),t.errors)if(t.errors.hasOwnProperty(e))for(var s=0;s<t.errors[e].length;s++){var i=t.errors[e][s];h("<li>"+i+"</li>").appendTo(this.$supportErrorList)}t.success&&(Craft.cp.displayNotice(Craft.t("Message sent successfully.")),this.$body.val(""),this.$supportMessage.val(""),this.$supportAttachment.val("")),this.$supportIframe.html("")},getFormParams:function(){throw"getFormParams() must be implemented"},getSearchUrl:function(){throw"getSearchUrl() must be implemented"},getSearchResults:function(){throw"getSearchResults() must be implemented"},getSearchResultUrl:function(){throw"getSearchResultUrl() must be implemented"},getSearchResultStatus:function(){throw"getSearchResultStatus() must be implemented"},getSearchResultText:function(){throw"getSearchResultUrl() must be implemented"}},{MODE_SEARCH:"search",MODE_SUPPORT:"support"}),i=o.extend({getFormParams:function(t){return{title:t}},getSearchUrl:function(t){return"https://api.stackexchange.com/2.2/similar?site=craftcms&sort=relevance&order=desc&title="+encodeURIComponent(t)},getSearchResults:function(t){return t.items||[]},getSearchResultUrl:function(t){return t.link},getSearchResultStatus:function(t){return t.is_answered?"green":""},getSearchResultText:function(t){return t.title}}),r=o.extend({getFormParams:function(t){var e="### Description\n\n\n\n### Steps to reproduce\n\n1.\n2.\n\n### Additional info\n";for(var s in this.widget.envInfo)this.widget.envInfo.hasOwnProperty(s)&&(e+="\n- "+s+": "+this.widget.envInfo[s]);return{title:t,body:e}},getSearchUrl:function(t){return"https://api.github.com/search/issues?q=type:issue+repo:craftcms/cms+"+encodeURIComponent(t)},getSearchResults:function(t){return t.items||[]},getSearchResultUrl:function(t){return t.html_url},getSearchResultStatus:function(t){return"open"===t.state?"green":"red"},getSearchResultText:function(t){return t.title}})}(jQuery);
//# sourceMappingURL=CraftSupportWidget.js.map