!function(t){var i=Garnish.Base.extend({tokens:null,routes:null,$container:null,$addRouteBtn:null,sorter:null,init:function(){this.tokens={},this.routes=[],this.$container=t("#routes");for(var i=this.getRoutes(),s=0;s<i.length;s++){var r=new e(i[s]);this.routes.push(r)}this.sorter=new Garnish.DragSort(i,{axis:Garnish.Y_AXIS,onSortChange:t.proxy(this,"updateRouteOrder")}),this.$addRouteBtn=t("#add-route-btn"),this.addListener(this.$addRouteBtn,"click","addRoute")},getRoutes:function(){return this.$container.children()},updateRouteOrder:function(){for(var i=this.getRoutes(),e={},s=0;s<i.length;s++)e["routeUids["+s+"]"]=t(i[s]).attr("data-uid");Craft.postActionRequest("routes/update-route-order",e,t.proxy((function(t,i){"success"===i&&(t.success?Craft.cp.displayNotice(Craft.t("app","New route order saved.")):Craft.cp.displayError(Craft.t("app","Couldn’t save new route order.")))}),this))},addRoute:function(){new s}}),e=Garnish.Base.extend({$container:null,uid:null,siteUid:null,$siteLabel:null,$uri:null,$template:null,modal:null,init:function(i){this.$container=t(i),this.uid=this.$container.data("uid"),this.siteUid=this.$container.data("site-uid"),this.$siteLabel=this.$container.find(".site:first"),this.$uri=this.$container.find(".uri:first"),this.$template=this.$container.find(".template:first"),this.addListener(this.$container,"click","edit")},edit:function(){this.modal?this.modal.show():this.modal=new s(this)},updateHtmlFromModal:function(){var t;if(Craft.isMultiSite)if(this.siteUid){for(t=0;t<Craft.sites.length;t++)if(Craft.sites[t].uid==this.siteUid){this.$siteLabel.text(Craft.sites[t].name);break}}else this.$siteLabel.text(Craft.t("app","Global"));var i="";for(t=0;t<this.modal.uriInput.elements.length;t++){var e=this.modal.uriInput.elements[t];this.modal.uriInput.isText(e)?i+=Craft.escapeHtml(e.val()):i+=e.prop("outerHTML")}this.$uri.html(i),this.$template.text(this.modal.$templateInput.val())}}),s=Garnish.Modal.extend({route:null,$heading:null,$uriInput:null,$uriErrors:null,uriElements:null,$templateInput:null,$saveBtn:null,$cancelBtn:null,$spinner:null,$deleteBtn:null,loading:!1,init:function(i){this.route=i;var e="<h4>"+Craft.t("app","Add a token")+"</h4>";for(var s in Craft.routes.tokens){if(Craft.routes.tokens.hasOwnProperty(s))e+='<div class="token" data-name="'+s+'" data-value="'+Craft.routes.tokens[s]+'"><span>'+s+"</span></div>"}var r,a='<form class="modal fitted route-settings" accept-charset="UTF-8"><div class="header"><h1></h1></div><div class="body"><div class="uri-field field"><div class="heading"><label for="uri">'+Craft.t("app","If the URI looks like this")+':</label></div><div class="input">';if(Craft.isMultiSite&&(a+='<div class="flex"><div class="flex-grow">'),a+='<div id="uri" class="text uri ltr"></div>',Craft.isMultiSite){for(a+='</div><div class="select"><select class="site"><option value="">'+Craft.t("app","Global")+"</option>",r=0;r<Craft.sites.length;r++){var n=Craft.sites[r];a+='<option value="'+n.uid+'">'+Craft.escapeHtml(n.name)+"</option>"}a+="</select></div></div>"}a+='</div><div class="uri-tokens">'+e+'</div></div><div class="template-field field"><div class="heading"><label for="template">'+Craft.t("app","Load this template")+':</label></div><div class="input"><input id="template" type="text" class="text fullwidth template ltr"></div></div></div><div class="footer"><div class="buttons right last"><button type="button" class="btn cancel">'+Craft.t("app","Cancel")+'</button><button type="submit" class="btn submit">'+Craft.t("app","Save")+'</button><div class="spinner" style="display: none;"></div></div><a class="delete">'+Craft.t("app","Delete")+"</a></div></form>";var o=t(a).appendTo(Garnish.$bod);if(this.$heading=o.find("h1:first"),this.$siteInput=o.find(".site:first"),this.$uriInput=o.find(".uri:first"),this.$templateInput=o.find(".template:first"),this.$saveBtn=o.find(".submit:first"),this.$cancelBtn=o.find(".cancel:first"),this.$spinner=o.find(".spinner:first"),this.$deleteBtn=o.find(".delete:first"),this.route||this.$deleteBtn.hide(),this.uriInput=new Garnish.MixedInput(this.$uriInput,{dir:"ltr"}),this.route?this.$heading.html(Craft.t("app","Edit Route")):this.$heading.html(Craft.t("app","Create a new route")),this.route){this.$siteInput.val(this.route.siteUid);var u=this.route.$uri.prop("childNodes");for(r=0;r<u.length;r++){var d=u[r];if(Garnish.isTextNode(d))this.uriInput.addTextElement().setVal(d.nodeValue);else this.addUriVar(d)}var l=this.route.$template.text();this.$templateInput.val(l)}this.base(o);var h=this.$container.find(".uri-tokens").children("div");this.addListener(h,"mousedown",(function(t){this.addUriVar(t.currentTarget)})),this.addListener(this.$container,"submit","saveRoute"),this.addListener(this.$cancelBtn,"click","cancel"),this.addListener(this.$deleteBtn,"click","deleteRoute")},addUriVar:function(i){var e=t(i).clone().attr("tabindex","0");this.uriInput.addElement(e),this.addListener(e,"keydown",(function(i){switch(i.keyCode){case Garnish.LEFT_KEY:setTimeout(t.proxy((function(){this.uriInput.focusPreviousElement(e)}),this),1);break;case Garnish.RIGHT_KEY:setTimeout(t.proxy((function(){this.uriInput.focusNextElement(e)}),this),1);break;case Garnish.DELETE_KEY:setTimeout(t.proxy((function(){this.uriInput.removeElement(e)}),this),1),i.preventDefault()}}))},show:function(){this.route&&(this.$heading.html(Craft.t("app","Edit Route")),this.$deleteBtn.show()),setTimeout(function(){if(this.uriInput.elements.length){var t=this.uriInput.elements[0];this.uriInput.setFocus(t),this.uriInput.setCarotPos(t,0)}else this.$uriInput.trigger("focus")}.bind(this),100),this.base()},saveRoute:function(i){if(i.preventDefault(),!this.loading){this.$container.find(".uri-field .input").removeClass("errors"),this.$uriErrors&&(this.$uriErrors.remove(),this.$uriErrors=null);var s,r,a={siteUid:this.$siteInput.val()};this.route&&(a.routeUid=this.route.uid);for(var n=0;n<this.uriInput.elements.length;n++)if(s=this.uriInput.elements[n],this.uriInput.isText(s)){if(r=s.val(),0===n){if(r=Craft.ltrim(r,"/"),Craft.startsWith(r,Craft.actionTrigger+"/"))return void this.addUriError(Craft.t("app","The URI can’t begin with the {setting} config setting.",{setting:"actionTrigger"}));if(Craft.cpTrigger&&Craft.startsWith(r,Craft.cpTrigger+"/"))return void this.addUriError(Craft.t("app","The URI can’t begin with the {setting} config setting.",{setting:"cpTrigger"}))}a["uriParts["+n+"]"]=r}else a["uriParts["+n+"][0]"]=s.attr("data-name"),a["uriParts["+n+"][1]"]=s.attr("data-value");a.template=this.$templateInput.val(),this.loading=!0,this.$saveBtn.addClass("active"),this.$spinner.show(),Craft.postActionRequest("routes/save-route",a,t.proxy((function(i,s){if(this.$saveBtn.removeClass("active"),this.$spinner.hide(),this.loading=!1,"success"===s)if(i.success){if(!this.route){var r='<div class="route" data-uid="'+i.routeUid+'"'+(i.siteUid?' data-site-uid="'+i.siteUid+'"':"")+'><div class="uri-container">';Craft.isMultiSite&&(r+='<span class="site"></span>');var a=t(r+='<span class="uri" dir="ltr"></span></div><div class="template" dir="ltr"></div></div>');a.appendTo("#routes"),this.route=new e(a),this.route.modal=this,Craft.routes.sorter.addItems(a),1===Craft.routes.sorter.$items.length&&t("#noroutes").addClass("hidden")}this.route.siteUid=i.siteUid,this.route.updateHtmlFromModal(),this.hide(),Craft.cp.displayNotice(Craft.t("app","Route saved."))}else i.errors?i.errors.uri:Craft.cp.displayError(Craft.t("app","Couldn’t save route."))}),this))}},addUriError:function(t){this.$container.find(".uri-field .input").addClass("errors"),this.$uriErrors?Craft.ui.addErrorsToList(this.$uriErrors,[t]):(this.$uriErrors=Craft.ui.createErrorList([t]),this.$uriErrors.insertAfter(this.$container.find(".uri-field .input")))},cancel:function(){this.hide(),this.route&&(this.route.modal=null)},deleteRoute:function(){confirm(Craft.t("app","Are you sure you want to delete this route?"))&&(Craft.postActionRequest("routes/delete-route",{routeUid:this.route.uid},(function(t,i){"success"===i&&Craft.cp.displayNotice(Craft.t("app","Route deleted."))})),Craft.routes.sorter.removeItems(this.route.$container),this.route.$container.remove(),this.hide(),0===Craft.routes.sorter.$items.length&&t("#noroutes").removeClass("hidden"))}});Craft.routes=new i}(jQuery);
//# sourceMappingURL=routes.min.js.map
