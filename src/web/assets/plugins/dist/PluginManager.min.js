!function(c){Craft.PluginManager=Garnish.Base.extend({init:function(){this.getPluginLicenseInfo().then(function(e){for(var n in e)e.hasOwnProperty(n)&&(e[n].isComposerInstalled?new t(this,c("#plugin-"+n)).update(e[n]):this.addUninstalledPluginRow(n,e[n]))}.bind(this))},getPluginLicenseInfo:function(){return new Promise(function(t,i){Craft.sendApiRequest("GET","cms-licenses",{params:{include:"plugins"}}).then(function(e){Craft.postActionRequest("app/get-plugin-license-info",{pluginLicenses:e.license.pluginLicenses||[]},function(e,n){"success"===n?t(e):i()},{contentType:"json"})}).catch(i)})},addUninstalledPluginRow:function(e,n){var t=c("#plugins");t.length||(t=c("<table/>",{id:"plugins",class:"data fullwidth collapsible",html:"<tbody></tbody>"}),c("#no-plugins").replaceWith(t));var i=c("<tr/>",{data:{handle:e}}).appendTo(t.children("tbody")).append(c("<th/>").append(c("<div/>",{class:"plugin-infos"}).append(c("<div/>",{class:"icon"}).append(c("<img/>",{src:n.iconUrl}))).append(c("<div/>",{class:"details"}).append(c("<h2/>",{text:n.name})).append(n.description?c("<p/>",{text:n.description}):c()).append(n.documentationUrl?c("<p/>",{class:"links"}).append(c("<a/>",{href:n.documentationUrl,target:"_blank",text:Craft.t("app","Documentation")})):c()).append(c("<div/>",{class:"flex license-key"}).append(c("<div />",{class:"pane"}).append(c("<input/>",{class:"text code",size:29,maxlength:29,value:Craft.PluginManager.normalizeUserKey(n.licenseKey),readonly:!0,disabled:!0}))))))).append(c("<td/>",{class:"nowrap","data-title":Craft.t("app","Status")}).append(c("<span/>",{class:"status"})).append(c("<span/>",{class:"light",text:Craft.t("app","Missing")}))).append(n.latestVersion?c("<td/>",{class:"nowrap thin","data-title":Craft.t("app","Action")}).append(c("<form/>",{method:"post","accept-charset":"UTF-8"}).append(c("<input/>",{type:"hidden",name:"action",value:"pluginstore/install"})).append(c("<input/>",{type:"hidden",name:"packageName",value:n.packageName})).append(c("<input/>",{type:"hidden",name:"handle",value:e})).append(c("<input/>",{type:"hidden",name:"edition",value:n.licensedEdition})).append(c("<input/>",{type:"hidden",name:"version",value:n.latestVersion})).append(c("<input/>",{type:"hidden",name:"licenseKey",value:n.licenseKey})).append(c("<input/>",{type:"hidden",name:"return",value:"settings/plugins"})).append(Craft.getCsrfInput()).append(c("<div/>",{class:"btngroup"}).append(c("<div/>",{class:"btn menubtn","data-icon":"settings"})).append(c("<div/>",{class:"menu","data-align":"right"}).append(c("<ul/>").append(c("<li/>").append(c("<a/>",{class:"formsubmit",text:Craft.t("app","Install")}))))))):c());Craft.initUiElements(i)}},{normalizeUserKey:function(e){return"string"!=typeof e||""===e?"":"$"===e[0]?e:e.replace(/.{4}/g,"$&-").substr(0,29).toUpperCase()}});var t=Garnish.Base.extend({manager:null,$row:null,$details:null,$keyContainer:null,$keyInput:null,$spinner:null,$buyBtn:null,handle:null,updateTimeout:null,init:function(e,n){this.manager=e,this.$row=n,this.$details=this.$row.find(".details"),this.$keyContainer=n.find(".license-key"),this.$keyInput=this.$keyContainer.find("input.text").removeAttr("readonly"),this.$buyBtn=this.$keyContainer.find(".btn"),this.$spinner=n.find(".spinner"),this.handle=this.$row.data("handle"),this.addListener(this.$keyInput,"focus","onKeyFocus"),this.addListener(this.$keyInput,"input","onKeyChange")},getKey:function(){return this.$keyInput.val().replace(/\-/g,"").toUpperCase()},onKeyFocus:function(){this.$keyInput.select()},onKeyChange:function(){this.updateTimeout&&clearTimeout(this.updateTimeout);var e=this.getKey();if(0===e.length||24===e.length||1<e.length&&"$"===e[0]){var n=Craft.PluginManager.normalizeUserKey(e);this.$keyInput.val(n),this.updateTimeout=setTimeout(c.proxy(this,"updateLicenseStatus"),100)}},updateLicenseStatus:function(){this.$spinner.removeClass("hidden"),Craft.postActionRequest("app/update-plugin-license",{handle:this.handle,key:this.getKey()},function(e,n){"success"===n&&this.manager.getPluginLicenseInfo().then(function(e){this.$spinner.addClass("hidden"),this.update(e[this.handle])}.bind(this))}.bind(this))},update:function(e){var n=this.$row.find(".license-key-status");if("valid"==e.licenseKeyStatus||e.licenseIssues.length){var t=c("<span/>",{class:"license-key-status "+(0===e.licenseIssues.length?"valid":"")});n.length?n.replaceWith(t):t.appendTo(this.$row.find(".icon"))}else n.length&&n.remove();var i=this.$row.find(".edition");if(e.hasMultipleEditions||e.isTrial){var a=e.upgradeAvailable?c("<a/>",{href:Craft.getUrl("plugin-store/"+this.handle),class:"edition"}):c("<div/>",{class:"edition"});e.hasMultipleEditions&&c("<div/>",{class:"edition-name",text:e.edition}).appendTo(a),e.isTrial&&c("<div/>",{class:"edition-trial",text:Craft.t("app","Trial")}).appendTo(a),i.length?i.replaceWith(a):a.insertBefore(this.$row.find(".version"))}else i.length&&i.remove();var s=e.licenseKey||"unknown"!==e.licenseKeyStatus;if(s?this.$keyContainer.removeClass("hidden"):this.$keyContainer.addClass("hidden"),s&&e.licenseIssues.length?this.$keyInput.addClass("error"):this.$keyInput.removeClass("error"),this.$row.find("p.error").remove(),e.licenseIssues.length){for(var l,p,d,r=c(),o=0;o<e.licenseIssues.length;o++){switch(e.licenseIssues[o]){case"wrong_edition":d=Craft.t("app","This license is for the {name} edition.",{name:e.licensedEdition.charAt(0).toUpperCase()+e.licensedEdition.substring(1)})+' <a class="btn submit small formsubmit">'+Craft.t("app","Switch")+"</a>";break;case"mismatched":d=Craft.t("app","This license is tied to another Craft install. Visit {url} to resolve.",{url:'<a href="https://id.craftcms.com" rel="noopener" target="_blank">id.craftcms.com</a>'});break;case"astray":d=Craft.t("app","This license isnâ€™t allowed to run version {version}.",{version:e.version});break;case"required":d=Craft.t("app","A license key is required.");break;default:d=Craft.t("app","Your license key is invalid.")}l=c("<p/>",{class:"error",html:d}),r="wrong_edition"===e.licenseIssues[o]?(p=c("<form/>",{method:"post","accept-charset":"UTF-8"}).append(Craft.getCsrfInput()).append(c("<input/>",{type:"hidden",name:"action",value:"plugins/switch-edition"})).append(c("<input/>",{type:"hidden",name:"pluginHandle",value:this.handle})).append(c("<input/>",{type:"hidden",name:"edition",value:e.licensedEdition})).append(l),Craft.initUiElements(p),r.add(p)):r.add(l)}r.appendTo(this.$details),Craft.initUiElements()}var u=this.$row.find(".expired");if(e.expired){var h=c("<p/>",{class:"warning expired",html:Craft.t("app","This license has expired.")+" "+Craft.t("app","<a>Renew now</a> for another year of updates.").replace("<a>",'<a href="'+e.renewalUrl+'" target="_blank">')});u.length?u.replaceWith(h):h.appendTo(this.$details)}s&&!e.licenseKey?(this.$buyBtn.removeClass("hidden"),e.licenseIssues.length?this.$buyBtn.addClass("submit"):this.$buyBtn.removeClass("submit")):this.$buyBtn.addClass("hidden")}})}(jQuery);
//# sourceMappingURL=PluginManager.min.js.map