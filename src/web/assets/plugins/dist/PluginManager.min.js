!function(e){Craft.PluginManager=Garnish.Base.extend({init:function(){this.getPluginLicenseInfo().then(function(t){for(var i in t)t.hasOwnProperty(i)&&(t[i].isComposerInstalled?new n(this,e("#plugin-"+i)).update(t[i]):this.addUninstalledPluginRow(i,t[i]))}.bind(this))},getPluginLicenseInfo:function(){return new Promise((function(e,n){Craft.sendApiRequest("GET","cms-licenses",{params:{include:"plugins"}}).then((function(t){Craft.postActionRequest("app/get-plugin-license-info",{pluginLicenses:t.license.pluginLicenses||[]},(function(t,i){"success"===i?e(t):n()}),{contentType:"json"})})).catch(n)}))},addUninstalledPluginRow:function(n,t){var i=e("#plugins");i.length||(i=e("<table/>",{id:"plugins",class:"data fullwidth collapsible",html:"<tbody></tbody>"}),e("#no-plugins").replaceWith(i));var a=e("<tr/>",{data:{handle:n}}).appendTo(i.children("tbody")).append(e("<th/>").append(e("<div/>",{class:"plugin-infos"}).append(e("<div/>",{class:"icon"}).append(e("<img/>",{src:t.iconUrl}))).append(e("<div/>",{class:"details"}).append(e("<h2/>",{text:t.name})).append(t.description?e("<p/>",{text:t.description}):e()).append(t.documentationUrl?e("<p/>",{class:"links"}).append(e("<a/>",{href:t.documentationUrl,target:"_blank",text:Craft.t("app","Documentation")})):e()).append(e("<div/>",{class:"flex license-key"}).append(e("<div />",{class:"pane"}).append(e("<input/>",{class:"text code",size:29,maxlength:29,value:Craft.PluginManager.normalizeUserKey(t.licenseKey),readonly:!0,disabled:!0}))))))).append(e("<td/>",{class:"nowrap","data-title":Craft.t("app","Status")}).append(e("<span/>",{class:"status"})).append(e("<span/>",{class:"light",text:Craft.t("app","Missing")}))).append(t.latestVersion?e("<td/>",{class:"nowrap thin","data-title":Craft.t("app","Action")}).append(e("<form/>",{method:"post","accept-charset":"UTF-8"}).append(e("<input/>",{type:"hidden",name:"action",value:"pluginstore/install"})).append(e("<input/>",{type:"hidden",name:"packageName",value:t.packageName})).append(e("<input/>",{type:"hidden",name:"handle",value:n})).append(e("<input/>",{type:"hidden",name:"edition",value:t.licensedEdition})).append(e("<input/>",{type:"hidden",name:"version",value:t.latestVersion})).append(e("<input/>",{type:"hidden",name:"licenseKey",value:t.licenseKey})).append(e("<input/>",{type:"hidden",name:"return",value:"settings/plugins"})).append(Craft.getCsrfInput()).append(e("<div/>",{class:"btngroup"}).append(e("<button/>",{type:"button",class:"btn menubtn","data-icon":"settings"})).append(e("<div/>",{class:"menu","data-align":"right"}).append(e("<ul/>").append(e("<li/>").append(e("<button/>",{type:"button",class:"formsubmit",text:Craft.t("app","Install")}))))))):e());Craft.initUiElements(a)}},{normalizeUserKey:function(e){return"string"!=typeof e||""===e?"":"$"===e[0]?e:e.replace(/.{4}/g,"$&-").substr(0,29).toUpperCase()}});var n=Garnish.Base.extend({manager:null,$row:null,$details:null,$keyContainer:null,$keyInput:null,$spinner:null,$buyBtn:null,handle:null,updateTimeout:null,init:function(e,n){this.manager=e,this.$row=n,this.$details=this.$row.find(".details"),this.$keyContainer=n.find(".license-key"),this.$keyInput=this.$keyContainer.find("input.text").removeAttr("readonly"),this.$buyBtn=this.$keyContainer.find(".btn"),this.$spinner=n.find(".spinner"),this.handle=this.$row.data("handle"),this.addListener(this.$keyInput,"focus","onKeyFocus"),this.addListener(this.$keyInput,"input","onKeyChange")},getKey:function(){return this.$keyInput.val().replace(/\-/g,"").toUpperCase()},onKeyFocus:function(){this.$keyInput.select()},onKeyChange:function(){this.updateTimeout&&clearTimeout(this.updateTimeout);var n=this.getKey();if(0===n.length||24===n.length||n.length>1&&"$"===n[0]){var t=Craft.PluginManager.normalizeUserKey(n);this.$keyInput.val(t),this.updateTimeout=setTimeout(e.proxy(this,"updateLicenseStatus"),100)}},updateLicenseStatus:function(){this.$spinner.removeClass("hidden"),Craft.postActionRequest("app/update-plugin-license",{handle:this.handle,key:this.getKey()},function(e,n){"success"===n&&this.manager.getPluginLicenseInfo().then(function(e){this.$spinner.addClass("hidden"),this.update(e[this.handle])}.bind(this))}.bind(this))},update:function(n){var t=this.$row.find(".license-key-status");if("valid"==n.licenseKeyStatus||n.licenseIssues.length){var i=e("<span/>",{class:"license-key-status "+(0===n.licenseIssues.length?"valid":"")});t.length?t.replaceWith(i):i.appendTo(this.$row.find(".icon"))}else t.length&&t.remove();var a=this.$row.find(".edition");if(n.hasMultipleEditions||n.isTrial){var s=n.upgradeAvailable?e("<a/>",{href:Craft.getUrl("plugin-store/"+this.handle),class:"edition"}):e("<div/>",{class:"edition"});n.hasMultipleEditions&&e("<div/>",{class:"edition-name",text:n.edition}).appendTo(s),n.isTrial&&e("<div/>",{class:"edition-trial",text:Craft.t("app","Trial")}).appendTo(s),a.length?a.replaceWith(s):s.insertBefore(this.$row.find(".version"))}else a.length&&a.remove();var l=n.licenseKey||"unknown"!==n.licenseKeyStatus;if(l?this.$keyContainer.removeClass("hidden"):this.$keyContainer.addClass("hidden"),l&&n.licenseIssues.length?this.$keyInput.addClass("error"):this.$keyInput.removeClass("error"),this.$row.find("p.error").remove(),n.licenseIssues.length){for(var p,d,r,o=e(),u=0;u<n.licenseIssues.length;u++){switch(n.licenseIssues[u]){case"wrong_edition":r=Craft.t("app","This license is for the {name} edition.",{name:n.licensedEdition.charAt(0).toUpperCase()+n.licensedEdition.substring(1)})+' <button type="button" class="btn submit small formsubmit">'+Craft.t("app","Switch")+"</button>";break;case"mismatched":r=Craft.t("app","This license is tied to another Craft install. Visit {url} to resolve.",{url:'<a href="https://id.craftcms.com" rel="noopener" target="_blank">id.craftcms.com</a>'});break;case"astray":r=Craft.t("app","This license isnâ€™t allowed to run version {version}.",{version:n.version});break;case"required":r=Craft.t("app","A license key is required.");break;default:r=Craft.t("app","Your license key is invalid.")}p=e("<p/>",{class:"error",html:r}),"wrong_edition"===n.licenseIssues[u]?(d=e("<form/>",{method:"post","accept-charset":"UTF-8"}).append(Craft.getCsrfInput()).append(e("<input/>",{type:"hidden",name:"action",value:"plugins/switch-edition"})).append(e("<input/>",{type:"hidden",name:"pluginHandle",value:this.handle})).append(e("<input/>",{type:"hidden",name:"edition",value:n.licensedEdition})).append(p),Craft.initUiElements(d),o=o.add(d)):o=o.add(p)}o.appendTo(this.$details),Craft.initUiElements()}var h=this.$row.find(".expired");if(n.expired){var c=e("<p/>",{class:"warning with-icon expired",html:Craft.t("app","This license has expired.")+" "+Craft.t("app","<a>Renew now</a> for another year of updates.").replace("<a>",'<a href="'+n.renewalUrl+'" target="_blank">')});h.length?h.replaceWith(c):c.appendTo(this.$details)}l&&!n.licenseKey?(this.$buyBtn.removeClass("hidden"),n.licenseIssues.length?this.$buyBtn.addClass("submit"):this.$buyBtn.removeClass("submit")):this.$buyBtn.addClass("hidden")}})}(jQuery);
//# sourceMappingURL=PluginManager.min.js.map
