!function(e){Craft.UpdatesUtility=Garnish.Base.extend({$body:null,totalAvailableUpdates:0,criticalUpdateAvailable:!1,showUpdateAllBtn:!0,updates:null,init:function(){this.$body=Craft.cp.$content.children(".body");var t=e("#graphic"),a=e("#status");this.updates=[];var s={forceRefresh:!0,includeDetails:!0};Craft.postActionRequest("app/check-for-updates",s,e.proxy(function(s,i){if("success"!==i||s.error){var n=Craft.t("app","An unknown error occurred.");s.errors&&s.errors.length?n=s.errors[0]:s.error&&(n=s.error),t.addClass("error"),a.text(n)}else{if(s.updates.app&&this.processUpdate(s.updates.app,!1),s.updates.plugins&&s.updates.plugins.length)for(var l=0;l<s.updates.plugins.length;l++)this.processUpdate(s.updates.plugins[l],!0);if(this.totalAvailableUpdates){t.remove(),a.remove();var r;if(r=1===this.totalAvailableUpdates?Craft.t("app","1 Available Update"):Craft.t("app","{num} Available Updates",{num:this.totalAvailableUpdates}),e("#page-title").find("h1").text(r),this.showUpdateAllBtn&&this.updates.length>1){var o=e("<div/>",{class:"btn submit",text:Craft.t("app","Update all")}).appendTo(e("<div/>",{id:"extra-headers"}).appendTo(Craft.cp.$pageHeader));this.addListener(o,"click","updateAll")}}else t.addClass("success"),a.text(Craft.t("app","You’re all up-to-date!"))}},this))},processUpdate:function(e,a){e.releases&&e.releases.length&&(this.totalAvailableUpdates++,this.updates.push(new t(this,e,a)))},updateAll:function(){this.redirectToUpdate(this.updates)},redirectToUpdate:function(e){window.location.href=this.buildUpdateUrl(e)},buildUpdateUrl:function(e){return Craft.getUrl("update",{install:this.buildRequirements(e)})},buildRequirements:function(e){for(var t=[],a=0;a<e.length;a++)t.push(e[a].getHandle()+":"+e[a].latestAllowedVersion);return t.join(",")}});var t=Garnish.Base.extend({updateInfo:null,isPlugin:null,latestVersion:null,latestAllowedVersion:null,$container:null,$header:null,$contents:null,$ineligibleReleasesContainer:null,$showIneligibleReleasesLink:null,$releaseContainer:null,$showAllLink:null,licenseHud:null,$licenseSubmitBtn:null,licenseSubmitAction:null,init:function(t,a,s){this.updatesPage=t,this.updateInfo=a,this.isPlugin=s,this.createPane(),this.initReleases(),this.createHeading(),this.createUpdateButtons(),this.updateInfo.breakpoint?e('<blockquote class="note ineligible"><p><strong>You’ve reached a breakpoint!</strong> More updates will become available after you install Doxter 3.1.3.</p>').insertBefore(this.$releaseContainer):this.updateInfo.expired&&e('<blockquote class="note ineligible"><p><strong>Your license has expired!</strong> Renew your Craft CMS license for another year of amazing updates.</p>').insertBefore(this.$releaseContainer),(this.updateInfo.expired||this.updateInfo.licenseUpdated||null===this.latestAllowedVersion)&&(this.updatesPage.showUpdateAllBtn=!1)},getDisplayName:function(){return this.isPlugin?this.updateInfo.displayName:"Craft CMS"},getHandle:function(){return this.isPlugin?this.updateInfo.handle:"craft"},canUpdateToLatest:function(){return this.latestAllowedVersion===this.updateInfo.releases[0].version},createPane:function(){this.$container=e('<div class="update"/>').appendTo(this.updatesPage.$body),this.$header=e('<div class="update-header"/>').appendTo(this.$container),this.$contents=e('<div class="readable"/>').appendTo(this.$container),this.$releaseContainer=e('<div class="releases"/>').appendTo(this.$contents)},createHeading:function(){e('<div class="readable left"/>').appendTo(this.$header).append(e("<h1/>",{text:this.getDisplayName()}))},createUpdateButtons:function(){if(null!==this.latestAllowedVersion){var t=e('<div class="buttons right"/>').appendTo(this.$header);if(this.updateInfo.expired)e("<div/>",{class:"btn submit",text:"Renew for $59"}).appendTo(t);else{var a=this.canUpdateToLatest()?Craft.t("app","Update"):Craft.t("app","Update to {version}",{version:this.latestAllowedVersion}),s=e('<div class="btn submit">'+a+"</div>").appendTo(t);this.updateInfo.licenseUpdated?this.addListener(s,"click","showLicenseForm"):this.addListener(s,"click",function(){this.updatesPage.redirectToUpdate([this])})}}},initReleases:function(){if(this.updateInfo.releases)for(var e=0;e<this.updateInfo.releases.length;e++)null===this.latestAllowedVersion&&this.updateInfo.releases[e].allowed&&(this.latestAllowedVersion=this.updateInfo.releases[e].version),new a(this,this.updateInfo.releases[e])},showLicenseForm:function(t){if(t.stopPropagation(),this.licenseHud)this.licenseHud.$trigger=e(t.currentTarget),this.licenseHud.show();else{var a=e("<div><p>"+Craft.t("app",'Craft’s <a href="http://craftcms.com/license" target="_blank">Terms and Conditions</a> have changed.')+"</p></div>"),s=e("<label> "+Craft.t("app","I agree.")+" &nbsp;</label>").appendTo(a),i=e('<input type="checkbox"/>').prependTo(s);this.$licenseSubmitBtn=e('<input class="btn submit" type="submit"/>').appendTo(a),this.licenseHud=new Garnish.HUD(t.currentTarget,a,{onSubmit:e.proxy(function(){i.prop("checked")?(this.licenseSubmitAction(),this.licenseHud.hide(),i.prop("checked",!1)):Garnish.shake(this.licenseHud.$hud)},this)})}this.$licenseSubmitBtn.attr("value",Craft.t("app","Seriously, update.")),this.licenseSubmitAction=this.redirectToUpdate}}),a=Garnish.Base.extend({update:null,releaseInfo:null,notesId:null,$container:null,$toggle:null,init:function(e,t){this.update=e,this.releaseInfo=t,this.notesId="notes-"+Math.floor(1e6*Math.random()),this.createContainer(),this.createHeading(),this.createReleaseNotes(),new Craft.FieldToggle(this.$toggle)},createContainer:function(){this.$container=e('<div class="pane release"/>').appendTo(this.update.$releaseContainer),this.releaseInfo.critical&&this.$container.addClass("critical")},createHeading:function(){this.$toggle=e("<a/>",{class:"fieldtoggle","data-target":this.notesId}).appendTo(this.$container),e("<h2/>",{text:this.releaseInfo.version}).appendTo(this.$toggle),this.releaseInfo.critical&&e("<strong/>",{class:"critical",text:Craft.t("app","Critical")}).appendTo(this.$toggle),e("<span/>",{class:"date",text:Craft.formatDate(this.releaseInfo.date)}).appendTo(this.$toggle)},createReleaseNotes:function(){e("<div/>",{id:this.notesId,class:"hidden"}).appendTo(this.$container).append(e("<div/>",{class:"release-notes"}).html(this.releaseInfo.notes))}},{maxInitialUpdateHeight:500})}(jQuery);
//# sourceMappingURL=UpdatesUtility.min.js.map