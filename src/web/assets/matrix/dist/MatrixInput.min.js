!function(t){Craft.MatrixInput=Garnish.Base.extend({id:null,blockTypes:null,blockTypesByHandle:null,inputNamePrefix:null,inputIdPrefix:null,showingAddBlockMenu:!1,addBlockBtnGroupWidth:null,addBlockBtnContainerWidth:null,$container:null,$blockContainer:null,$addBlockBtnContainer:null,$addBlockBtnGroup:null,$addBlockBtnGroupBtns:null,blockSort:null,blockSelect:null,totalNewBlocks:0,init:function(i,a,n,s){var l;for(this.id=i,this.blockTypes=a,this.inputNamePrefix=n,this.inputIdPrefix=Craft.formatInputId(this.inputNamePrefix),"number"==typeof s&&(s={maxBlocks:s}),this.setSettings(s,Craft.MatrixInput.defaults),this.$container=t("#"+this.id),this.$blockContainer=this.$container.children(".blocks"),this.$addBlockBtnContainer=this.$container.children(".buttons"),this.$addBlockBtnGroup=this.$addBlockBtnContainer.children(".btngroup"),this.$addBlockBtnGroupBtns=this.$addBlockBtnGroup.children(".btn"),this.$addBlockMenuBtn=this.$addBlockBtnContainer.children(".menubtn"),this.$container.data("matrix",this),this.setNewBlockBtn(),this.blockTypesByHandle={},l=0;l<this.blockTypes.length;l++){var o=this.blockTypes[l];this.blockTypesByHandle[o.handle]=o}var d=this.$blockContainer.children(),c=Craft.MatrixInput.getCollapsedBlockIds();for(this.blockSort=new Garnish.DragSort(d,{handle:"> .actions > .move",axis:"y",filter:t.proxy((function(){return this.blockSort.$targetItem.hasClass("sel")?this.blockSelect.getSelectedItems():this.blockSort.$targetItem}),this),collapseDraggees:!0,magnetStrength:4,helperLagBase:1.5,helperOpacity:.9,onSortChange:t.proxy((function(){this.blockSelect.resetItemOrder()}),this)}),this.blockSelect=new Garnish.Select(this.$blockContainer,d,{multi:!0,vertical:!0,handle:"> .checkbox, > .titlebar",checkboxMode:!0}),l=0;l<d.length;l++){var r=t(d[l]),h=r.data("id"),p="string"==typeof h&&h.match(/new(\d+)/);p&&p[1]>this.totalNewBlocks&&(this.totalNewBlocks=parseInt(p[1]));var u=new e(this,r);u.id&&-1!==t.inArray(""+u.id,c)&&u.collapse()}this.addListener(this.$addBlockBtnGroupBtns,"click",(function(e){var i=t(e.target).data("type");this.addBlock(i)})),new Garnish.MenuBtn(this.$addBlockMenuBtn,{onOptionSelect:t.proxy((function(e){var i=t(e).data("type");this.addBlock(i)}),this)}),this.updateAddBlockBtn(),this.addListener(this.$container,"resize","setNewBlockBtn"),Garnish.$doc.ready(t.proxy(this,"setNewBlockBtn")),this.trigger("afterInit")},setNewBlockBtn:function(){(this.addBlockBtnGroupWidth||(this.addBlockBtnGroupWidth=this.$addBlockBtnGroup.width(),this.addBlockBtnGroupWidth))&&this.addBlockBtnContainerWidth!==(this.addBlockBtnContainerWidth=this.$addBlockBtnContainer.width())&&(this.addBlockBtnGroupWidth>this.addBlockBtnContainerWidth?this.showingAddBlockMenu||(this.$addBlockBtnGroup.addClass("hidden"),this.$addBlockMenuBtn.removeClass("hidden"),this.showingAddBlockMenu=!0):this.showingAddBlockMenu&&(this.$addBlockMenuBtn.addClass("hidden"),this.$addBlockBtnGroup.removeClass("hidden"),this.showingAddBlockMenu=!1,-1!==navigator.userAgent.indexOf("Safari")&&Garnish.requestAnimationFrame(t.proxy((function(){this.$addBlockBtnGroup.css("opacity",.99),Garnish.requestAnimationFrame(t.proxy((function(){this.$addBlockBtnGroup.css("opacity","")}),this))}),this))))},canAddMoreBlocks:function(){return!this.maxBlocks||this.$blockContainer.children().length<this.maxBlocks},updateAddBlockBtn:function(){var t,e;if(this.canAddMoreBlocks())for(this.$addBlockBtnGroup.removeClass("disabled"),this.$addBlockMenuBtn.removeClass("disabled"),t=0;t<this.blockSelect.$items.length;t++)(e=this.blockSelect.$items.eq(t).data("block"))&&e.$actionMenu.find("a[data-action=add]").parent().removeClass("disabled");else for(this.$addBlockBtnGroup.addClass("disabled"),this.$addBlockMenuBtn.addClass("disabled"),t=0;t<this.blockSelect.$items.length;t++)(e=this.blockSelect.$items.eq(t).data("block"))&&e.$actionMenu.find("a[data-action=add]").parent().addClass("disabled")},addBlock:function(i,a){if(this.canAddMoreBlocks()){this.totalNewBlocks++;var n="new"+this.totalNewBlocks,s=`\n<div class="matrixblock" data-id="${n}" data-type="${i}">\n  <input type="hidden" name="${this.inputNamePrefix}[sortOrder][]" value="${n}"/>\n  <input type="hidden" name="${this.inputNamePrefix}[blocks][${n}][type]" value="${i}"/>\n  <input type="hidden" name="${this.inputNamePrefix}[blocks][${n}][enabled]" value="1"/>\n  <div class="titlebar">\n    <div class="blocktype">${this.getBlockTypeByHandle(i).name}</div>\n    <div class="preview"></div>\n  </div>\n  <div class="checkbox" title="${Craft.t("app","Select")}"></div>\n  <div class="actions">\n    <div class="status off" title="${Craft.t("app","Disabled")}"></div>\n    <a class="settings icon menubtn" title="${Craft.t("app","Actions")}" role="button"></a> \n    <div class="menu">\n      <ul class="padded">\n        <li><a data-icon="collapse" data-action="collapse">${Craft.t("app","Collapse")}</a></li>\n        <li class="hidden"><a data-icon="expand" data-action="expand">${Craft.t("app","Expand")}</a></li>\n        <li><a data-icon="disabled" data-action="disable">${Craft.t("app","Disable")}</a></li>\n        <li class="hidden"><a data-icon="enabled" data-action="enable">${Craft.t("app","Enable")}</a></li>\n        <li><a data-icon="uarr" data-action="moveUp">${Craft.t("app","Move up")}</a></li>\n        <li><a data-icon="darr" data-action="moveDown">${Craft.t("app","Move down")}</a></li>\n      </ul>`;if(!this.settings.staticBlocks){s+=`\n      <hr class="padded"/>\n      <ul class="padded">\n        <li><a class="error" data-icon="remove" data-action="delete">${Craft.t("app","Delete")}</a></li>\n      </ul>\n      <hr class="padded"/>\n      <ul class="padded">`;for(var l=0;l<this.blockTypes.length;l++){var o=this.blockTypes[l];s+=`\n        <li><a data-icon="plus" data-action="add" data-type="${o.handle}">${Craft.t("app","Add {type} above",{type:o.name})}</a></li>`}s+="\n      </ul>"}s+=`\n    </div>\n    <a class="move icon" title="${Craft.t("app","Reorder")}" role="button"></a>\n  </div>\n</div>`;var d=t(s);window.draftEditor&&window.draftEditor.pause(),a?d.insertBefore(a):d.appendTo(this.$blockContainer);var c=t('<div class="fields"/>').appendTo(d),r=this.getParsedBlockHtml(this.blockTypesByHandle[i].bodyHtml,n),h=this.getParsedBlockHtml(this.blockTypesByHandle[i].footHtml,n);t(r).appendTo(c),this.trigger("blockAdded",{$block:d}),d.css(this.getHiddenBlockCss(d)).velocity({opacity:1,"margin-bottom":10},"fast",t.proxy((function(){d.css("margin-bottom",""),Garnish.$bod.append(h),Craft.initUiElements(c),new e(this,d),this.blockSort.addItems(d),this.blockSelect.addItems(d),this.updateAddBlockBtn(),Garnish.requestAnimationFrame((function(){Garnish.scrollContainerToElement(d),d.find(".text,[contenteditable]").first().trigger("focus"),window.draftEditor&&window.draftEditor.resume()}))}),this))}},getBlockTypeByHandle:function(t){for(var e=0;e<this.blockTypes.length;e++)if(this.blockTypes[e].handle===t)return this.blockTypes[e]},collapseSelectedBlocks:function(){this.callOnSelectedBlocks("collapse")},expandSelectedBlocks:function(){this.callOnSelectedBlocks("expand")},disableSelectedBlocks:function(){this.callOnSelectedBlocks("disable")},enableSelectedBlocks:function(){this.callOnSelectedBlocks("enable")},deleteSelectedBlocks:function(){this.callOnSelectedBlocks("selfDestruct")},callOnSelectedBlocks:function(t){for(var e=0;e<this.blockSelect.$selectedItems.length;e++)this.blockSelect.$selectedItems.eq(e).data("block")[t]()},getHiddenBlockCss:function(t){return{opacity:0,marginBottom:-t.outerHeight()}},getParsedBlockHtml:function(t,e){return"string"==typeof t?t.replace(new RegExp(`__BLOCK_${this.settings.placeholderKey}__`,"g"),e):""},get maxBlocks(){return this.settings.maxBlocks}},{defaults:{placeholderKey:null,maxBlocks:null,staticBlocks:!1},collapsedBlockStorageKey:"Craft-"+Craft.systemUid+".MatrixInput.collapsedBlocks",getCollapsedBlockIds:function(){return"string"==typeof localStorage[Craft.MatrixInput.collapsedBlockStorageKey]?Craft.filterArray(localStorage[Craft.MatrixInput.collapsedBlockStorageKey].split(",")):[]},setCollapsedBlockIds:function(t){localStorage[Craft.MatrixInput.collapsedBlockStorageKey]=t.join(",")},rememberCollapsedBlockId:function(e){if("undefined"!=typeof Storage){var i=Craft.MatrixInput.getCollapsedBlockIds();-1===t.inArray(""+e,i)&&(i.push(e),Craft.MatrixInput.setCollapsedBlockIds(i))}},forgetCollapsedBlockId:function(e){if("undefined"!=typeof Storage){var i=Craft.MatrixInput.getCollapsedBlockIds(),a=t.inArray(""+e,i);-1!==a&&(i.splice(a,1),Craft.MatrixInput.setCollapsedBlockIds(i))}}});var e=Garnish.Base.extend({matrix:null,$container:null,$titlebar:null,$fieldsContainer:null,$previewContainer:null,$actionMenu:null,$collapsedInput:null,isNew:null,id:null,collapsed:!1,init:function(e,i){this.matrix=e,this.$container=i,this.$titlebar=i.children(".titlebar"),this.$previewContainer=this.$titlebar.children(".preview"),this.$fieldsContainer=i.children(".fields"),this.$container.data("block",this),this.id=this.$container.data("id"),this.isNew=!this.id||"string"==typeof this.id&&"new"===this.id.substr(0,3);var a=this.$container.find("> .actions > .settings"),n=new Garnish.MenuBtn(a);this.$actionMenu=n.menu.$container,n.menu.settings.onOptionSelect=t.proxy(this,"onMenuOptionSelect"),n.menu.on("show",()=>{this.$container.addClass("active"),this.$container.prev(".matrixblock").length?this.$actionMenu.find("a[data-action=moveUp]:first").parent().removeClass("hidden"):this.$actionMenu.find("a[data-action=moveUp]:first").parent().addClass("hidden"),this.$container.next(".matrixblock").length?this.$actionMenu.find("a[data-action=moveDown]:first").parent().removeClass("hidden"):this.$actionMenu.find("a[data-action=moveDown]:first").parent().addClass("hidden")}),n.menu.on("hide",()=>{this.$container.removeClass("active")}),Garnish.hasAttr(this.$container,"data-collapsed")&&this.collapse(),this._handleTitleBarClick=function(t){t.preventDefault(),this.toggle()},this.addListener(this.$titlebar,"doubletap",this._handleTitleBarClick)},toggle:function(){this.collapsed?this.expand():this.collapse(!0)},collapse:function(e){if(!this.collapsed){this.$container.addClass("collapsed");for(var i="",a=this.$fieldsContainer.children().children(),n=0;n<a.length;n++){for(var s=t(a[n]).children(".input").find('select,input[type!="hidden"],textarea,.label'),l="",o=0;o<s.length;o++){var d,c=t(s[o]);if(c.hasClass("label")){var r=c.parent().parent();if(r.hasClass("lightswitch")&&(r.hasClass("on")&&c.hasClass("off")||!r.hasClass("on")&&c.hasClass("on")))continue;d=c.text()}else d=Craft.getText(Garnish.getInputPostVal(c));d instanceof Array&&(d=d.join(", ")),d&&(d=Craft.trim(d))&&(l&&(l+=", "),l+=d)}l&&(i+=(i?" <span>|</span> ":"")+l)}this.$previewContainer.html(i),this.$fieldsContainer.velocity("stop"),this.$container.velocity("stop"),e?(this.$fieldsContainer.velocity("fadeOut",{duration:"fast"}),this.$container.velocity({height:16},"fast")):(this.$previewContainer.show(),this.$fieldsContainer.hide(),this.$container.css({height:16})),setTimeout(t.proxy((function(){this.$actionMenu.find("a[data-action=collapse]:first").parent().addClass("hidden"),this.$actionMenu.find("a[data-action=expand]:first").parent().removeClass("hidden")}),this),200),this.isNew?this.$collapsedInput?this.$collapsedInput.val("1"):this.$collapsedInput=t('<input type="hidden" name="'+this.matrix.inputNamePrefix+"[blocks]["+this.id+'][collapsed]" value="1"/>').appendTo(this.$container):Craft.MatrixInput.rememberCollapsedBlockId(this.id),this.collapsed=!0}},expand:function(){if(this.collapsed){this.$container.removeClass("collapsed"),this.$fieldsContainer.velocity("stop"),this.$container.velocity("stop");var e=this.$container.height();this.$container.height("auto"),this.$fieldsContainer.show();var i=this.$container.height(),a=this.$fieldsContainer.css("display")||"block";if(this.$container.height(e),this.$fieldsContainer.hide().velocity("fadeIn",{duration:"fast",display:a}),this.$container.velocity({height:i},"fast",t.proxy((function(){this.$previewContainer.html(""),this.$container.height("auto")}),this)),setTimeout(t.proxy((function(){this.$actionMenu.find("a[data-action=collapse]:first").parent().removeClass("hidden"),this.$actionMenu.find("a[data-action=expand]:first").parent().addClass("hidden")}),this),200),!this.isNew&&"undefined"!=typeof Storage){var n=Craft.MatrixInput.getCollapsedBlockIds(),s=t.inArray(""+this.id,n);-1!==s&&(n.splice(s,1),Craft.MatrixInput.setCollapsedBlockIds(n))}this.isNew?this.$collapsedInput&&this.$collapsedInput.val(""):Craft.MatrixInput.forgetCollapsedBlockId(this.id),this.collapsed=!1}},disable:function(){this.$container.children('input[name$="[enabled]"]:first').val(""),this.$container.addClass("disabled"),setTimeout(t.proxy((function(){this.$actionMenu.find("a[data-action=disable]:first").parent().addClass("hidden"),this.$actionMenu.find("a[data-action=enable]:first").parent().removeClass("hidden")}),this),200),this.collapse(!0)},enable:function(){this.$container.children('input[name$="[enabled]"]:first').val("1"),this.$container.removeClass("disabled"),setTimeout(t.proxy((function(){this.$actionMenu.find("a[data-action=disable]:first").parent().removeClass("hidden"),this.$actionMenu.find("a[data-action=enable]:first").parent().addClass("hidden")}),this),200)},moveUp:function(){let t=this.$container.prev(".matrixblock");t.length&&(this.$container.insertBefore(t),this.matrix.blockSelect.resetItemOrder())},moveDown:function(){let t=this.$container.next(".matrixblock");t.length&&(this.$container.insertAfter(t),this.matrix.blockSelect.resetItemOrder())},onMenuOptionSelect:function(e){var i=this.matrix.blockSelect.totalSelected>1&&this.matrix.blockSelect.isSelected(this.$container),a=t(e);switch(a.data("action")){case"collapse":i?this.matrix.collapseSelectedBlocks():this.collapse(!0);break;case"expand":i?this.matrix.expandSelectedBlocks():this.expand();break;case"disable":i?this.matrix.disableSelectedBlocks():this.disable();break;case"enable":i?this.matrix.enableSelectedBlocks():(this.enable(),this.expand());break;case"moveUp":this.moveUp();break;case"moveDown":this.moveDown();break;case"add":var n=a.data("type");this.matrix.addBlock(n,this.$container);break;case"delete":i?confirm(Craft.t("app","Are you sure you want to delete the selected blocks?"))&&this.matrix.deleteSelectedBlocks():this.selfDestruct()}},selfDestruct:function(){window.draftEditor&&window.draftEditor.pause(),this.$container.velocity(this.matrix.getHiddenBlockCss(this.$container),"fast",t.proxy((function(){this.$container.remove(),this.matrix.updateAddBlockBtn(),window.draftEditor&&window.draftEditor.resume()}),this)),this.matrix.trigger("blockDeleted",{$block:this.$container})}})}(jQuery);
//# sourceMappingURL=MatrixInput.min.js.map
