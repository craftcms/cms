!function($){var Base=function(){},cancel,raf,erd;if(Base.extend=function(_instance,_static){var extend=Base.prototype.extend;Base._prototyping=!0;var proto=new this;extend.call(proto,_instance),proto.base=function(){},delete Base._prototyping;var constructor=proto.constructor,klass=proto.constructor=function(){if(!Base._prototyping)if(this._constructing||this.constructor==klass)this._constructing=!0,constructor.apply(this,arguments),delete this._constructing;else if(null!=arguments[0])return(arguments[0].extend||extend).call(arguments[0],proto)};return klass.ancestor=this,klass.extend=this.extend,klass.forEach=this.forEach,klass.implement=this.implement,klass.prototype=proto,klass.toString=this.toString,klass.valueOf=function(type){return"object"==type?klass:constructor.valueOf()},extend.call(klass,_static),"function"==typeof klass.init&&klass.init(),klass},Base.prototype={extend:function(source,value){if(arguments.length>1){var ancestor=this[source];if(ancestor&&"function"==typeof value&&(!ancestor.valueOf||ancestor.valueOf()!=value.valueOf())&&/\bbase\b/.test(value)){var method=value.valueOf();value=function(){var previous=this.base||Base.prototype.base;this.base=ancestor;var returnValue=method.apply(this,arguments);return this.base=previous,returnValue},value.valueOf=function(type){return"object"==type?value:method},value.toString=Base.toString}this[source]=value}else if(source){var extend=Base.prototype.extend;Base._prototyping||"function"==typeof this||(extend=this.extend||extend);for(var proto={toSource:null},hidden=["constructor","toString","valueOf"],i=Base._prototyping?0:1;key=hidden[i++];)source[key]!=proto[key]&&extend.call(this,key,source[key]);for(var key in source)if(!proto[key]){var desc=Object.getOwnPropertyDescriptor(source,key);void 0!==desc.value?extend.call(this,key,desc.value):Object.defineProperty(this,key,desc)}}return this}},Base=Base.extend({constructor:function(){this.extend(arguments[0])}},{ancestor:Object,version:"1.1",forEach:function(object,block,context){for(var key in object)void 0===this.prototype[key]&&block.call(context,object[key],key,object)},implement:function(){for(var i=0;i<arguments.length;i++)"function"==typeof arguments[i]?arguments[i](this.prototype):this.prototype.extend(arguments[i]);return this},toString:function(){return String(this.valueOf())}}),"undefined"!=typeof Garnish)throw"Garnish is already defined!";function getErd(){return void 0===erd&&(erd=elementResizeDetectorMaker({callOnAdd:!1})),erd}function triggerResizeEvent(elem){$(elem).trigger("resize")}Garnish={$win:$(window),$doc:$(document),$bod:$(document.body)},Garnish.rtl=Garnish.$bod.hasClass("rtl"),Garnish.ltr=!Garnish.rtl,Garnish=$.extend(Garnish,{$scrollContainer:Garnish.$win,DELETE_KEY:8,SHIFT_KEY:16,CTRL_KEY:17,ALT_KEY:18,RETURN_KEY:13,ESC_KEY:27,SPACE_KEY:32,LEFT_KEY:37,UP_KEY:38,RIGHT_KEY:39,DOWN_KEY:40,A_KEY:65,S_KEY:83,CMD_KEY:91,PRIMARY_CLICK:1,SECONDARY_CLICK:3,X_AXIS:"x",Y_AXIS:"y",FX_DURATION:100,TEXT_NODE:3,log:function(msg){"undefined"!=typeof console&&"function"==typeof console.log&&console.log(msg)},_isMobileBrowser:null,_isMobileOrTabletBrowser:null,isMobileBrowser:function(detectTablets){var key=detectTablets?"_isMobileOrTabletBrowser":"_isMobileBrowser";if(null===Garnish[key]){var a=navigator.userAgent||navigator.vendor||window.opera;Garnish[key]=new RegExp("(android|bbd+|meego).+mobile|avantgo|bada/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)/|plucker|pocket|psp|series(4|6)0|symbian|treo|up.(browser|link)|vodafone|wap|windows ce|xda|xiino"+(detectTablets?"|android|ipad|playbook|silk":""),"i").test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))}return Garnish[key]},isArray:function(val){return val instanceof Array},isJquery:function(val){return val instanceof jQuery},isString:function(val){return"string"==typeof val},hasAttr:function(elem,attr){var val=$(elem).attr(attr);return void 0!==val&&!1!==val},isTextNode:function(elem){return elem.nodeType===Garnish.TEXT_NODE},getOffset:function(elem){return this.getOffset._offset=$(elem).offset(),Garnish.$scrollContainer[0]!==Garnish.$win[0]&&(this.getOffset._offset.top+=Garnish.$scrollContainer.scrollTop(),this.getOffset._offset.left+=Garnish.$scrollContainer.scrollLeft()),this.getOffset._offset},getDist:function(x1,y1,x2,y2){return Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2))},hitTest:function(x,y,elem){return Garnish.hitTest._$elem=$(elem),Garnish.hitTest._offset=Garnish.hitTest._$elem.offset(),Garnish.hitTest._x1=Garnish.hitTest._offset.left,Garnish.hitTest._y1=Garnish.hitTest._offset.top,Garnish.hitTest._x2=Garnish.hitTest._x1+Garnish.hitTest._$elem.outerWidth(),Garnish.hitTest._y2=Garnish.hitTest._y1+Garnish.hitTest._$elem.outerHeight(),x>=Garnish.hitTest._x1&&x<Garnish.hitTest._x2&&y>=Garnish.hitTest._y1&&y<Garnish.hitTest._y2},isCursorOver:function(ev,elem){return Garnish.hitTest(ev.pageX,ev.pageY,elem)},copyTextStyles:function(source,target){var $source=$(source),$target;$(target).css({fontFamily:$source.css("fontFamily"),fontSize:$source.css("fontSize"),fontWeight:$source.css("fontWeight"),letterSpacing:$source.css("letterSpacing"),lineHeight:$source.css("lineHeight"),textAlign:$source.css("textAlign"),textIndent:$source.css("textIndent"),whiteSpace:$source.css("whiteSpace"),wordSpacing:$source.css("wordSpacing"),wordWrap:$source.css("wordWrap")})},getBodyScrollTop:function(){return Garnish.getBodyScrollTop._scrollTop=document.body.scrollTop,Garnish.getBodyScrollTop._scrollTop<0?Garnish.getBodyScrollTop._scrollTop=0:(Garnish.getBodyScrollTop._maxScrollTop=Garnish.$bod.outerHeight()-Garnish.$win.height(),Garnish.getBodyScrollTop._scrollTop>Garnish.getBodyScrollTop._maxScrollTop&&(Garnish.getBodyScrollTop._scrollTop=Garnish.getBodyScrollTop._maxScrollTop)),Garnish.getBodyScrollTop._scrollTop},requestAnimationFrame:(raf=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(fn){return window.setTimeout(fn,20)},function(fn){return raf(fn)}),cancelAnimationFrame:(cancel=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.clearTimeout,function(id){return cancel(id)}),scrollContainerToElement:function(container,elem){var $elem;if(void 0===elem)$container=($elem=$(container)).scrollParent();else{var $container=$(container);$elem=$(elem)}"HTML"!==$container.prop("nodeName")&&$container[0]!==Garnish.$doc[0]||($container=Garnish.$win);var scrollTop=$container.scrollTop(),elemOffset=$elem.offset().top,elemScrollOffset,targetScrollTop=!1;if((elemScrollOffset=$container[0]===window?elemOffset-scrollTop:elemOffset-$container.offset().top)<0)targetScrollTop=scrollTop+elemScrollOffset-10;else{var elemHeight=$elem.outerHeight(),containerHeight=$container[0]===window?window.innerHeight:$container[0].clientHeight;elemScrollOffset+elemHeight>containerHeight&&(targetScrollTop=scrollTop+(elemScrollOffset-(containerHeight-elemHeight))+10)}!1!==targetScrollTop&&($container[0]===window?$("html").velocity("scroll",{offset:targetScrollTop+"px",mobileHA:!1}):$container.scrollTop(targetScrollTop))},SHAKE_STEPS:10,SHAKE_STEP_DURATION:25,shake:function(elem,prop){var $elem=$(elem);prop||(prop="margin-left");var startingPoint=parseInt($elem.css(prop));isNaN(startingPoint)&&(startingPoint=0);for(var i=0;i<=Garnish.SHAKE_STEPS;i++)!function(i){setTimeout((function(){Garnish.shake._properties={},Garnish.shake._properties[prop]=startingPoint+(i%2?-1:1)*(10-i),$elem.velocity(Garnish.shake._properties,Garnish.SHAKE_STEP_DURATION)}),Garnish.SHAKE_STEP_DURATION*i)}(i)},getElement:function(elem){return $.makeArray(elem)[0]},getInputBasename:function(elem){var name=$(elem).attr("name");return name?name.replace(/\[.*/,""):null},getInputPostVal:function($input){var type=$input.attr("type"),val=$input.val();return"checkbox"===type||"radio"===type?$input.prop("checked")?val:null:Garnish.isArray(val)&&"[]"!==$input.attr("name").substr(-2)?val.length?val[val.length-1]:null:val},findInputs:function(container){return $(container).find("input,text,textarea,select,button")},getPostData:function(container){for(var postData={},arrayInputCounters={},$inputs=Garnish.findInputs(container),inputName,i=0;i<$inputs.length;i++){var $input=$inputs.eq(i);if(!$input.prop("disabled")&&(inputName=$input.attr("name"))){var inputVal=Garnish.getInputPostVal($input);if(null!==inputVal){var isArrayInput="[]"===inputName.substr(-2);if(isArrayInput){var croppedName=inputName.substring(0,inputName.length-2);void 0===arrayInputCounters[croppedName]&&(arrayInputCounters[croppedName]=0)}Garnish.isArray(inputVal)||(inputVal=[inputVal]);for(var j=0;j<inputVal.length;j++)isArrayInput&&(inputName=croppedName+"["+arrayInputCounters[croppedName]+"]",arrayInputCounters[croppedName]++),postData[inputName]=inputVal[j]}}}return postData},copyInputValues:function(source,target){for(var $sourceInputs=Garnish.findInputs(source),$targetInputs=Garnish.findInputs(target),i=0;i<$sourceInputs.length&&void 0!==$targetInputs[i];i++)$targetInputs.eq(i).val($sourceInputs.eq(i).val())},isCtrlKeyPressed:function(ev){return window.navigator.platform.match(/Mac/)?ev.metaKey:ev.ctrlKey},_eventHandlers:[],_normalizeEvents:function(events){"string"==typeof events&&(events=events.split(" "));for(var i=0;i<events.length;i++)"string"==typeof events[i]&&(events[i]=events[i].split("."));return events},on:function(target,events,data,handler){"function"==typeof data&&(handler=data,data={}),events=this._normalizeEvents(events);for(var i=0;i<events.length;i++){var ev=events[i];this._eventHandlers.push({target:target,type:ev[0],namespace:ev[1],data:data,handler:handler})}},off:function(target,events,handler){events=this._normalizeEvents(events);for(var i=0;i<events.length;i++)for(var ev=events[i],j=this._eventHandlers.length-1;j>=0;j--){var eventHandler=this._eventHandlers[j];eventHandler.target!==target||eventHandler.type!==ev[0]||ev[1]&&eventHandler.namespace!==ev[1]||eventHandler.handler!==handler||this._eventHandlers.splice(j,1)}}}),Garnish.Base=Base.extend({settings:null,_eventHandlers:null,_namespace:null,_$listeners:null,_disabled:!1,constructor:function(){this._eventHandlers=[],this._namespace=".Garnish"+Math.floor(1e9*Math.random()),this._listeners=[],this.init.apply(this,arguments)},init:$.noop,setSettings:function(settings,defaults){var baseSettings=void 0===this.settings?{}:this.settings;this.settings=$.extend({},baseSettings,defaults,settings)},on:function(events,data,handler){"function"==typeof data&&(handler=data,data={}),events=Garnish._normalizeEvents(events);for(var i=0;i<events.length;i++){var ev=events[i];this._eventHandlers.push({type:ev[0],namespace:ev[1],data:data,handler:handler})}},off:function(events,handler){events=Garnish._normalizeEvents(events);for(var i=0;i<events.length;i++)for(var ev=events[i],j=this._eventHandlers.length-1;j>=0;j--){var eventHandler=this._eventHandlers[j];eventHandler.type!==ev[0]||ev[1]&&eventHandler.namespace!==ev[1]||eventHandler.handler!==handler||this._eventHandlers.splice(j,1)}},trigger:function(type,data){var ev={type:type,target:this},i,handler,_ev;for(i=0;i<this._eventHandlers.length;i++)(handler=this._eventHandlers[i]).type===type&&(_ev=$.extend({data:handler.data},data,ev),handler.handler(_ev));for(i=0;i<Garnish._eventHandlers.length;i++)this instanceof(handler=Garnish._eventHandlers[i]).target&&handler.type===type&&(_ev=$.extend({data:handler.data},data,ev),handler.handler(_ev))},_splitEvents:function(events){if("string"==typeof events){events=events.split(",");for(var i=0;i<events.length;i++)events[i]=$.trim(events[i])}return events},_formatEvents:function(events){events=this._splitEvents(events).slice(0);for(var i=0;i<events.length;i++)events[i]+=this._namespace;return events.join(" ")},addListener:function(elem,events,data,func){var $elem=$(elem);$elem.length&&(events=this._splitEvents(events),void 0===func&&"object"!=typeof data&&(func=data,data={}),func="function"==typeof func?func.bind(this):this[func].bind(this),$elem.on(this._formatEvents(events),data,$.proxy((function(){if(!this._disabled)return func.apply(this,arguments)}),this)),-1===$.inArray(elem,this._listeners)&&this._listeners.push(elem))},removeListener:function(elem,events){$(elem).off(this._formatEvents(events))},removeAllListeners:function(elem){$(elem).off(this._namespace)},disable:function(){this._disabled=!0},enable:function(){this._disabled=!1},destroy:function(){this.trigger("destroy"),this.removeAllListeners(this._listeners)}}),$.extend(jQuery.event.special,{activate:{setup:function(data,namespaces,eventHandle){var activateNamespace=this._namespace+"-activate",$elem=$(this);$elem.on({"mousedown.garnish-activate":function(e){e.preventDefault()},"click.garnish-activate":function(e){e.preventDefault(),$elem.hasClass("disabled")||$elem.trigger("activate")},"keydown.garnish-activate":function(e){this===$elem[0]&&e.keyCode===Garnish.SPACE_KEY&&(e.preventDefault(),$elem.hasClass("disabled")||($elem.addClass("active"),Garnish.$doc.on("keyup.garnish-activate",(function(e){$elem.removeClass("active"),e.keyCode===Garnish.SPACE_KEY&&(e.preventDefault(),$elem.trigger("activate")),Garnish.$doc.off("keyup.garnish-activate")}))))}}),$elem.hasClass("disabled")?$elem.removeAttr("tabindex"):$elem.attr("tabindex","0")},teardown:function(){$(this).off(".garnish-activate")}},textchange:{setup:function(data,namespaces,eventHandle){var $elem=$(this);$elem.data("garnish-textchange-value",$elem.val()),$elem.on("keypress.garnish-textchange keyup.garnish-textchange change.garnish-textchange blur.garnish-textchange",(function(e){var val=$elem.val();val!==$elem.data("garnish-textchange-value")&&($elem.data("garnish-textchange-value",val),$elem.trigger("textchange"))}))},teardown:function(){$(this).off(".garnish-textchange")},handle:function(ev,data){var el=this,args=arguments,delay=data&&void 0!==data.delay?data.delay:ev.data&&void 0!==ev.data.delay?ev.data.delay:null,handleObj=ev.handleObj,targetData=$.data(ev.target);if(!delay)return handleObj.handler.apply(el,args);targetData.delayTimeout&&clearTimeout(targetData.delayTimeout),targetData.delayTimeout=setTimeout((function(){handleObj.handler.apply(el,args)}),delay)}},resize:{setup:function(data,namespaces,eventHandle){if(this===window)return!1;$("> :last-child",this).addClass("last"),getErd().listenTo(this,triggerResizeEvent)},teardown:function(){if(this===window)return!1;getErd().removeListener(this,triggerResizeEvent)}}}),jQuery.each(["activate","textchange","resize"],(function(i,name){jQuery.fn[name]=function(data,fn){return arguments.length>0?this.on(name,null,data,fn):this.trigger(name)}})),Garnish.BaseDrag=Garnish.Base.extend({$items:null,dragging:!1,mousedownX:null,mousedownY:null,realMouseX:null,realMouseY:null,mouseX:null,mouseY:null,mouseDistX:null,mouseDistY:null,mouseOffsetX:null,mouseOffsetY:null,$targetItem:null,scrollProperty:null,scrollAxis:null,scrollDist:null,scrollProxy:null,scrollFrame:null,_:null,init:function(items,settings){void 0===settings&&$.isPlainObject(items)&&(settings=items,items=null),this.settings=$.extend({},Garnish.BaseDrag.defaults,settings),this.$items=$(),this._={},items&&this.addItems(items)},allowDragging:function(){return!0},startDragging:function(){this.dragging=!0,this.onDragStart()},drag:function(didMouseMove){didMouseMove&&(this.drag._scrollProperty=null,this.settings.axis!==Garnish.X_AXIS&&(this.drag._winScrollTop=Garnish.$win.scrollTop(),this.drag._minMouseScrollY=this.drag._winScrollTop+Garnish.BaseDrag.windowScrollTargetSize,this.mouseY<this.drag._minMouseScrollY?(this.drag._scrollProperty="scrollTop",this.drag._scrollAxis="Y",this.drag._scrollDist=Math.round((this.mouseY-this.drag._minMouseScrollY)/2)):(this.drag._maxMouseScrollY=this.drag._winScrollTop+Garnish.$win.height()-Garnish.BaseDrag.windowScrollTargetSize,this.mouseY>this.drag._maxMouseScrollY&&(this.drag._scrollProperty="scrollTop",this.drag._scrollAxis="Y",this.drag._scrollDist=Math.round((this.mouseY-this.drag._maxMouseScrollY)/2)))),this.drag._scrollProperty||this.settings.axis===Garnish.Y_AXIS||(this.drag._winScrollLeft=Garnish.$win.scrollLeft(),this.drag._minMouseScrollX=this.drag._winScrollLeft+Garnish.BaseDrag.windowScrollTargetSize,this.mouseX<this.drag._minMouseScrollX?(this.drag._scrollProperty="scrollLeft",this.drag._scrollAxis="X",this.drag._scrollDist=Math.round((this.mouseX-this.drag._minMouseScrollX)/2)):(this.drag._maxMouseScrollX=this.drag._winScrollLeft+Garnish.$win.width()-Garnish.BaseDrag.windowScrollTargetSize,this.mouseX>this.drag._maxMouseScrollX&&(this.drag._scrollProperty="scrollLeft",this.drag._scrollAxis="X",this.drag._scrollDist=Math.round((this.mouseX-this.drag._maxMouseScrollX)/2)))),this.drag._scrollProperty?(this.scrollProperty||(this.scrollProxy||(this.scrollProxy=this._scrollWindow.bind(this)),this.scrollFrame&&(Garnish.cancelAnimationFrame(this.scrollFrame),this.scrollFrame=null),this.scrollFrame=Garnish.requestAnimationFrame(this.scrollProxy)),this.scrollProperty=this.drag._scrollProperty,this.scrollAxis=this.drag._scrollAxis,this.scrollDist=this.drag._scrollDist):this._cancelWindowScroll()),this.onDrag()},stopDragging:function(){this.dragging=!1,this.onDragStop(),this._cancelWindowScroll()},addItems:function(items){items=$.makeArray(items);for(var i=0;i<items.length;i++){var item=items[i];$.data(item,"drag")&&(Garnish.log("Element was added to more than one dragger"),$.data(item,"drag").removeItems(item)),$.data(item,"drag",this),this.addListener(item,"mousedown","_handleMouseDown")}this.$items=this.$items.add(items)},removeItems:function(items){items=$.makeArray(items);for(var i=0;i<items.length;i++){var item=items[i],index=$.inArray(item,this.$items);-1!==index&&(this._deinitItem(item),this.$items.splice(index,1))}},removeAllItems:function(){for(var i=0;i<this.$items.length;i++)this._deinitItem(this.$items[i]);this.$items=$()},destroy:function(){this.removeAllItems(),this.base()},onDragStart:function(){Garnish.requestAnimationFrame(function(){this.trigger("dragStart"),this.settings.onDragStart()}.bind(this))},onDrag:function(){Garnish.requestAnimationFrame(function(){this.trigger("drag"),this.settings.onDrag()}.bind(this))},onDragStop:function(){Garnish.requestAnimationFrame(function(){this.trigger("dragStop"),this.settings.onDragStop()}.bind(this))},_handleMouseDown:function(ev){if(ev.which===Garnish.PRIMARY_CLICK&&!this.$targetItem){var $target=$(ev.target),$handle=this._getItemHandle(ev.currentTarget);if(($target.is($handle)||$target.closest($handle).length)&&(ev.currentTarget===ev.target||!this.settings.ignoreHandleSelector||!$target.is(this.settings.ignoreHandleSelector)&&!$target.closest(this.settings.ignoreHandleSelector).length)&&(ev.preventDefault(),this.allowDragging())){this.$targetItem=$(ev.currentTarget),this.mousedownX=this.mouseX=ev.pageX,this.mousedownY=this.mouseY=ev.pageY;var offset=this.$targetItem.offset();this.mouseOffsetX=ev.pageX-offset.left,this.mouseOffsetY=ev.pageY-offset.top,this.addListener(Garnish.$doc,"mousemove","_handleMouseMove"),this.addListener(Garnish.$doc,"mouseup","_handleMouseUp")}}},_getItemHandle:function(item){if(this.settings.handle){if("object"==typeof this.settings.handle)return $(this.settings.handle);if("string"==typeof this.settings.handle)return $(this.settings.handle,item);if("function"==typeof this.settings.handle)return $(this.settings.handle(item))}return $(item)},_handleMouseMove:function(ev){ev.preventDefault(),this.realMouseX=ev.pageX,this.realMouseY=ev.pageY,this.settings.axis!==Garnish.Y_AXIS&&(this.mouseX=ev.pageX),this.settings.axis!==Garnish.X_AXIS&&(this.mouseY=ev.pageY),this.mouseDistX=this.mouseX-this.mousedownX,this.mouseDistY=this.mouseY-this.mousedownY,this.dragging||(this._handleMouseMove._mouseDist=Garnish.getDist(this.mousedownX,this.mousedownY,this.realMouseX,this.realMouseY),this._handleMouseMove._mouseDist>=Garnish.BaseDrag.minMouseDist&&this.startDragging()),this.dragging&&this.drag(!0)},_handleMouseUp:function(ev){this.removeAllListeners(Garnish.$doc),this.dragging&&this.stopDragging(),this.$targetItem=null},_scrollWindow:function(){this._.scrollPos=Garnish.$scrollContainer[this.scrollProperty](),Garnish.$scrollContainer[this.scrollProperty](this._.scrollPos+this.scrollDist),this["mouse"+this.scrollAxis]-=this._.scrollPos-Garnish.$scrollContainer[this.scrollProperty](),this["realMouse"+this.scrollAxis]=this["mouse"+this.scrollAxis],this.drag(),this.scrollFrame=Garnish.requestAnimationFrame(this.scrollProxy)},_cancelWindowScroll:function(){this.scrollFrame&&(Garnish.cancelAnimationFrame(this.scrollFrame),this.scrollFrame=null),this.scrollProperty=null,this.scrollAxis=null,this.scrollDist=null},_deinitItem:function(item){this.removeAllListeners(item),$.removeData(item,"drag")}},{minMouseDist:1,windowScrollTargetSize:25,defaults:{handle:null,axis:null,ignoreHandleSelector:"input, textarea, button, select, .btn",onDragStart:$.noop,onDrag:$.noop,onDragStop:$.noop}}),Garnish.CheckboxSelect=Garnish.Base.extend({$container:null,$all:null,$options:null,init:function(container){this.$container=$(container),this.$container.data("checkboxSelect")&&(Garnish.log("Double-instantiating a checkbox select on an element"),this.$container.data("checkbox-select").destroy()),this.$container.data("checkboxSelect",this);var $checkboxes=this.$container.find("input");this.$all=$checkboxes.filter(".all:first"),this.$options=$checkboxes.not(this.$all),this.addListener(this.$all,"change","onAllChange")},onAllChange:function(){var isAllChecked=this.$all.prop("checked");this.$options.prop({checked:isAllChecked,disabled:isAllChecked})},destroy:function(){this.$container.removeData("checkboxSelect"),this.base()}}),Garnish.ContextMenu=Garnish.Base.extend({$target:null,options:null,$menu:null,showingMenu:!1,init:function(target,options,settings){this.$target=$(target),this.$target.data("contextmenu")&&(Garnish.log("Double-instantiating a context menu on an element"),this.$target.data("contextmenu").destroy()),this.$target.data("contextmenu",this),this.options=options,this.setSettings(settings,Garnish.ContextMenu.defaults),Garnish.ContextMenu.counter++,this.enable()},buildMenu:function(){this.$menu=$('<div class="'+this.settings.menuClass+'" style="display: none" />');var $ul=$("<ul/>").appendTo(this.$menu);for(var i in this.options)if(this.options.hasOwnProperty(i)){var option=this.options[i];if("-"===option)$("<hr/>").appendTo(this.$menu),$ul=$("<ul/>").appendTo(this.$menu);else{var $li=$("<li></li>").appendTo($ul),$a=$("<a>"+option.label+"</a>").appendTo($li);"function"==typeof option.onClick&&function($a,onClick){setTimeout(function(){$a.mousedown(function(ev){this.hideMenu(),onClick.call(this.currentTarget,$.extend(ev,{currentTarget:this.currentTarget}))}.bind(this))}.bind(this),1)}.call(this,$a,option.onClick)}}},showMenu:function(ev){"mousedown"===ev.type&&ev.which!==Garnish.SECONDARY_CLICK||("contextmenu"===ev.type&&ev.preventDefault(),this.showing&&ev.currentTarget===this.currentTarget||(this.currentTarget=ev.currentTarget,this.$menu||this.buildMenu(),this.$menu.appendTo(document.body),this.$menu.show(),this.$menu.css({left:ev.pageX+1,top:ev.pageY-4}),this.showing=!0,setTimeout(function(){this.addListener(Garnish.$doc,"mousedown","hideMenu")}.bind(this),0)))},hideMenu:function(){this.removeListener(Garnish.$doc,"mousedown"),this.$menu.hide(),this.showing=!1},enable:function(){this.addListener(this.$target,"contextmenu,mousedown","showMenu")},disable:function(){this.removeListener(this.$target,"contextmenu,mousedown")},destroy:function(){this.$target.removeData("contextmenu"),this.base()}},{defaults:{menuClass:"menu"},counter:0}),Garnish.CustomSelect=Garnish.Base.extend({settings:null,visible:!1,$container:null,$options:null,$anchor:null,menuId:null,_windowWidth:null,_windowHeight:null,_windowScrollLeft:null,_windowScrollTop:null,_anchorOffset:null,_anchorWidth:null,_anchorHeight:null,_anchorOffsetRight:null,_anchorOffsetBottom:null,_menuWidth:null,_menuHeight:null,init:function(container,settings){this.setSettings(settings,Garnish.CustomSelect.defaults),this.$container=$(container),this.$options=$(),this.addOptions(this.$container.find("a")),this.menuId="menu"+this._namespace,this.$menuList=$("ul",this.$container),this.$menuList.attr({role:"listbox",id:this.menuId,"aria-hidden":"true"}),this.settings.attachToElement&&(this.settings.anchor=this.settings.attachToElement,Garnish.log("The 'attachToElement' setting is deprecated. Use 'anchor' instead.")),this.settings.anchor&&(this.$anchor=$(this.settings.anchor)),this.addListener(this.$container,"mousedown",(function(ev){ev.stopPropagation(),"INPUT"!==ev.target.nodeName&&ev.preventDefault()}))},addOptions:function($options){this.$options=this.$options.add($options),$options.data("menu",this),$options.each(function(optionKey,option){$(option).attr({role:"option",tabindex:"-1",id:this.menuId+"-option-"+optionKey})}.bind(this)),this.removeAllListeners($options),this.addListener($options,"click",(function(ev){this.selectOption(ev.currentTarget)}))},setPositionRelativeToAnchor:function(){this._windowWidth=Garnish.$win.width(),this._windowHeight=Garnish.$win.height(),this._windowScrollLeft=Garnish.$win.scrollLeft(),this._windowScrollTop=Garnish.$win.scrollTop(),this._anchorOffset=this.$anchor.offset(),this._anchorWidth=this.$anchor.outerWidth(),this._anchorHeight=this.$anchor.outerHeight(),this._anchorOffsetRight=this._anchorOffset.left+this._anchorHeight,this._anchorOffsetBottom=this._anchorOffset.top+this._anchorHeight,this.$container.css("minWidth",0),this.$container.css("minWidth",this._anchorWidth-(this.$container.outerWidth()-this.$container.width())),this._menuWidth=this.$container.outerWidth(),this._menuHeight=this.$container.outerHeight();var topClearance=this._anchorOffset.top-this._windowScrollTop,bottomClearance=this._windowHeight+this._windowScrollTop-this._anchorOffsetBottom;bottomClearance>=this._menuHeight||topClearance<this._menuHeight&&bottomClearance>=topClearance?this.$container.css({top:this._anchorOffsetBottom,maxHeight:bottomClearance-this.settings.windowSpacing}):this.$container.css({top:this._anchorOffset.top-Math.min(this._menuHeight,topClearance-this.settings.windowSpacing),maxHeight:topClearance-this.settings.windowSpacing});var align=this.$container.data("align");if("left"!==align&&"center"!==align&&"right"!==align&&(align="left"),"center"===align)this._alignCenter();else{var rightClearance=this._windowWidth+this._windowScrollLeft-(this._anchorOffset.left+this._menuWidth),leftClearance=this._anchorOffsetRight-this._menuWidth;"right"===align&&leftClearance>=0||rightClearance<0?this._alignRight():this._alignLeft()}delete this._windowWidth,delete this._windowHeight,delete this._windowScrollLeft,delete this._windowScrollTop,delete this._anchorOffset,delete this._anchorWidth,delete this._anchorHeight,delete this._anchorOffsetRight,delete this._anchorOffsetBottom,delete this._menuWidth,delete this._menuHeight},show:function(){this.visible||(this.$container.appendTo(Garnish.$bod),this.$anchor&&this.setPositionRelativeToAnchor(),this.$container.velocity("stop"),this.$container.css({opacity:1,display:"block"}),this.$menuList.attr("aria-hidden","false"),Garnish.shortcutManager.addLayer().registerShortcut(Garnish.ESC_KEY,this.hide.bind(this)),this.addListener(Garnish.$scrollContainer,"scroll","setPositionRelativeToAnchor"),this.visible=!0,this.trigger("show"))},hide:function(){this.visible&&(this.$menuList.attr("aria-hidden","true"),this.$container.velocity("fadeOut",{duration:Garnish.FX_DURATION},function(){this.$container.detach()}.bind(this)),Garnish.shortcutManager.removeLayer(),this.removeListener(Garnish.$scrollContainer,"scroll"),this.visible=!1,this.trigger("hide"))},selectOption:function(option){this.settings.onOptionSelect(option),this.trigger("optionselect",{selectedOption:option}),this.hide()},_alignLeft:function(){this.$container.css({left:this._anchorOffset.left,right:"auto"})},_alignRight:function(){this.$container.css({right:this._windowWidth-(this._anchorOffset.left+this._anchorWidth),left:"auto"})},_alignCenter:function(){var left=Math.round(this._anchorOffset.left+this._anchorWidth/2-this._menuWidth/2);left<0&&(left=0),this.$container.css("left",left)}},{defaults:{anchor:null,windowSpacing:5,onOptionSelect:$.noop}}),Garnish.Menu=Garnish.CustomSelect,Garnish.DisclosureMenu=Garnish.Base.extend({settings:null,$trigger:null,$container:null,$alignmentElement:null,$wrapper:null,_windowWidth:null,_windowHeight:null,_windowScrollLeft:null,_windowScrollTop:null,_wrapperElementOffset:null,_alignmentElementOffset:null,_triggerWidth:null,_triggerHeight:null,_menuWidth:null,_menuHeight:null,init:function(trigger,settings){this.setSettings(settings,Garnish.DisclosureMenu.defaults),this.$trigger=$(trigger);var triggerId=this.$trigger.attr("aria-controls");if(this.$container=$("#"+triggerId),this.$container){var expanded;this.$trigger.attr("aria-expanded")||this.$trigger.attr("aria-expanded","false");var alignmentSelector=this.$container.data("align-to");this.$alignmentElement=alignmentSelector?$(alignmentSelector):this.$trigger;var wrapper=this.$container.closest("[data-wrapper]");wrapper&&(this.$wrapper=wrapper),this.addDisclosureMenuEventListeners()}},addDisclosureMenuEventListeners:function(){this.addListener(this.$trigger,"click",(function(){this.handleTriggerClick()})),this.addListener(this.$container,"keydown",(function(event){this.handleKeypress(event)})),this.addListener(Garnish.$doc,"mousedown",this.handleMousedown)},focusElement:function(direction){var currentFocus=$(":focus"),focusable=this.$container.find(":focusable"),currentIndex=focusable.index(currentFocus),newIndex,elementToFocus;(newIndex="prev"===direction?currentIndex-1:currentIndex+1)>=0&&newIndex<focusable.length&&focusable[newIndex].focus()},handleMousedown:function(event){var newTarget=event.target,triggerButton=$(newTarget).closest("[data-disclosure-trigger]"),newTargetIsInsideDisclosure=this.$container.has(newTarget).length>0;$(triggerButton).is(this.$trigger)||newTargetIsInsideDisclosure||this.hide()},handleKeypress:function(event){var keyCode;switch(event.keyCode){case Garnish.ESC_KEY:this.hide(),this.$trigger.focus();break;case Garnish.RIGHT_KEY:case Garnish.DOWN_KEY:event.preventDefault(),this.focusElement("next");break;case Garnish.LEFT_KEY:case Garnish.UP_KEY:event.preventDefault(),this.focusElement("prev")}},isExpanded:function(){var isExpanded;return"true"===this.$trigger.attr("aria-expanded")},handleTriggerClick:function(){this.isExpanded()?this.hide():this.show()},show:function(){if(!this.isExpanded()){this.setContainerPosition(),this.addListener(Garnish.$scrollContainer,"scroll","setContainerPosition"),this.$container.velocity("stop"),this.$container.css({opacity:1,display:"block"}),this.$trigger.attr("aria-expanded","true");var firstFocusableEl=this.$container.find(":focusable")[0];firstFocusableEl?firstFocusableEl.focus():(this.$container.attr("tabindex","-1"),this.$container.focus())}},hide:function(){this.isExpanded()&&(this.$container.velocity("fadeOut",{duration:Garnish.FX_DURATION}),this.$trigger.attr("aria-expanded","false"))},setContainerPosition:function(){this._windowWidth=Garnish.$win.width(),this._windowHeight=Garnish.$win.height(),this._windowScrollLeft=Garnish.$win.scrollLeft(),this._windowScrollTop=Garnish.$win.scrollTop(),this._alignmentElementOffset=this.$alignmentElement[0].getBoundingClientRect(),this._wrapperElementOffset=this.$wrapper[0].getBoundingClientRect(),this._triggerWidth=this.$trigger.outerWidth(),this.$container.css("minWidth",0),this.$container.css("minWidth",this._triggerWidth-(this.$container.outerWidth()-this.$container.width())),this._menuWidth=this.$container.outerWidth(),this._menuHeight=this.$container.outerHeight();var topClearance=this._alignmentElementOffset.top,bottomClearance=this._windowHeight-this._alignmentElementOffset.bottom,topAdjustment=this._alignmentElementOffset.top-this._wrapperElementOffset.top,bottomAdjustment=this._alignmentElementOffset.bottom-this._wrapperElementOffset.bottom,bottomClearanceExists;bottomClearance>=this._menuHeight||topClearance<this._menuHeight&&bottomClearance>=topClearance?this.$container.css({top:"calc(100% + "+bottomAdjustment+"px)",bottom:"unset",maxHeight:bottomClearance-this.settings.windowSpacing}):this.$container.css({bottom:"calc(100% - "+topAdjustment+"px)",top:"unset",maxHeight:topClearance-this.settings.windowSpacing});var align=this.$container.data("align");if("left"!==align&&"center"!==align&&"right"!==align&&(align="left"),"center"===align)this._alignCenter();else{var rightClearance=this._windowWidth+this._windowScrollLeft-(this._alignmentElementOffset.left+this._menuWidth),leftClearance=this._alignmentElementOffset.right-this._menuWidth;"right"===align&&leftClearance>=0||rightClearance<0?this._alignRight():this._alignLeft()}delete this._windowWidth,delete this._windowHeight,delete this._windowScrollLeft,delete this._windowScrollTop,delete this._wrapperElementOffset,delete this._alignmentElementOffset,delete this._triggerWidth,delete this._triggerHeight,delete this._menuWidth,delete this._menuHeight},_alignLeft:function(){var leftAdjustment=this._alignmentElementOffset.left-this._wrapperElementOffset.left;this.$container.css({right:"unset",left:leftAdjustment+"px"})},_alignRight:function(){var rightAdjustment=this._alignmentElementOffset.right-this._wrapperElementOffset.right;this.$container.css({left:"unset",right:-rightAdjustment+"px"})},_alignCenter:function(){var left=Math.round(this._triggerWidth/2-this._menuWidth/2),leftAdjustment=this._alignmentElementOffset.left-this._wrapperElementOffset.left;this.$container.css("left",left-leftAdjustment)}},{defaults:{windowSpacing:5}}),Garnish.Drag=Garnish.BaseDrag.extend({targetItemWidth:null,targetItemHeight:null,targetItemPositionInDraggee:null,$draggee:null,otherItems:null,totalOtherItems:null,helpers:null,helperTargets:null,helperPositions:null,helperLagIncrement:null,updateHelperPosProxy:null,updateHelperPosFrame:null,lastMouseX:null,lastMouseY:null,_returningHelpersToDraggees:!1,init:function(items,settings){void 0===settings&&$.isPlainObject(items)&&(settings=items,items=null),settings=$.extend({},Garnish.Drag.defaults,settings),this.base(items,settings)},allowDragging:function(){return!this._returningHelpersToDraggees},startDragging:function(){this.helpers=[],this.helperTargets=[],this.helperPositions=[],this.lastMouseX=this.lastMouseY=null,this.targetItemWidth=this.$targetItem.outerWidth(),this.targetItemHeight=this.$targetItem.outerHeight(),this.draggeeDisplay=this.$targetItem.css("display"),this.setDraggee(this.findDraggee()),this.otherItems=[];for(var i=0;i<this.$items.length;i++){var item=this.$items[i];-1===$.inArray(item,this.$draggee)&&this.otherItems.push(item)}this.totalOtherItems=this.otherItems.length,this.updateHelperPosProxy||(this.updateHelperPosProxy=this._updateHelperPos.bind(this)),this.helperLagIncrement=1===this.helpers.length?0:this.settings.helperLagIncrementDividend/(this.helpers.length-1),this.updateHelperPosFrame=Garnish.requestAnimationFrame(this.updateHelperPosProxy),this.base()},setDraggee:function($draggee){if(this.targetItemPositionInDraggee=$.inArray(this.$targetItem[0],$draggee.add(this.$targetItem[0])),this.$draggee=$([this.$targetItem[0]].concat($draggee.not(this.$targetItem).toArray())),this.settings.singleHelper)this._createHelper(0);else for(var i=0;i<this.$draggee.length;i++)this._createHelper(i);this.settings.removeDraggee?this.$draggee.hide():this.settings.collapseDraggees?(this.$targetItem.css("visibility","hidden"),this.$draggee.not(this.$targetItem).hide()):this.$draggee.css("visibility","hidden")},appendDraggee:function($newDraggee){if($newDraggee.length){if(!this.settings.collapseDraggees)var oldLength=this.$draggee.length;if(this.$draggee=$(this.$draggee.toArray().concat($newDraggee.toArray())),!this.settings.collapseDraggees)for(var newLength=this.$draggee.length,i=oldLength;i<newLength;i++)this._createHelper(i);this.settings.removeDraggee||this.settings.collapseDraggees?$newDraggee.hide():$newDraggee.css("visibility","hidden")}},drag:function(didMouseMove){this.draggeeVirtualMidpointX=this.mouseX-this.mouseOffsetX+this.targetItemWidth/2,this.draggeeVirtualMidpointY=this.mouseY-this.mouseOffsetY+this.targetItemHeight/2,this.base(didMouseMove)},stopDragging:function(){Garnish.cancelAnimationFrame(this.updateHelperPosFrame),this.base()},findDraggee:function(){switch(typeof this.settings.filter){case"function":return this.settings.filter();case"string":return this.$items.filter(this.settings.filter);default:return this.$targetItem}},getHelperTargetX:function(){return this.mouseX-this.mouseOffsetX},getHelperTargetY:function(){return this.mouseY-this.mouseOffsetY},returnHelpersToDraggees:function(){this._returningHelpersToDraggees=!0;for(var i=0;i<this.helpers.length;i++){var $draggee=this.$draggee.eq(i),$helper=this.helpers[i];$draggee.css({display:this.draggeeDisplay,visibility:"hidden"});var draggeeOffset=$draggee.offset(),callback;callback=0===i?this._showDraggee.bind(this):null,$helper.velocity({left:draggeeOffset.left,top:draggeeOffset.top},Garnish.FX_DURATION,callback)}},onReturnHelpersToDraggees:function(){Garnish.requestAnimationFrame(function(){this.trigger("returnHelpersToDraggees"),this.settings.onReturnHelpersToDraggees()}.bind(this))},_createHelper:function(i){var $draggee=this.$draggee.eq(i),$draggeeHelper=$draggee.clone().addClass("draghelper");this.settings.copyDraggeeInputValuesToHelper&&Garnish.copyInputValues($draggee,$draggeeHelper),$draggeeHelper.find("[name]").attr("name",""),$draggeeHelper.outerWidth(Math.ceil($draggee.outerWidth())).outerHeight(Math.ceil($draggee.outerHeight())).css({margin:0,"pointer-events":"none"}),this.settings.helper&&($draggeeHelper="function"==typeof this.settings.helper?this.settings.helper($draggeeHelper):$(this.settings.helper).append($draggeeHelper)),$draggeeHelper.appendTo(Garnish.$bod);var helperPos=this._getHelperTarget(i);$draggeeHelper.css({position:"absolute",top:helperPos.top,left:helperPos.left,zIndex:this.settings.helperBaseZindex+this.$draggee.length-i,opacity:this.settings.helperOpacity}),this.helperPositions[i]={top:helperPos.top,left:helperPos.left},this.helpers.push($draggeeHelper)},_updateHelperPos:function(){if(this.mouseX!==this.lastMouseX||this.mouseY!==this.lastMouseY){for(this._updateHelperPos._i=0;this._updateHelperPos._i<this.helpers.length;this._updateHelperPos._i++)this.helperTargets[this._updateHelperPos._i]=this._getHelperTarget(this._updateHelperPos._i);this.lastMouseX=this.mouseX,this.lastMouseY=this.mouseY}for(this._updateHelperPos._j=0;this._updateHelperPos._j<this.helpers.length;this._updateHelperPos._j++)this._updateHelperPos._lag=this.settings.helperLagBase+this.helperLagIncrement*this._updateHelperPos._j,this.helperPositions[this._updateHelperPos._j]={left:this.helperPositions[this._updateHelperPos._j].left+(this.helperTargets[this._updateHelperPos._j].left-this.helperPositions[this._updateHelperPos._j].left)/this._updateHelperPos._lag,top:this.helperPositions[this._updateHelperPos._j].top+(this.helperTargets[this._updateHelperPos._j].top-this.helperPositions[this._updateHelperPos._j].top)/this._updateHelperPos._lag},this.helpers[this._updateHelperPos._j].css(this.helperPositions[this._updateHelperPos._j]);this.updateHelperPosFrame=Garnish.requestAnimationFrame(this.updateHelperPosProxy)},_getHelperTarget:function(i){return{left:this.getHelperTargetX()+this.settings.helperSpacingX*i,top:this.getHelperTargetY()+this.settings.helperSpacingY*i}},_showDraggee:function(){for(var i=0;i<this.helpers.length;i++)this.helpers[i].remove();this.helpers=null,this.$draggee.show().css("visibility","inherit"),this.onReturnHelpersToDraggees(),this._returningHelpersToDraggees=!1}},{defaults:{filter:null,singleHelper:!1,collapseDraggees:!1,removeDraggee:!1,copyDraggeeInputValuesToHelper:!1,helperOpacity:1,helper:null,helperBaseZindex:1e3,helperLagBase:1,helperLagIncrementDividend:1.5,helperSpacingX:5,helperSpacingY:5,onReturnHelpersToDraggees:$.noop}}),Garnish.DragDrop=Garnish.Drag.extend({$dropTargets:null,$activeDropTarget:null,init:function(settings){settings=$.extend({},Garnish.DragDrop.defaults,settings),this.base(settings)},updateDropTargets:function(){this.settings.dropTargets&&("function"==typeof this.settings.dropTargets?this.$dropTargets=$(this.settings.dropTargets()):this.$dropTargets=$(this.settings.dropTargets),this.$dropTargets.length||(this.$dropTargets=null))},onDragStart:function(){this.updateDropTargets(),this.$activeDropTarget=null,this.base()},onDrag:function(){if(this.$dropTargets){for(this.onDrag._activeDropTarget=null,this.onDrag._i=0;this.onDrag._i<this.$dropTargets.length;this.onDrag._i++)if(this.onDrag._elem=this.$dropTargets[this.onDrag._i],Garnish.hitTest(this.mouseX,this.mouseY,this.onDrag._elem)){this.onDrag._activeDropTarget=this.onDrag._elem;break}(this.$activeDropTarget&&this.onDrag._activeDropTarget!==this.$activeDropTarget[0]||!this.$activeDropTarget&&null!==this.onDrag._activeDropTarget)&&(this.$activeDropTarget&&this.$activeDropTarget.removeClass(this.settings.activeDropTargetClass),this.onDrag._activeDropTarget?this.$activeDropTarget=$(this.onDrag._activeDropTarget).addClass(this.settings.activeDropTargetClass):this.$activeDropTarget=null,this.settings.onDropTargetChange(this.$activeDropTarget))}this.base()},onDragStop:function(){this.$dropTargets&&this.$activeDropTarget&&this.$activeDropTarget.removeClass(this.settings.activeDropTargetClass),this.base()},fadeOutHelpers:function(){for(var i=0;i<this.helpers.length;i++)!function($draggeeHelper){$draggeeHelper.velocity("fadeOut",{duration:Garnish.FX_DURATION,complete:function(){$draggeeHelper.remove()}})}(this.helpers[i])}},{defaults:{dropTargets:null,onDropTargetChange:$.noop,activeDropTargetClass:"active"}}),Garnish.DragMove=Garnish.BaseDrag.extend({onDrag:function(items,settings){this.$targetItem.css({left:this.mouseX-this.mouseOffsetX,top:this.mouseY-this.mouseOffsetY})}}),Garnish.DragSort=Garnish.Drag.extend({$heightedContainer:null,$insertion:null,insertionVisible:!1,oldDraggeeIndexes:null,newDraggeeIndexes:null,closestItem:null,_midpointVersion:0,_$prevItem:null,init:function(items,settings){void 0===settings&&$.isPlainObject(items)&&(settings=items,items=null),settings=$.extend({},Garnish.DragSort.defaults,settings),this.base(items,settings)},createInsertion:function(){if(this.settings.insertion)return"function"==typeof this.settings.insertion?$(this.settings.insertion(this.$draggee)):$(this.settings.insertion)},getHelperTargetX:function(){return 1!==this.settings.magnetStrength?(this.getHelperTargetX._draggeeOffsetX=this.$draggee.offset().left,this.getHelperTargetX._draggeeOffsetX+(this.mouseX-this.mouseOffsetX-this.getHelperTargetX._draggeeOffsetX)/this.settings.magnetStrength):this.base()},getHelperTargetY:function(){return 1!==this.settings.magnetStrength?(this.getHelperTargetY._draggeeOffsetY=this.$draggee.offset().top,this.getHelperTargetY._draggeeOffsetY+(this.mouseY-this.mouseOffsetY-this.getHelperTargetY._draggeeOffsetY)/this.settings.magnetStrength):this.base()},canInsertBefore:function($item){return!0},canInsertAfter:function($item){return!0},onDragStart:function(){if(this.oldDraggeeIndexes=this._getDraggeeIndexes(),this.settings.moveTargetItemToFront&&this.$draggee.length>1&&this._getItemIndex(this.$draggee[0])>this._getItemIndex(this.$draggee[1])&&this.$draggee.first().insertBefore(this.$draggee[1]),this.$insertion=this.createInsertion(),this._placeInsertionWithDraggee(),this.closestItem=null,this._clearMidpoints(),this.settings.container)for(this.$heightedContainer=$(this.settings.container);!this.$heightedContainer.height();)this.$heightedContainer=this.$heightedContainer.parent();this.base()},onDrag:function(){this.$heightedContainer&&!Garnish.hitTest(this.mouseX,this.mouseY,this.$heightedContainer)?this.closestItem&&(this.closestItem=null,this._removeInsertion()):this.closestItem!==(this.closestItem=this._getClosestItem())&&null!==this.closestItem&&this._updateInsertion(),this.base()},onDragStop:function(){this._removeInsertion(),this.settings.moveTargetItemToFront||0===this.targetItemPositionInDraggee||this.$targetItem.insertAfter(this.$draggee.eq(this.targetItemPositionInDraggee)),this.returnHelpersToDraggees(),this.base(),this.$items=$().add(this.$items),this.newDraggeeIndexes=this._getDraggeeIndexes(),this.newDraggeeIndexes.join(",")!==this.oldDraggeeIndexes.join(",")&&this.onSortChange()},onInsertionPointChange:function(){Garnish.requestAnimationFrame(function(){this.trigger("insertionPointChange"),this.settings.onInsertionPointChange()}.bind(this))},onSortChange:function(){Garnish.requestAnimationFrame(function(){this.trigger("sortChange"),this.settings.onSortChange()}.bind(this))},_getItemIndex:function(item){return $.inArray(item,this.$items)},_getDraggeeIndexes:function(){for(var indexes=[],i=0;i<this.$draggee.length;i++)indexes.push(this._getItemIndex(this.$draggee[i]));return indexes},_getClosestItem:function(){for(this._getClosestItem._closestItem=null,this.settings.removeDraggee?this.insertionVisible&&this._testForClosestItem(this.$insertion[0]):this._testForClosestItem(this.$draggee[0]),this._getClosestItem._closestItem&&(this._getClosestItem._midpoint=this._getItemMidpoint(this._getClosestItem._closestItem)),this.settings.axis!==Garnish.Y_AXIS&&(this._getClosestItem._startXDist=this._getClosestItem._lastXDist=this._getClosestItem._closestItem?Math.abs(this._getClosestItem._midpoint.x-this.draggeeVirtualMidpointX):null),this.settings.axis!==Garnish.X_AXIS&&(this._getClosestItem._startYDist=this._getClosestItem._lastYDist=this._getClosestItem._closestItem?Math.abs(this._getClosestItem._midpoint.y-this.draggeeVirtualMidpointY):null),this._getClosestItem._$otherItem=this.$draggee.first().prev();this._getClosestItem._$otherItem.length&&(this._getClosestItem._midpoint=this._getItemMidpoint(this._getClosestItem._$otherItem[0]),this.settings.axis!==Garnish.Y_AXIS&&(this._getClosestItem._xDist=Math.abs(this._getClosestItem._midpoint.x-this.draggeeVirtualMidpointX)),this.settings.axis!==Garnish.X_AXIS&&(this._getClosestItem._yDist=Math.abs(this._getClosestItem._midpoint.y-this.draggeeVirtualMidpointY)),!(this.settings.axis===Garnish.Y_AXIS||null!==this._getClosestItem._lastXDist&&this._getClosestItem._xDist>this._getClosestItem._lastXDist)||!(this.settings.axis===Garnish.X_AXIS||null!==this._getClosestItem._lastYDist&&this._getClosestItem._yDist>this._getClosestItem._lastYDist));)this.settings.axis!==Garnish.Y_AXIS&&(this._getClosestItem._lastXDist=this._getClosestItem._xDist),this.settings.axis!==Garnish.X_AXIS&&(this._getClosestItem._lastYDist=this._getClosestItem._yDist),this.canInsertBefore(this._getClosestItem._$otherItem)&&this._testForClosestItem(this._getClosestItem._$otherItem[0]),this._getClosestItem._$otherItem=this._getClosestItem._$otherItem.prev();for(this.settings.axis!==Garnish.Y_AXIS&&(this._getClosestItem._lastXDist=this._getClosestItem._startXDist),this.settings.axis!==Garnish.X_AXIS&&(this._getClosestItem._lastYDist=this._getClosestItem._startYDist),this._getClosestItem._$otherItem=this.$draggee.last().next();this._getClosestItem._$otherItem.length&&(this._getClosestItem._midpoint=this._getItemMidpoint(this._getClosestItem._$otherItem[0]),this.settings.axis!==Garnish.Y_AXIS&&(this._getClosestItem._xDist=Math.abs(this._getClosestItem._midpoint.x-this.draggeeVirtualMidpointX)),this.settings.axis!==Garnish.X_AXIS&&(this._getClosestItem._yDist=Math.abs(this._getClosestItem._midpoint.y-this.draggeeVirtualMidpointY)),!(this.settings.axis===Garnish.Y_AXIS||null!==this._getClosestItem._lastXDist&&this._getClosestItem._xDist>this._getClosestItem._lastXDist)||!(this.settings.axis===Garnish.X_AXIS||null!==this._getClosestItem._lastYDist&&this._getClosestItem._yDist>this._getClosestItem._lastYDist));)this.settings.axis!==Garnish.Y_AXIS&&(this._getClosestItem._lastXDist=this._getClosestItem._xDist),this.settings.axis!==Garnish.X_AXIS&&(this._getClosestItem._lastYDist=this._getClosestItem._yDist),this.canInsertAfter(this._getClosestItem._$otherItem)&&this._testForClosestItem(this._getClosestItem._$otherItem[0]),this._getClosestItem._$otherItem=this._getClosestItem._$otherItem.next();return this._getClosestItem._closestItem===this.$draggee[0]||this.insertionVisible&&this._getClosestItem._closestItem===this.$insertion[0]?null:this._getClosestItem._closestItem},_clearMidpoints:function(){this._midpointVersion++,this._$prevItem=null},_getItemMidpoint:function(item){return $.data(item,"midpointVersion")!==this._midpointVersion&&(this._getItemMidpoint._repositionDraggee=!this.settings.axis&&(!this.settings.removeDraggee||this.insertionVisible)&&item!==this.$draggee[0]&&(!this.$insertion||item!==this.$insertion.get(0)),this._getItemMidpoint._repositionDraggee?(this._$prevItem||(this._$prevItem=(this.insertionVisible?this.$insertion:this.$draggee).first().prev()),this._moveDraggeeToItem(item),this.settings.removeDraggee?this._getItemMidpoint._$item=this.$insertion:this._getItemMidpoint._$item=this.$draggee):this._getItemMidpoint._$item=$(item),this._getItemMidpoint._offset=this._getItemMidpoint._$item.offset(),$.data(item,"midpoint",{x:this._getItemMidpoint._offset.left+this._getItemMidpoint._$item.outerWidth()/2,y:this._getItemMidpoint._offset.top+this._getItemMidpoint._$item.outerHeight()/2}),$.data(item,"midpointVersion",this._midpointVersion),delete this._getItemMidpoint._$item,delete this._getItemMidpoint._offset,this._getItemMidpoint._repositionDraggee&&(this._$prevItem.length?this.$draggee.insertAfter(this._$prevItem):this.$draggee.prependTo(this.$draggee.parent()),this._placeInsertionWithDraggee())),$.data(item,"midpoint")},_testForClosestItem:function(item){this._testForClosestItem._midpoint=this._getItemMidpoint(item),this._testForClosestItem._mouseDistX=Math.abs(this._testForClosestItem._midpoint.x-this.draggeeVirtualMidpointX),this._testForClosestItem._mouseDistY=Math.abs(this._testForClosestItem._midpoint.y-this.draggeeVirtualMidpointY),(null===this._getClosestItem._closestItem||this._testForClosestItem._mouseDistY<this._getClosestItem._closestItemMouseDistY||this._testForClosestItem._mouseDistY===this._getClosestItem._closestItemMouseDistY&&this._testForClosestItem._mouseDistX<=this._getClosestItem._closestItemMouseDistX)&&(this._getClosestItem._closestItem=item,this._getClosestItem._closestItemMouseDistX=this._testForClosestItem._mouseDistX,this._getClosestItem._closestItemMouseDistY=this._testForClosestItem._mouseDistY)},_updateInsertion:function(){this.closestItem&&this._moveDraggeeToItem(this.closestItem),this._clearMidpoints(),this.onInsertionPointChange()},_moveDraggeeToItem:function(item){this.$draggee.index()<$(item).index()?this.$draggee.insertAfter(item):this.$draggee.insertBefore(item),this._placeInsertionWithDraggee()},_placeInsertionWithDraggee:function(){this.$insertion&&(this.$insertion.insertBefore(this.$draggee.first()),this.insertionVisible=!0)},_removeInsertion:function(){this.insertionVisible&&(this.$insertion.remove(),this.insertionVisible=!1)}},{defaults:{container:null,insertion:null,moveTargetItemToFront:!1,magnetStrength:1,onInsertionPointChange:$.noop,onSortChange:$.noop}}),Garnish.EscManager=Garnish.Base.extend({handlers:null,init:function(){this.handlers=[],this.addListener(Garnish.$bod,"keyup",(function(ev){ev.keyCode===Garnish.ESC_KEY&&this.escapeLatest(ev)}))},register:function(obj,func){this.handlers.push({obj:obj,func:func})},unregister:function(obj){for(var i=this.handlers.length-1;i>=0;i--)this.handlers[i].obj===obj&&this.handlers.splice(i,1)},escapeLatest:function(ev){if(this.handlers.length){var handler=this.handlers.pop(),func;(func="function"==typeof handler.func?handler.func:handler.obj[handler.func]).call(handler.obj,ev),"function"==typeof handler.obj.trigger&&handler.obj.trigger("escape")}}}),Garnish.escManager=new Garnish.EscManager,Garnish.HUD=Garnish.Base.extend({$trigger:null,$fixedTriggerParent:null,$hud:null,$tip:null,$body:null,$header:null,$footer:null,$mainContainer:null,$main:null,$shade:null,showing:!1,orientation:null,updatingSizeAndPosition:!1,windowWidth:null,windowHeight:null,scrollTop:null,scrollLeft:null,mainWidth:null,mainHeight:null,init:function(trigger,bodyContents,settings){this.$trigger=$(trigger),this.setSettings(settings,Garnish.HUD.defaults),this.on("show",this.settings.onShow),this.on("hide",this.settings.onHide),this.on("submit",this.settings.onSubmit),void 0===Garnish.HUD.activeHUDs&&(Garnish.HUD.activeHUDs={}),this.$shade=$("<div/>",{class:this.settings.shadeClass}),this.$hud=$("<div/>",{class:this.settings.hudClass}).data("hud",this),this.$tip=$("<div/>",{class:this.settings.tipClass}).appendTo(this.$hud),this.$body=$("<form/>",{class:this.settings.bodyClass}).appendTo(this.$hud),this.$mainContainer=$("<div/>",{class:this.settings.mainContainerClass}).appendTo(this.$body),this.$main=$("<div/>",{class:this.settings.mainClass}).appendTo(this.$mainContainer),this.updateBody(bodyContents);var $parent=this.$trigger;do{if("fixed"===$parent.css("position")){this.$fixedTriggerParent=$parent;break}$parent=$parent.offsetParent()}while($parent.length&&"HTML"!==$parent.prop("nodeName"));this.$fixedTriggerParent?this.$hud.css("position","fixed"):this.$hud.css("position","absolute"),this.$hud.css("opacity",0),this.show(),this.$hud.css("opacity",1),this.addListener(this.$body,"submit","_handleSubmit"),this.settings.hideOnShadeClick&&this.addListener(this.$shade,"tap,click","hide"),this.settings.closeBtn&&this.addListener(this.settings.closeBtn,"activate","hide"),this.addListener(Garnish.$win,"resize","updateSizeAndPosition"),this.addListener(this.$main,"resize","updateSizeAndPosition"),this.$fixedTriggerParent||Garnish.$scrollContainer[0]===Garnish.$win[0]||this.addListener(Garnish.$scrollContainer,"scroll","updateSizeAndPosition")},updateBody:function(bodyContents){this.$main.html(""),this.$header&&(this.$hud.removeClass("has-header"),this.$header.remove(),this.$header=null),this.$footer&&(this.$hud.removeClass("has-footer"),this.$footer.remove(),this.$footer=null),this.$main.append(bodyContents);var $header=this.$main.find("."+this.settings.headerClass+":first"),$footer=this.$main.find("."+this.settings.footerClass+":first");$header.length&&(this.$header=$header.insertBefore(this.$mainContainer),this.$hud.addClass("has-header")),$footer.length&&(this.$footer=$footer.insertAfter(this.$mainContainer),this.$hud.addClass("has-footer"))},show:function(ev){if(ev&&ev.stopPropagation&&ev.stopPropagation(),!this.showing){if(this.settings.closeOtherHUDs)for(var hudID in Garnish.HUD.activeHUDs)Garnish.HUD.activeHUDs.hasOwnProperty(hudID)&&Garnish.HUD.activeHUDs[hudID].hide();this.$shade.appendTo(Garnish.$bod),this.$hud.appendTo(Garnish.$bod),this.$hud.show(),this.$shade.show(),this.showing=!0,Garnish.HUD.activeHUDs[this._namespace]=this,Garnish.shortcutManager.addLayer(),this.settings.hideOnEsc&&Garnish.shortcutManager.registerShortcut(Garnish.ESC_KEY,this.hide.bind(this)),this.onShow(),this.enable(),this.updateRecords()&&(this.$hud.css("top",Garnish.$scrollContainer.scrollTop()),this.updateSizeAndPosition(!0))}},onShow:function(){this.trigger("show")},updateRecords:function(){var changed=!1;return changed=this.windowWidth!==(this.windowWidth=Garnish.$win.width())||changed,changed=this.windowHeight!==(this.windowHeight=Garnish.$win.height())||changed,changed=this.scrollTop!==(this.scrollTop=Garnish.$scrollContainer.scrollTop())||changed,changed=this.scrollLeft!==(this.scrollLeft=Garnish.$scrollContainer.scrollLeft())||changed,changed=this.mainWidth!==(this.mainWidth=this.$main.outerWidth())||changed,changed=this.mainHeight!==(this.mainHeight=this.$main.outerHeight())||changed},updateSizeAndPosition:function(force){(!0===force||this.updateRecords()&&!this.updatingSizeAndPosition)&&(this.updatingSizeAndPosition=!0,Garnish.requestAnimationFrame(this.updateSizeAndPositionInternal.bind(this)))},updateSizeAndPositionInternal:function(){var triggerWidth,triggerHeight,triggerOffset,windowScrollLeft,windowScrollTop,scrollContainerTriggerOffset,scrollContainerScrollLeft,scrollContainerScrollTop,hudBodyWidth,hudBodyHeight;windowScrollLeft=Garnish.$win.scrollLeft(),windowScrollTop=Garnish.$win.scrollTop(),triggerWidth=this.$trigger.outerWidth(),triggerHeight=this.$trigger.outerHeight(),triggerOffset=this.$trigger.offset(),this.$fixedTriggerParent?(triggerOffset.left-=windowScrollLeft,triggerOffset.top-=windowScrollTop,scrollContainerTriggerOffset=triggerOffset,windowScrollLeft=0,windowScrollTop=0,scrollContainerScrollLeft=0,scrollContainerScrollTop=0):(scrollContainerTriggerOffset=Garnish.getOffset(this.$trigger),scrollContainerScrollLeft=Garnish.$scrollContainer.scrollLeft(),scrollContainerScrollTop=Garnish.$scrollContainer.scrollTop()),triggerOffset.right=triggerOffset.left+triggerWidth,triggerOffset.bottom=triggerOffset.top+triggerHeight,scrollContainerTriggerOffset.right=scrollContainerTriggerOffset.left+triggerWidth,scrollContainerTriggerOffset.bottom=scrollContainerTriggerOffset.top+triggerHeight,this.$hud.css({width:""}),this.$mainContainer.css({height:"","overflow-x":"","overflow-y":""}),hudBodyWidth=this.$body.width(),hudBodyHeight=this.$body.height();var clearances={bottom:this.windowHeight+scrollContainerScrollTop-scrollContainerTriggerOffset.bottom,top:scrollContainerTriggerOffset.top-scrollContainerScrollTop,right:this.windowWidth+scrollContainerScrollLeft-scrollContainerTriggerOffset.right,left:scrollContainerTriggerOffset.left-scrollContainerScrollLeft},maxHudBodyWidth,maxHudBodyHeight,triggerCenter,left,top;this.orientation=null;for(var i=0;i<this.settings.orientations.length;i++){var orientation=this.settings.orientations[i],relevantSize="top"===orientation||"bottom"===orientation?hudBodyHeight:hudBodyWidth;if(clearances[orientation]-(this.settings.windowSpacing+this.settings.triggerSpacing)>=relevantSize){this.orientation=orientation;break}(!this.orientation||clearances[orientation]>clearances[this.orientation])&&(this.orientation=orientation)}if(this.orientation&&-1!==$.inArray(this.orientation,["bottom","top","right","left"])||(this.orientation="bottom"),this.tipClass&&this.$tip.removeClass(this.tipClass),this.tipClass=this.settings.tipClass+"-"+Garnish.HUD.tipClasses[this.orientation],this.$tip.addClass(this.tipClass),"top"===this.orientation||"bottom"===this.orientation?(maxHudBodyWidth=this.windowWidth-2*this.settings.windowSpacing,maxHudBodyHeight=clearances[this.orientation]-this.settings.windowSpacing-this.settings.triggerSpacing):(maxHudBodyWidth=clearances[this.orientation]-this.settings.windowSpacing-this.settings.triggerSpacing,maxHudBodyHeight=this.windowHeight-2*this.settings.windowSpacing),maxHudBodyWidth<this.settings.minBodyWidth&&(maxHudBodyWidth=this.settings.minBodyWidth),maxHudBodyHeight<this.settings.minBodyHeight&&(maxHudBodyHeight=this.settings.minBodyHeight),(hudBodyWidth>maxHudBodyWidth||hudBodyWidth<this.settings.minBodyWidth)&&(hudBodyWidth=hudBodyWidth>maxHudBodyWidth?maxHudBodyWidth:this.settings.minBodyWidth,this.$hud.width(hudBodyWidth),this.mainWidth>maxHudBodyWidth&&this.$mainContainer.css("overflow-x","scroll"),hudBodyHeight=this.$body.height()),hudBodyHeight>maxHudBodyHeight||hudBodyHeight<this.settings.minBodyHeight){var mainHeight=hudBodyHeight=hudBodyHeight>maxHudBodyHeight?maxHudBodyHeight:this.settings.minBodyHeight;this.$header&&(mainHeight-=this.$header.outerHeight()),this.$footer&&(mainHeight-=this.$footer.outerHeight()),this.$mainContainer.height(mainHeight),this.mainHeight>mainHeight&&this.$mainContainer.css("overflow-y","scroll")}if("top"===this.orientation||"bottom"===this.orientation){var maxLeft=this.windowWidth+windowScrollLeft-(hudBodyWidth+this.settings.windowSpacing),minLeft=windowScrollLeft+this.settings.windowSpacing;(left=(triggerCenter=triggerOffset.left+Math.round(triggerWidth/2))-Math.round(hudBodyWidth/2))>maxLeft&&(left=maxLeft),left<minLeft&&(left=minLeft),this.$hud.css("left",left);var tipLeft=triggerCenter-left-this.settings.tipWidth/2;this.$tip.css({left:tipLeft,top:""}),"top"===this.orientation?(top=triggerOffset.top-(hudBodyHeight+this.settings.triggerSpacing),this.$hud.css("top",top)):(top=triggerOffset.bottom+this.settings.triggerSpacing,this.$hud.css("top",top))}else{var maxTop=this.windowHeight+windowScrollTop-(hudBodyHeight+this.settings.windowSpacing),minTop=windowScrollTop+this.settings.windowSpacing;(top=(triggerCenter=triggerOffset.top+Math.round(triggerHeight/2))-Math.round(hudBodyHeight/2))>maxTop&&(top=maxTop),top<minTop&&(top=minTop),this.$hud.css("top",top);var tipTop=triggerCenter-top-this.settings.tipWidth/2;this.$tip.css({top:tipTop,left:""}),"left"===this.orientation?(left=triggerOffset.left-(hudBodyWidth+this.settings.triggerSpacing),this.$hud.css("left",left)):(left=triggerOffset.right+this.settings.triggerSpacing,this.$hud.css("left",left))}this.updatingSizeAndPosition=!1,this.trigger("updateSizeAndPosition")},hide:function(){this.showing&&(this.disable(),this.$hud.hide(),this.$shade.hide(),this.showing=!1,delete Garnish.HUD.activeHUDs[this._namespace],Garnish.shortcutManager.removeLayer(),this.onHide())},onHide:function(){this.trigger("hide")},toggle:function(){this.showing?this.hide():this.show()},submit:function(){this.onSubmit()},onSubmit:function(){this.trigger("submit")},_handleSubmit:function(ev){ev.preventDefault(),this.submit()}},{tipClasses:{bottom:"top",top:"bottom",right:"left",left:"right"},defaults:{shadeClass:"hud-shade",hudClass:"hud",tipClass:"tip",bodyClass:"body",headerClass:"hud-header",footerClass:"hud-footer",mainContainerClass:"main-container",mainClass:"main",orientations:["bottom","top","right","left"],triggerSpacing:10,windowSpacing:10,tipWidth:30,minBodyWidth:200,minBodyHeight:0,onShow:$.noop,onHide:$.noop,onSubmit:$.noop,closeBtn:null,closeOtherHUDs:!0,hideOnEsc:!0,hideOnShadeClick:!0}}),Garnish.MenuBtn=Garnish.Base.extend({$btn:null,menu:null,showingMenu:!1,disabled:!0,init:function(btn,menu,settings){var $menu;void 0===settings&&$.isPlainObject(menu)&&(settings=menu,menu=null),this.$btn=$(btn),this.$btn.data("menubtn")?(menu||($menu=this.$btn.data("menubtn").menu.$container),Garnish.log("Double-instantiating a menu button on an element"),this.$btn.data("menubtn").destroy()):menu||($menu=this.$btn.next(".menu").detach()),this.$btn.data("menubtn",this),this.setSettings(settings,Garnish.MenuBtn.defaults),this.menu=menu||new Garnish.CustomSelect($menu),this.menu.$anchor=$(this.settings.menuAnchor||this.$btn),this.menu.on("optionselect",function(ev){this.onOptionSelect(ev.selectedOption)}.bind(this)),this.$btn.attr({tabindex:0,"aria-controls":this.menu.menuId,"aria-haspopup":"listbox","aria-expanded":"false"}),this.menu.on("hide",this.onMenuHide.bind(this)),this.addListener(this.$btn,"mousedown","onMouseDown"),this.addListener(this.$btn,"keydown","onKeyDown"),this.addListener(this.$btn,"blur","onBlur"),this.enable()},onBlur:function(){this.showingMenu&&Garnish.requestAnimationFrame(function(){$.contains(this.menu.$container.get(0),document.activeElement)||this.hideMenu()}.bind(this))},onKeyDown:function(ev){var $option;switch(ev.keyCode){case Garnish.RETURN_KEY:{ev.preventDefault();const $currentOption=this.menu.$options.filter(".hover");$currentOption.length>0&&$currentOption.get(0).click();break}case Garnish.SPACE_KEY:if(ev.preventDefault(),this.showingMenu){const $currentOption=this.menu.$options.filter(".hover");$currentOption.length>0&&$currentOption.get(0).click()}else this.showMenu(),0===($option=this.menu.$options.filter(".sel:first")).length&&($option=this.menu.$options.first()),this.focusOption($option);break;case Garnish.DOWN_KEY:ev.preventDefault(),this.showingMenu?($.each(this.menu.$options,function(index,value){$option||$(value).hasClass("hover")&&index+1<this.menu.$options.length&&($option=$(this.menu.$options[index+1]))}.bind(this)),$option||($option=$(this.menu.$options[0]))):(this.showMenu(),0===($option=this.menu.$options.filter(".sel:first")).length&&($option=this.menu.$options.first())),this.focusOption($option);break;case Garnish.UP_KEY:ev.preventDefault(),this.showingMenu?($.each(this.menu.$options,function(index,value){$option||$(value).hasClass("hover")&&index-1>=0&&($option=$(this.menu.$options[index-1]))}.bind(this)),$option||($option=$(this.menu.$options[this.menu.$options.length-1]))):(this.showMenu(),0===($option=this.menu.$options.filter(".sel:first")).length&&($option=this.menu.$options.last())),this.focusOption($option)}},focusOption:function($option){this.menu.$options.removeClass("hover"),$option.addClass("hover"),this.menu.$menuList.attr("aria-activedescendant",$option.attr("id")),this.$btn.attr("aria-activedescendant",$option.attr("id"))},onMouseDown:function(ev){ev.which!==Garnish.PRIMARY_CLICK||Garnish.isCtrlKeyPressed(ev)||"INPUT"===ev.target.nodeName||(ev.preventDefault(),this.showingMenu?this.hideMenu():this.showMenu())},showMenu:function(){this.disabled||(this.menu.show(),this.$btn.addClass("active"),this.$btn.trigger("focus"),this.$btn.attr("aria-expanded","true"),this.showingMenu=!0,setTimeout(function(){this.addListener(Garnish.$doc,"mousedown","onMouseDown")}.bind(this),1))},hideMenu:function(){this.menu.hide(),this.$btn.attr("aria-expanded","false")},onMenuHide:function(){this.$btn.removeClass("active"),this.showingMenu=!1,this.removeListener(Garnish.$doc,"mousedown")},onOptionSelect:function(option){this.settings.onOptionSelect(option),this.trigger("optionSelect",{option:option})},enable:function(){this.disabled=!1},disable:function(){this.disabled=!0},destroy:function(){this.$btn.removeData("menubtn"),this.base()}},{defaults:{menuAnchor:null,onOptionSelect:$.noop}}),Garnish.MixedInput=Garnish.Base.extend({$container:null,elements:null,focussedElement:null,blurTimeout:null,init:function(container,settings){this.$container=$(container),this.setSettings(settings,Garnish.MixedInput.defaults),this.elements=[],this.$container.attr("tabindex",0),this.addListener(this.$container,"focus","onFocus")},getElementIndex:function($elem){return $.inArray($elem,this.elements)},isText:function($elem){return"INPUT"===$elem.prop("nodeName")},onFocus:function(){if(this.elements.length){var $elem=this.elements[0];this.setFocus($elem),this.setCarotPos($elem,0)}else this.addTextElement()},addTextElement:function(index){var text=new TextElement(this);return this.addElement(text.$input,index),text},addElement:function($elem,index){if(void 0===index)if(this.focussedElement){var focussedElement=this.focussedElement,focussedElementIndex=this.getElementIndex(focussedElement);if(this.isText(focussedElement)){var selectionStart=focussedElement.prop("selectionStart"),selectionEnd=focussedElement.prop("selectionEnd"),val=focussedElement.val(),preVal=val.substring(0,selectionStart),postVal=val.substr(selectionEnd);if(preVal&&postVal){focussedElement.val(preVal).trigger("change");var newText=new TextElement(this);newText.$input.val(postVal).trigger("change"),this.addElement(newText.$input,focussedElementIndex+1),index=focussedElementIndex+1}else index=preVal?focussedElementIndex+1:focussedElementIndex}else index=focussedElementIndex+1}else index=this.elements.length;void 0!==this.elements[index]?($elem.insertBefore(this.elements[index]),this.elements.splice(index,0,$elem)):(index=this.elements.length,this.$container.append($elem),this.elements.push($elem)),this.isText($elem)||(0!==index&&this.isText(this.elements[index-1])||(this.addTextElement(index),index++),index!==this.elements.length-1&&this.isText(this.elements[index+1])||this.addTextElement(index+1)),this.addListener($elem,"click",(function(){this.setFocus($elem)})),setTimeout(function(){this.setFocus($elem)}.bind(this),1)},removeElement:function($elem){var index=this.getElementIndex($elem);if(-1!==index){if(this.elements.splice(index,1),!this.isText($elem)){var $prevElem=this.elements[index-1],$nextElem=this.elements[index];if(this.isText($prevElem)&&this.isText($nextElem)){var prevElemVal=$prevElem.val(),newVal=prevElemVal+$nextElem.val();$prevElem.val(newVal).trigger("change"),this.removeElement($nextElem),this.setFocus($prevElem),this.setCarotPos($prevElem,prevElemVal.length)}}$elem.remove()}},setFocus:function($elem){this.$container.addClass("focus"),this.focussedElement?this.blurFocussedElement():this.$container.attr("tabindex","-1"),$elem.attr("tabindex","0"),$elem.focus(),this.focussedElement=$elem,this.addListener($elem,"blur",(function(){this.blurTimeout=setTimeout(function(){this.focussedElement===$elem&&(this.blurFocussedElement(),this.focussedElement=null,this.$container.removeClass("focus"),this.$container.attr("tabindex","0"))}.bind(this),1)}))},blurFocussedElement:function(){this.removeListener(this.focussedElement,"blur"),this.focussedElement.attr("tabindex","-1")},focusPreviousElement:function($from){var index=this.getElementIndex($from);if(index>0){var $elem=this.elements[index-1];if(this.setFocus($elem),this.isText($elem)){var length=$elem.val().length;this.setCarotPos($elem,length)}}},focusNextElement:function($from){var index=this.getElementIndex($from);if(index<this.elements.length-1){var $elem=this.elements[index+1];this.setFocus($elem),this.isText($elem)&&this.setCarotPos($elem,0)}},setCarotPos:function($elem,pos){$elem.prop("selectionStart",pos),$elem.prop("selectionEnd",pos)}});var TextElement=Garnish.Base.extend({parentInput:null,$input:null,$stage:null,val:null,focussed:!1,interval:null,init:function(parentInput){this.parentInput=parentInput,this.$input=$('<input type="text"/>').appendTo(this.parentInput.$container),this.$input.css("margin-right",2-TextElement.padding+"px"),this.setWidth(),this.addListener(this.$input,"focus","onFocus"),this.addListener(this.$input,"blur","onBlur"),this.addListener(this.$input,"keydown","onKeyDown"),this.addListener(this.$input,"change","checkInput")},getIndex:function(){return this.parentInput.getElementIndex(this.$input)},buildStage:function(){this.$stage=$("<stage/>").appendTo(Garnish.$bod),this.$stage.css({position:"absolute",top:-9999,left:-9999,wordWrap:"nowrap"}),Garnish.copyTextStyles(this.$input,this.$stage)},getTextWidth:function(val){return this.$stage||this.buildStage(),val&&(val=(val=(val=(val=val.replace(/&/g,"&amp;")).replace(/</g,"&lt;")).replace(/>/g,"&gt;")).replace(/ /g,"&nbsp;")),this.$stage.html(val),this.stageWidth=this.$stage.width(),this.stageWidth},onFocus:function(){this.focussed=!0,this.interval=setInterval(this.checkInput.bind(this),Garnish.NiceText.interval),this.checkInput()},onBlur:function(){this.focussed=!1,clearInterval(this.interval),this.checkInput()},onKeyDown:function(ev){switch(setTimeout(this.checkInput.bind(this),1),ev.keyCode){case Garnish.LEFT_KEY:0===this.$input.prop("selectionStart")&&0===this.$input.prop("selectionEnd")&&this.parentInput.focusPreviousElement(this.$input);break;case Garnish.RIGHT_KEY:this.$input.prop("selectionStart")===this.val.length&&this.$input.prop("selectionEnd")===this.val.length&&this.parentInput.focusNextElement(this.$input);break;case Garnish.DELETE_KEY:0===this.$input.prop("selectionStart")&&0===this.$input.prop("selectionEnd")&&(this.parentInput.focusPreviousElement(this.$input),ev.preventDefault())}},getVal:function(){return this.val=this.$input.val(),this.val},setVal:function(val){this.$input.val(val),this.checkInput()},checkInput:function(){var changed=this.val!==this.getVal();return changed&&(this.setWidth(),this.onChange()),changed},setWidth:function(){if(this.stageWidth!==this.getTextWidth(this.val)){var width=this.stageWidth+TextElement.padding;this.$input.width(width)}},onChange:$.noop},{padding:20});Garnish.Modal=Garnish.Base.extend({$container:null,$shade:null,visible:!1,dragger:null,desiredWidth:null,desiredHeight:null,resizeDragger:null,resizeStartWidth:null,resizeStartHeight:null,init:function(container,settings){void 0===settings&&$.isPlainObject(container)&&(settings=container,container=null),this.setSettings(settings,Garnish.Modal.defaults),this.$shade=$('<div class="'+this.settings.shadeClass+'"/>'),container?this.$shade.insertBefore(container):this.$shade.appendTo(Garnish.$bod),container&&(this.setContainer(container),this.settings.autoShow&&this.show()),Garnish.Modal.instances.push(this)},setContainer:function(container){if(this.$container=$(container),this.$container.data("modal")&&(Garnish.log("Double-instantiating a modal on an element"),this.$container.data("modal").destroy()),this.$container.data("modal",this),this.settings.draggable&&(this.dragger=new Garnish.DragMove(this.$container,{handle:this.settings.dragHandleSelector?this.$container.find(this.settings.dragHandleSelector):this.$container})),this.settings.resizable){var $resizeDragHandle=$('<div class="resizehandle"/>').appendTo(this.$container);this.resizeDragger=new Garnish.BaseDrag($resizeDragHandle,{onDragStart:this._handleResizeStart.bind(this),onDrag:this._handleResize.bind(this)})}this.addListener(this.$container,"click",(function(ev){ev.stopPropagation()})),this.visible&&this.show()},show:function(){this.settings.closeOtherModals&&Garnish.Modal.visibleModal&&Garnish.Modal.visibleModal!==this&&Garnish.Modal.visibleModal.hide(),this.$container&&(this.$shade.appendTo(Garnish.$bod),this.$container.appendTo(Garnish.$bod),this.$container.show(),this.updateSizeAndPosition(),this.$shade.velocity("fadeIn",{duration:50,complete:function(){this.$container.velocity("fadeIn",{complete:function(){this.updateSizeAndPosition(),this.onFadeIn()}.bind(this)})}.bind(this)}),this.settings.hideOnShadeClick&&this.addListener(this.$shade,"click","hide"),this.addListener(Garnish.$win,"resize","_handleWindowResize")),this.enable(),this.visible||(this.visible=!0,Garnish.Modal.visibleModal=this,Garnish.shortcutManager.addLayer(),this.settings.hideOnEsc&&Garnish.shortcutManager.registerShortcut(Garnish.ESC_KEY,this.hide.bind(this)),this.trigger("show"),this.settings.onShow())},quickShow:function(){this.show(),this.$container&&(this.$container.velocity("stop"),this.$container.show().css("opacity",1),this.$shade.velocity("stop"),this.$shade.show().css("opacity",1))},hide:function(ev){this.visible&&(this.disable(),ev&&ev.stopPropagation(),this.$container&&(this.$container.velocity("fadeOut",{duration:Garnish.FX_DURATION}),this.$shade.velocity("fadeOut",{duration:Garnish.FX_DURATION,complete:this.onFadeOut.bind(this)}),this.settings.hideOnShadeClick&&this.removeListener(this.$shade,"click"),this.removeListener(Garnish.$win,"resize")),this.visible=!1,Garnish.Modal.visibleModal=null,Garnish.shortcutManager.removeLayer(),this.trigger("hide"),this.settings.onHide())},quickHide:function(){this.hide(),this.$container&&(this.$container.velocity("stop"),this.$container.css("opacity",0).hide(),this.$shade.velocity("stop"),this.$shade.css("opacity",0).hide())},updateSizeAndPosition:function(){this.$container&&(this.$container.css({width:this.desiredWidth?Math.max(this.desiredWidth,200):"",height:this.desiredHeight?Math.max(this.desiredHeight,200):"","min-width":"","min-height":""}),this.updateSizeAndPosition._windowWidth=Garnish.$win.width(),this.updateSizeAndPosition._width=Math.min(this.getWidth(),this.updateSizeAndPosition._windowWidth-2*this.settings.minGutter),this.$container.css({width:this.updateSizeAndPosition._width,"min-width":this.updateSizeAndPosition._width,left:Math.round((this.updateSizeAndPosition._windowWidth-this.updateSizeAndPosition._width)/2)}),this.updateSizeAndPosition._windowHeight=Garnish.$win.height(),this.updateSizeAndPosition._height=Math.min(this.getHeight(),this.updateSizeAndPosition._windowHeight-2*this.settings.minGutter),this.$container.css({height:this.updateSizeAndPosition._height,"min-height":this.updateSizeAndPosition._height,top:Math.round((this.updateSizeAndPosition._windowHeight-this.updateSizeAndPosition._height)/2)}),this.trigger("updateSizeAndPosition"))},onFadeIn:function(){this.trigger("fadeIn"),this.settings.onFadeIn()},onFadeOut:function(){this.trigger("fadeOut"),this.settings.onFadeOut()},getHeight:function(){if(!this.$container)throw"Attempted to get the height of a modal whose container has not been set.";return this.visible||this.$container.show(),this.getHeight._height=this.$container.outerHeight(),this.visible||this.$container.hide(),this.getHeight._height},getWidth:function(){if(!this.$container)throw"Attempted to get the width of a modal whose container has not been set.";return this.visible||this.$container.show(),this.getWidth._width=this.$container.outerWidth()+1,this.visible||this.$container.hide(),this.getWidth._width},_handleWindowResize:function(ev){ev.target===window&&this.updateSizeAndPosition()},_handleResizeStart:function(){this.resizeStartWidth=this.getWidth(),this.resizeStartHeight=this.getHeight()},_handleResize:function(){Garnish.ltr?this.desiredWidth=this.resizeStartWidth+2*this.resizeDragger.mouseDistX:this.desiredWidth=this.resizeStartWidth-2*this.resizeDragger.mouseDistX,this.desiredHeight=this.resizeStartHeight+2*this.resizeDragger.mouseDistY,this.updateSizeAndPosition()},destroy:function(){this.$container&&this.$container.removeData("modal").remove(),this.dragger&&this.dragger.destroy(),this.resizeDragger&&this.resizeDragger.destroy(),this.base()}},{relativeElemPadding:8,defaults:{autoShow:!0,draggable:!1,dragHandleSelector:null,resizable:!1,minGutter:10,onShow:$.noop,onHide:$.noop,onFadeIn:$.noop,onFadeOut:$.noop,closeOtherModals:!1,hideOnEsc:!0,hideOnShadeClick:!0,shadeClass:"modal-shade"},instances:[],visibleModal:null}),Garnish.NiceText=Garnish.Base.extend({$input:null,$hint:null,$stage:null,$charsLeft:null,autoHeight:null,maxLength:null,showCharsLeft:!1,showingHint:!1,val:null,inputBoxSizing:"content-box",width:null,height:null,minHeight:null,initialized:!1,init:function(input,settings){this.$input=$(input),this.settings=$.extend({},Garnish.NiceText.defaults,settings),this.isVisible()?this.initialize():this.addListener(Garnish.$win,"resize","initializeIfVisible")},isVisible:function(){return this.$input.height()>0},initialize:function(){this.initialized||(this.initialized=!0,this.removeListener(Garnish.$win,"resize"),this.maxLength=this.$input.attr("maxlength"),this.maxLength&&(this.maxLength=parseInt(this.maxLength)),this.maxLength&&(this.settings.showCharsLeft||Garnish.hasAttr(this.$input,"data-show-chars-left"))&&(this.showCharsLeft=!0,this.$input.removeAttr("maxlength")),this.$input.data("nicetext")&&(Garnish.log("Double-instantiating a transparent text input on an element"),this.$input.data("nicetext").destroy()),this.$input.data("nicetext",this),this.getVal(),this.autoHeight=this.settings.autoHeight&&"TEXTAREA"===this.$input.prop("nodeName"),this.autoHeight&&(this.minHeight=this.getHeightForValue(""),this.updateHeight(),this.width=this.$input.width(),this.addListener(Garnish.$win,"resize","updateHeightIfWidthChanged")),this.settings.hint&&(this.$hintContainer=$('<div class="texthint-container"/>').insertBefore(this.$input),this.$hint=$('<div class="texthint">'+this.settings.hint+"</div>").appendTo(this.$hintContainer),this.$hint.css({top:parseInt(this.$input.css("borderTopWidth"))+parseInt(this.$input.css("paddingTop")),left:parseInt(this.$input.css("borderLeftWidth"))+parseInt(this.$input.css("paddingLeft"))+1}),Garnish.copyTextStyles(this.$input,this.$hint),this.val?this.$hint.hide():this.showingHint=!0,this.addListener(this.$hint,"mousedown",(function(ev){ev.preventDefault(),this.$input.focus()}))),this.showCharsLeft&&(this.$charsLeft=$('<div aria-live="polite" class="'+this.settings.charsLeftClass+'"/>').insertAfter(this.$input),this.updateCharsLeft()),this.addListener(this.$input,"textchange","onTextChange"),this.addListener(this.$input,"keydown","onKeyDown"))},initializeIfVisible:function(){this.isVisible()&&this.initialize()},getVal:function(){return this.val=this.$input.val(),this.val},showHint:function(){this.$hint.velocity("fadeIn",{complete:Garnish.NiceText.hintFadeDuration}),this.showingHint=!0},hideHint:function(){this.$hint.velocity("fadeOut",{complete:Garnish.NiceText.hintFadeDuration}),this.showingHint=!1},onTextChange:function(){this.getVal(),this.$hint&&(this.showingHint&&this.val?this.hideHint():this.showingHint||this.val||this.showHint()),this.autoHeight&&this.updateHeight(),this.showCharsLeft&&this.updateCharsLeft()},onKeyDown:function(ev){ev.keyCode===Garnish.RETURN_KEY&&Garnish.isCtrlKeyPressed(ev)&&(ev.preventDefault(),this.$input.closest("form").submit())},buildStage:function(){this.$stage=$("<stage/>").appendTo(Garnish.$bod),this.$stage.css({display:"block",position:"absolute",top:-9999,left:-9999}),this.inputBoxSizing=this.$input.css("box-sizing"),"border-box"===this.inputBoxSizing&&this.$stage.css({"border-top":this.$input.css("border-top"),"border-right":this.$input.css("border-right"),"border-bottom":this.$input.css("border-bottom"),"border-left":this.$input.css("border-left"),"padding-top":this.$input.css("padding-top"),"padding-right":this.$input.css("padding-right"),"padding-bottom":this.$input.css("padding-bottom"),"padding-left":this.$input.css("padding-left"),"-webkit-box-sizing":this.inputBoxSizing,"-moz-box-sizing":this.inputBoxSizing,"box-sizing":this.inputBoxSizing}),Garnish.copyTextStyles(this.$input,this.$stage)},getHeightForValue:function(val){if(this.$stage||this.buildStage(),"border-box"===this.inputBoxSizing?this.$stage.css("width",this.$input.outerWidth()):this.$stage.css("width",this.$input.width()),val)val=(val=(val=(val=val.replace(/&/g,"&amp;")).replace(/</g,"&lt;")).replace(/>/g,"&gt;")).replace(/ {2,}/g,(function(spaces){for(var replace="",i=0;i<spaces.length-1;i++)replace+="&nbsp;";return replace+" "})),val=(val=val.replace(/[\n\r]$/g,"<br/>&nbsp;")).replace(/[\n\r]/g,"<br/>");else{val="&nbsp;";for(var i=1;i<this.$input.prop("rows");i++)val+="<br/>&nbsp;"}return this.$stage.html(val),"border-box"===this.inputBoxSizing?this.getHeightForValue._height=this.$stage.outerHeight():this.getHeightForValue._height=this.$stage.height(),this.minHeight&&this.getHeightForValue._height<this.minHeight&&(this.getHeightForValue._height=this.minHeight),this.getHeightForValue._height},updateHeight:function(){this.height!==(this.height=this.getHeightForValue(this.val))&&(this.$input.css("min-height",this.height),this.initialized&&this.onHeightChange())},updateHeightIfWidthChanged:function(){this.isVisible()&&this.width!==(this.width=this.$input.width())&&this.width&&this.updateHeight()},onHeightChange:function(){this.settings.onHeightChange()},updateCharsLeft:function(){this.updateCharsLeft._charsLeft=this.maxLength-this.val.length,this.$charsLeft.html(Garnish.NiceText.charsLeftHtml(this.updateCharsLeft._charsLeft)),this.updateCharsLeft._charsLeft>=0?this.$charsLeft.removeClass(this.settings.negativeCharsLeftClass):this.$charsLeft.addClass(this.settings.negativeCharsLeftClass)},destroy:function(){this.$input.removeData("nicetext"),this.$hint&&this.$hint.remove(),this.$stage&&this.$stage.remove(),this.base()}},{interval:100,hintFadeDuration:50,charsLeftHtml:function(charsLeft){return charsLeft},defaults:{autoHeight:!0,showCharsLeft:!1,charsLeftClass:"chars-left",negativeCharsLeftClass:"negative-chars-left",onHeightChange:$.noop}}),Garnish.Select=Garnish.Base.extend({$container:null,$items:null,$selectedItems:null,$focusedItem:null,mousedownTarget:null,mouseUpTimeout:null,callbackFrame:null,$focusable:null,$first:null,first:null,$last:null,last:null,init:function(container,items,settings){this.$container=$(container),void 0===items&&$.isPlainObject(container)?(settings=container,container=null,items=null):void 0===settings&&$.isPlainObject(items)&&(settings=items,items=null),this.$container.data("select")&&(Garnish.log("Double-instantiating a select on an element"),this.$container.data("select").destroy()),this.$container.data("select",this),this.setSettings(settings,Garnish.Select.defaults),this.$items=$(),this.$selectedItems=$(),this.addItems(items),this.settings.allowEmpty&&!this.settings.checkboxMode&&this.addListener(this.$container,"click",(function(){this.ignoreClick?this.ignoreClick=!1:this.deselectAll(!0)}))},getItemIndex:function($item){return this.$items.index($item[0])},isSelected:function(item){if(Garnish.isJquery(item)){if(!item[0])return!1;item=item[0]}return-1!==$.inArray(item,this.$selectedItems)},selectItem:function($item,focus,preventScroll){this.settings.multi||this.deselectAll(),this.$first=this.$last=$item,this.first=this.last=this.getItemIndex($item),focus&&(this.setFocusableItem($item),this.focusItem($item,preventScroll)),this._selectItems($item)},selectAll:function(){this.settings.multi&&this.$items.length&&(this.first=0,this.last=this.$items.length-1,this.$first=this.$items.eq(this.first),this.$last=this.$items.eq(this.last),this._selectItems(this.$items))},selectRange:function($item,preventScroll){if(!this.settings.multi)return this.selectItem($item,!0,!0);var sliceFrom,sliceTo;this.deselectAll(),this.$last=$item,this.last=this.getItemIndex($item),this.setFocusableItem($item),this.focusItem($item,preventScroll),this.first<this.last?(sliceFrom=this.first,sliceTo=this.last+1):(sliceFrom=this.last,sliceTo=this.first+1),this._selectItems(this.$items.slice(sliceFrom,sliceTo))},deselectItem:function($item){var index=this.getItemIndex($item);this.first===index&&(this.$first=this.first=null),this.last===index&&(this.$last=this.last=null),this._deselectItems($item)},deselectAll:function(clearFirst){clearFirst&&(this.$first=this.first=this.$last=this.last=null),this._deselectItems(this.$items)},deselectOthers:function($item){this.deselectAll(),this.selectItem($item,!0,!0)},toggleItem:function($item,preventScroll){this.isSelected($item)?this._canDeselect($item)&&this.deselectItem($item,!0):this.selectItem($item,!0,preventScroll)},clearMouseUpTimeout:function(){clearTimeout(this.mouseUpTimeout)},getFirstItem:function(){if(this.$items.length)return this.$items.first()},getLastItem:function(){if(this.$items.length)return this.$items.last()},isPreviousItem:function(index){return index>0},isNextItem:function(index){return index<this.$items.length-1},getPreviousItem:function(index){if(this.isPreviousItem(index))return this.$items.eq(index-1)},getNextItem:function(index){if(this.isNextItem(index))return this.$items.eq(index+1)},getItemToTheLeft:function(index){var func=Garnish.ltr?"Previous":"Next";if(this["is"+func+"Item"](index)){if(this.settings.horizontal)return this["get"+func+"Item"](index);if(!this.settings.vertical)return this.getClosestItem(index,Garnish.X_AXIS,"<")}},getItemToTheRight:function(index){var func=Garnish.ltr?"Next":"Previous";if(this["is"+func+"Item"](index)){if(this.settings.horizontal)return this["get"+func+"Item"](index);if(!this.settings.vertical)return this.getClosestItem(index,Garnish.X_AXIS,">")}},getItemAbove:function(index){if(this.isPreviousItem(index)){if(this.settings.vertical)return this.getPreviousItem(index);if(!this.settings.horizontal)return this.getClosestItem(index,Garnish.Y_AXIS,"<")}},getItemBelow:function(index){if(this.isNextItem(index)){if(this.settings.vertical)return this.getNextItem(index);if(!this.settings.horizontal)return this.getClosestItem(index,Garnish.Y_AXIS,">")}},getClosestItem:function(index,axis,dir){for(var axisProps=Garnish.Select.closestItemAxisProps[axis],dirProps=Garnish.Select.closestItemDirectionProps[dir],$thisItem=this.$items.eq(index),thisOffset=$thisItem.offset(),thisMidpoint=thisOffset[axisProps.midpointOffset]+Math.round($thisItem[axisProps.midpointSizeFunc]()/2),otherRowPos=null,smallestMidpointDiff=null,$closestItem=null,step,i=index+(step=Garnish.rtl&&axis===Garnish.X_AXIS?-1*dirProps.step:dirProps.step);void 0!==this.$items[i];i+=step){var $otherItem=this.$items.eq(i),otherOffset=$otherItem.offset();if(dirProps.isNextRow(otherOffset[axisProps.rowOffset],thisOffset[axisProps.rowOffset])){if(null===otherRowPos)otherRowPos=otherOffset[axisProps.rowOffset];else if(otherOffset[axisProps.rowOffset]!==otherRowPos)break;var otherMidpoint=otherOffset[axisProps.midpointOffset]+Math.round($otherItem[axisProps.midpointSizeFunc]()/2),midpointDiff=Math.abs(thisMidpoint-otherMidpoint);if(!(null===smallestMidpointDiff||midpointDiff<smallestMidpointDiff))break;smallestMidpointDiff=midpointDiff,$closestItem=$otherItem}else if(dirProps.isWrongDirection(otherOffset[axisProps.rowOffset],thisOffset[axisProps.rowOffset]))break}return $closestItem},getFurthestItemToTheLeft:function(index){return this.getFurthestItem(index,"ToTheLeft")},getFurthestItemToTheRight:function(index){return this.getFurthestItem(index,"ToTheRight")},getFurthestItemAbove:function(index){return this.getFurthestItem(index,"Above")},getFurthestItemBelow:function(index){return this.getFurthestItem(index,"Below")},getFurthestItem:function(index,dir){for(var $item,$testItem;$testItem=this["getItem"+dir](index);)$item=$testItem,index=this.getItemIndex($item);return $item},get totalSelected(){return this.getTotalSelected()},getTotalSelected:function(){return this.$selectedItems.length},addItems:function(items){for(var $items=$(items),i=0;i<$items.length;i++){var item=$items[i],$handle;$.data(item,"select")&&(Garnish.log("Element was added to more than one selector"),$.data(item,"select").removeItems(item)),$.data(item,"select",this),this.settings.handle?"object"==typeof this.settings.handle?$handle=$(this.settings.handle):"string"==typeof this.settings.handle?$handle=$(item).find(this.settings.handle):"function"==typeof this.settings.handle&&($handle=$(this.settings.handle(item))):$handle=$(item),$.data(item,"select-handle",$handle),$handle.data("select-item",item),this.addListener($handle,"mousedown","onMouseDown"),this.addListener($handle,"mouseup","onMouseUp"),this.addListener($handle,"click",(function(){this.ignoreClick=!0})),this.addListener(item,"keydown","onKeyDown")}this.$items=this.$items.add($items),this.updateIndexes()},removeItems:function(items){items=$.makeArray(items);for(var itemsChanged=!1,selectionChanged=!1,i=0;i<items.length;i++){var item=items[i],index=$.inArray(item,this.$items);if(-1!==index){this._deinitItem(item),this.$items.splice(index,1),itemsChanged=!0;var selectedIndex=$.inArray(item,this.$selectedItems);-1!==selectedIndex&&(this.$selectedItems.splice(selectedIndex,1),selectionChanged=!0)}}itemsChanged&&(this.updateIndexes(),selectionChanged&&($(items).removeClass(this.settings.selectedClass),this.onSelectionChange()))},removeAllItems:function(){for(var i=0;i<this.$items.length;i++)this._deinitItem(this.$items[i]);this.$items=$(),this.$selectedItems=$(),this.updateIndexes()},updateIndexes:function(){null!==this.first?(this.first=this.getItemIndex(this.$first),this.setFocusableItem(this.$first)):this.$items.length&&this.setFocusableItem($(this.$items[0])),this.$focusedItem&&(this.setFocusableItem(this.$focusedItem),this.focusItem(this.$focusedItem,!0)),null!==this.last&&(this.last=this.getItemIndex(this.$last))},resetItemOrder:function(){this.$items=$().add(this.$items),this.$selectedItems=$().add(this.$selectedItems),this.updateIndexes()},setFocusableItem:function($item){this.$focusable&&this.$focusable.removeAttr("tabindex"),this.$focusable=$item.attr("tabindex","0")},focusItem:function($item,preventScroll){$item[0].focus({preventScroll:!!preventScroll}),this.$focusedItem=$item,this.trigger("focusItem",{item:$item})},getSelectedItems:function(){return this.$selectedItems},destroy:function(){this.$container.removeData("select"),this.removeAllItems(),this.base()},onMouseDown:function(ev){if(ev.which===Garnish.PRIMARY_CLICK&&(!this.settings.filter||$(ev.target).is(this.settings.filter))){this.mousedownTarget=ev.currentTarget;var $item=$($.data(ev.currentTarget,"select-item"));null!==this.first&&ev.shiftKey?this.selectRange($item,!0):this._actAsCheckbox(ev)&&this.toggleItem($item,!0)}},onMouseUp:function(ev){if(ev.which===Garnish.PRIMARY_CLICK&&(!this.settings.filter||$(ev.target).is(this.settings.filter))){var $item=$($.data(ev.currentTarget,"select-item"));this._actAsCheckbox(ev)||ev.shiftKey||ev.currentTarget!==this.mousedownTarget||(this.isSelected($item)?(this.clearMouseUpTimeout(),this.mouseUpTimeout=setTimeout(function(){this.deselectOthers($item)}.bind(this),300)):(this.deselectAll(),this.selectItem($item,!0,!0)))}},onKeyDown:function(ev){if(ev.target===ev.currentTarget){var ctrlKey=Garnish.isCtrlKeyPressed(ev),shiftKey=ev.shiftKey,anchor,$item;switch(this.settings.checkboxMode&&this.$focusable.length?-1===(anchor=$.inArray(this.$focusable[0],this.$items))&&(anchor=0):anchor=ev.shiftKey?this.last:this.first,ev.keyCode){case Garnish.LEFT_KEY:ev.preventDefault(),$item=null===this.first?Garnish.ltr?this.getLastItem():this.getFirstItem():ctrlKey?this.getFurthestItemToTheLeft(anchor):this.getItemToTheLeft(anchor);break;case Garnish.RIGHT_KEY:ev.preventDefault(),$item=null===this.first?Garnish.ltr?this.getFirstItem():this.getLastItem():ctrlKey?this.getFurthestItemToTheRight(anchor):this.getItemToTheRight(anchor);break;case Garnish.UP_KEY:ev.preventDefault(),null===this.first?(this.$focusable&&($item=this.$focusable.prev()),this.$focusable&&$item.length||($item=this.getLastItem())):($item=ctrlKey?this.getFurthestItemAbove(anchor):this.getItemAbove(anchor))||($item=this.getFirstItem());break;case Garnish.DOWN_KEY:ev.preventDefault(),null===this.first?(this.$focusable&&($item=this.$focusable.next()),this.$focusable&&$item.length||($item=this.getFirstItem())):($item=ctrlKey?this.getFurthestItemBelow(anchor):this.getItemBelow(anchor))||($item=this.getLastItem());break;case Garnish.SPACE_KEY:ctrlKey||shiftKey||(ev.preventDefault(),this.isSelected(this.$focusable)?this._canDeselect(this.$focusable)&&this.deselectItem(this.$focusable):this.selectItem(this.$focusable,!0,!1));break;case Garnish.A_KEY:ctrlKey&&(ev.preventDefault(),this.selectAll())}$item&&$item.length&&(this.settings.checkboxMode?(this.setFocusableItem($item),$item.focus(),this.$focusedItem=$item,this.trigger("focusItem",{item:$item})):null!==this.first&&ev.shiftKey?this.selectRange($item,!1):(this.deselectAll(),this.selectItem($item,!0,!1)))}},onSelectionChange:function(){this.callbackFrame&&(Garnish.cancelAnimationFrame(this.callbackFrame),this.callbackFrame=null),this.callbackFrame=Garnish.requestAnimationFrame(function(){this.callbackFrame=null,this.trigger("selectionChange"),this.settings.onSelectionChange()}.bind(this))},_actAsCheckbox:function(ev){return Garnish.isCtrlKeyPressed(ev)?!this.settings.checkboxMode:this.settings.checkboxMode},_canDeselect:function($items){return this.settings.allowEmpty||this.totalSelected>$items.length},_selectItems:function($items){$items.addClass(this.settings.selectedClass),this.$selectedItems=this.$selectedItems.add($items),this.onSelectionChange()},_deselectItems:function($items){$items.removeClass(this.settings.selectedClass),this.$selectedItems=this.$selectedItems.not($items),this.onSelectionChange()},_deinitItem:function(item){var $handle=$.data(item,"select-handle");$handle&&($handle.removeData("select-item"),this.removeAllListeners($handle)),$.removeData(item,"select"),$.removeData(item,"select-handle"),this.$focusedItem&&this.$focusedItem[0]===item&&(this.$focusedItem=null)}},{defaults:{selectedClass:"sel",multi:!1,allowEmpty:!0,vertical:!1,horizontal:!1,handle:null,filter:null,checkboxMode:!1,onSelectionChange:$.noop},closestItemAxisProps:{x:{midpointOffset:"top",midpointSizeFunc:"outerHeight",rowOffset:"left"},y:{midpointOffset:"left",midpointSizeFunc:"outerWidth",rowOffset:"top"}},closestItemDirectionProps:{"<":{step:-1,isNextRow:function(a,b){return a<b},isWrongDirection:function(a,b){return a>b}},">":{step:1,isNextRow:function(a,b){return a>b},isWrongDirection:function(a,b){return a<b}}}}),Garnish.SelectMenu=Garnish.CustomSelect.extend({init:function(btn,options,settings,callback){"function"==typeof settings&&(callback=settings,settings={}),settings=$.extend({},Garnish.SelectMenu.defaults,settings),this.base(btn,options,settings,callback),this.selected=-1},build:function(){this.base(),-1!==this.selected&&this._addSelectedOptionClass(this.selected)},select:function(option){option!==this.selected&&(this.dom.ul&&(-1!==this.selected&&(this.dom.options[this.selected].className=""),this._addSelectedOptionClass(option)),this.selected=option,this.setBtnText($(this.options[option].label).text()),this.base(option))},_addSelectedOptionClass:function(option){this.dom.options[option].className="sel"},setBtnText:function(text){this.dom.$btnLabel.text(text)}},{defaults:{ulClass:"menu select"}}),Garnish.ShortcutManager=Garnish.Base.extend({shortcuts:null,layer:0,init:function(){this.shortcuts=[[]],this.addListener(Garnish.$bod,"keydown","triggerShortcut")},addLayer:function(){return this.layer++,this.shortcuts.push([]),this},removeLayer:function(){if(0===this.layer)throw"Cant remove the base layer.";return this.layer--,this.shortcuts.pop(),this},registerShortcut:function(shortcut,callback,layer){return shortcut=this._normalizeShortcut(shortcut),void 0===layer&&(layer=this.layer),this.shortcuts[layer].push({key:JSON.stringify(shortcut),shortcut:shortcut,callback:callback}),this},unregisterShortcut:function(shortcut,layer){shortcut=this._normalizeShortcut(shortcut);var key=JSON.stringify(shortcut);void 0===layer&&(layer=this.layer);for(var i=0;i<this.shortcuts[layer].length;i++)if(this.shortcuts[layer][i].key===key){this.shortcuts[layer].splice(i,1);break}return this},_normalizeShortcut:function(shortcut){if("number"==typeof shortcut&&(shortcut={keyCode:shortcut}),"number"!=typeof shortcut.keyCode)throw"Invalid shortcut";return{keyCode:shortcut.keyCode,ctrl:!!shortcut.ctrl,shift:!!shortcut.shift,alt:!!shortcut.alt}},triggerShortcut:function(ev){for(var shortcut,i=0;i<this.shortcuts[this.layer].length;i++)if((shortcut=this.shortcuts[this.layer][i].shortcut).keyCode===ev.keyCode&&shortcut.ctrl===Garnish.isCtrlKeyPressed(ev)&&shortcut.shift===ev.shiftKey&&shortcut.alt===ev.altKey){ev.preventDefault(),this.shortcuts[this.layer][i].callback(ev);break}}}),Garnish.shortcutManager=new Garnish.ShortcutManager}(jQuery);