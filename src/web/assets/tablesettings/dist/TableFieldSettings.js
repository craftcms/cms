!function(t){Craft.TableFieldSettings=Garnish.Base.extend({columnsTableName:null,defaultsTableName:null,columnsData:null,columnsTableId:null,defaultsTableId:null,columnsTableInputPath:null,defaultsTableInputPath:null,defaults:null,columnSettings:null,dropdownSettingsHtml:null,dropdownSettingsCols:null,columnsTable:null,defaultsTable:null,init:function(t,e,s,i,a,n,l){this.columnsTableName=t,this.defaultsTableName=e,this.columnsData=s,this.columnsTableId=Craft.formatInputId(this.columnsTableName),this.defaultsTableId=Craft.formatInputId(this.defaultsTableName),this.columnsTableInputPath=Craft.filterArray(this.columnsTableName.split(/[\[\]]+/)),this.defaultsTableInputPath=Craft.filterArray(this.defaultsTableName.split(/[\[\]]+/)),this.defaults=i,this.columnSettings=a,this.dropdownSettingsHtml=n,this.dropdownSettingsCols=l,this.initColumnsTable(),this.initDefaultsTable()},initColumnsTable:function(){this.columnsTable=new e(this,this.columnsTableId,this.columnsTableName,this.columnSettings,{rowIdPrefix:"col",defaultValues:{type:"singleline"},allowAdd:!0,allowReorder:!0,allowDelete:!0,lazyInitRows:!1,onAddRow:this.onAddColumn.bind(this),onDeleteRow:this.reconstructDefaultsTable.bind(this)})},initDefaultsTable:function(){this.defaultsTable=new Craft.EditableTable(this.defaultsTableId,this.defaultsTableName,this.columnsData,{rowIdPrefix:"row",allowAdd:!0,allowReorder:!0,allowDelete:!0})},onAddColumn:function(t){this.reconstructDefaultsTable(),this.initColumnSettingInputs(t)},initColumnSettingInputs:function(t){var e=t.find("td:first-child textarea, td:nth-child(3) textarea");this.addListener(e,"input","reconstructDefaultsTable")},reconstructDefaultsTable:function(){this.columnsData=Craft.expandPostArray(Garnish.getPostData(this.columnsTable.$tbody));var e=Craft.expandPostArray(Garnish.getPostData(this.defaultsTable.$tbody));if(!Object.keys(this.columnsData).length){for(var s=this.defaultsTable.$tbody.children(),i=0;i<s.length;i++)this.defaultsTable.deleteRow(this.defaultsTable.createRowObj(s[i]));return this.defaultsTable.$addRowBtn.css("opacity","0.2"),void this.defaultsTable.$addRowBtn.css("pointer-events","none")}for(var a=0;a<this.columnsTableInputPath.length;a++){var n=this.columnsTableInputPath[a];void 0!==this.columnsData[n]&&(this.columnsData=this.columnsData[n])}for(var l in this.columnsData)if(this.columnsData.hasOwnProperty(l))switch(this.columnsData[l].type){case"select":var o=this.columnsTable.getRowObj(this.columnsTable.$tbody.find('tr[data-id="'.concat(l,'"]')));this.columnsData[l].options=o.options||[];break;case"heading":this.columnsData[l].type="singleline",this.columnsData[l].class="heading"}for(var d=0;d<this.defaultsTableInputPath.length;d++){var h=this.defaultsTableInputPath[d];if(void 0===e[h]){e={};break}e=e[h]}var u=t("<table/>",{id:this.defaultsTableId,class:"editable fullwidth"});if(Object.values(this.columnsData).some((function(t){return""!==t.heading}))){var r="";for(var c in this.columnsData)this.columnsData.hasOwnProperty(c)&&(r+='<th scope="col">'+(this.columnsData[c].heading?Craft.escapeHtml(this.columnsData[c].heading):"&nbsp;")+"</th>");""!==r&&(r+='<th colspan="2"></th>',u.append("<thead><tr>".concat(r,"</tr></thead>")))}var f=t("<tbody/>").appendTo(u);for(var b in e)e.hasOwnProperty(b)&&Craft.EditableTable.createRow(b,this.columnsData,this.defaultsTableName,e[b],!0,!0).appendTo(f);this.defaultsTable.$table.replaceWith(u),this.defaultsTable.destroy(),delete this.defaultsTable,this.initDefaultsTable()}});var e=Craft.EditableTable.extend({fieldSettings:null,init:function(t,e,s,i,a){this.fieldSettings=t,this.base(e,s,i,a)},initialize:function(){return!!this.base()&&(this.fieldSettings.initColumnSettingInputs(this.$tbody),this.sorter.settings.onSortChange=this.fieldSettings.reconstructDefaultsTable.bind(this.fieldSettings),!0)},createRowObj:function(t){return new e.Row(this,t)}});e.Row=Craft.EditableTable.Row.extend({$typeSelect:null,$settingsBtn:null,options:null,settingsModal:null,optionsTable:null,init:function(e,s){this.base(e,s),this.table.fieldSettings.columnsData[this.id]&&(this.options=this.table.fieldSettings.columnsData[this.id].options||null);var i=this.$tr.find("td:nth-child(4)"),a=i.find(".select");this.$settingsBtn=i.find(".settings"),this.$settingsBtn.length||(this.$settingsBtn=t("<button/>",{class:"settings light invisible",type:"button","data-icon":"settings"}),t("<div/>",{class:"flex flex-nowrap"}).appendTo(i).append(a).append(this.$settingsBtn)),this.$typeSelect=a.find("select"),this.addListener(this.$typeSelect,"change","handleTypeChange"),this.addListener(this.$settingsBtn,"click","showSettingsModal"),this.addListener(this.$tr.closest("form"),"submit","handleFormSubmit")},handleTypeChange:function(){"select"===this.$typeSelect.val()?this.$settingsBtn.removeClass("invisible"):this.$settingsBtn.addClass("invisible"),this.table.fieldSettings.reconstructDefaultsTable()},showSettingsModal:function(e){var s=this;if(this.settingsModal)this.settingsModal.show();else{var i="dropdownsettingsmodal"+Math.floor(1e6*Math.random()),a=t("<div/>",{class:"modal dropdownsettingsmodal"}).appendTo(Garnish.$bod),n=t("<div/>",{class:"body"}).appendTo(a).html(this.table.fieldSettings.dropdownSettingsHtml.replace(/__ID__/g,i));if(this.optionsTable=new Craft.EditableTable(i,"__NAME__",this.table.fieldSettings.dropdownSettingsCols,{allowAdd:!0,allowDelete:!0,allowReorder:!0,onAddRow:this.handleOptionsRowChange.bind(this),onDeleteRow:this.handleOptionsRowChange.bind(this)}),this.options&&this.options.length)for(var l=0;l<this.options.length;l++){var o=this.optionsTable.addRow(!1);o.$tr.find(".option-label textarea").val(this.options[l].label),o.$tr.find(".option-value textarea").val(this.options[l].value),o.$tr.find('.option-default input[type="checkbox"]').prop("checked",!!this.options[l].default)}else this.optionsTable.addRow(!1);var d=t("<button/>",{type:"button",class:"btn submit",text:Craft.t("app","Done")}).appendTo(n);this.settingsModal=new Garnish.Modal(a,{onHide:this.handleSettingsModalHide.bind(this)}),this.addListener(d,"click",(function(){this.settingsModal.hide()}))}setTimeout((function(){s.optionsTable.$tbody.find("textarea").first().focus()}),100)},handleOptionsRowChange:function(){this.settingsModal&&this.settingsModal.updateSizeAndPosition()},handleSettingsModalHide:function(){this.options=[];for(var t=this.optionsTable.$table.find("tbody tr"),e=0;e<t.length;e++){var s=t.eq(e);this.options.push({label:s.find(".option-label textarea").val(),value:s.find(".option-value textarea").val(),default:s.find(".option-default input[type=checkbox]").prop("checked")})}this.table.fieldSettings.reconstructDefaultsTable()},handleFormSubmit:function(e){"select"===this.$typeSelect.val()&&t("<input/>",{type:"hidden",name:this.table.fieldSettings.columnsTableName+"["+this.id+"][options]",value:JSON.stringify(this.options)}).appendTo(e.currentTarget)}})}(jQuery);
//# sourceMappingURL=TableFieldSettings.js.map