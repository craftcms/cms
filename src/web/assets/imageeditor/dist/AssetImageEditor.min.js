Craft.AssetImageEditor=Garnish.Modal.extend({$body:null,$footer:null,$imageTools:null,$buttons:null,$cancelBtn:null,$replaceBtn:null,$saveBtn:null,$editorContainer:null,$straighten:null,$croppingCanvas:null,$spinnerCanvas:null,canvas:null,image:null,viewport:null,focalPoint:null,grid:null,croppingCanvas:null,clipper:null,croppingRectangle:null,cropperHandles:null,cropperGrid:null,croppingShade:null,imageStraightenAngle:0,viewportRotation:0,originalWidth:0,originalHeight:0,imageVerticeCoords:null,zoomRatio:1,animationInProgress:!1,currentView:"",assetId:null,cacheBust:null,draggingCropper:!1,scalingCropper:!1,draggingFocal:!1,previousMouseX:0,previousMouseY:0,shiftKeyHeld:!1,editorHeight:0,editorWidth:0,cropperState:!1,scaleFactor:1,flipData:{},focalPointState:!1,croppingConstraint:!1,spinnerInterval:null,maxImageSize:null,lastLoadedDimensions:null,imageIsLoading:!1,renderImage:null,renderCropper:null,init:function(t,i){this.cacheBust=Date.now(),this.setSettings(i,Craft.AssetImageEditor.defaults),this.assetId=t,this.flipData={x:0,y:0},this.$container=$('<form class="modal fitted imageeditor"></form>').appendTo(Garnish.$bod),this.$body=$('<div class="body"></div>').appendTo(this.$container),this.$footer=$('<div class="footer"/>').appendTo(this.$container),this.base(this.$container,this.settings),this.$buttons=$('<div class="buttons right"/>').appendTo(this.$footer),this.$cancelBtn=$('<div class="btn cancel">'+Craft.t("app","Cancel")+"</div>").appendTo(this.$buttons),this.$replaceBtn=$('<div class="btn submit save replace">'+Craft.t("app","Replace Asset")+"</div>").appendTo(this.$buttons),this.settings.allowSavingAsNew&&(this.$saveBtn=$('<div class="btn submit save copy">'+Craft.t("app","Save as New Asset")+"</div>").appendTo(this.$buttons),this.addListener(this.$saveBtn,"activate",this.saveImage.bind(this))),this.addListener(this.$replaceBtn,"activate",this.saveImage.bind(this)),this.addListener(this.$cancelBtn,"activate",$.proxy(this,"hide")),this.removeListener(this.$shade,"click"),this.maxImageSize=this.getMaxImageSize(),Craft.postActionRequest("assets/image-editor",{assetId:t},$.proxy(this,"loadEditor"))},getMaxImageSize:function(){var t=Garnish.$doc.get(0).documentElement.clientWidth,i=Garnish.$doc.get(0).documentElement.clientHeight;return Math.max(i,t)*(window.devicePixelRatio>1?2:1)},loadEditor:function(t){t.html||alert(Craft.t("Could not load the Asset image editor.","app")),this.$body.html(t.html),this.$tabs=$(".tabs li",this.$body),this.$viewsContainer=$(".views",this.$body),this.$views=$("> div",this.$viewsContainer),this.$imageTools=$(".image-container .image-tools",this.$body),this.$editorContainer=$(".image-container .image",this.$body),this.editorHeight=this.$editorContainer.innerHeight(),this.editorWidth=this.$editorContainer.innerWidth(),this._showSpinner(),this.updateSizeAndPosition(),this.canvas=new fabric.StaticCanvas("image-canvas"),this.$croppingCanvas=$("#cropping-canvas",this.$editorContainer),this.$croppingCanvas.width(this.editorWidth),this.$croppingCanvas.height(this.editorHeight),this.canvas.enableRetinaScaling=!0,this.renderImage=function(){Garnish.requestAnimationFrame(this.canvas.renderAll.bind(this.canvas))}.bind(this);var i=Craft.getActionUrl("assets/edit-image",{assetId:this.assetId,size:this.maxImageSize,cacheBust:this.cacheBust});fabric.Image.fromURL(i,$.proxy(function(i){this.image=i,this.image.set({originX:"center",originY:"center",left:this.editorWidth/2,top:this.editorHeight/2}),this.canvas.add(this.image),this.originalHeight=this.image.getHeight(),this.originalWidth=this.image.getWidth(),this.zoomRatio=1,this.lastLoadedDimensions=this.getScaledImageDimensions(),this._setFittedImageVerticeCoordinates(),this._repositionEditorElements();var e={imageDimensions:this.getScaledImageDimensions(),offsetX:0,offsetY:0},s=!1;if(t.focalPoint){var h=t.focalPoint,o=e.imageDimensions.width*h.x,a=e.imageDimensions.height*h.y;e.offsetX=o-e.imageDimensions.width/2,e.offsetY=a-e.imageDimensions.height/2,s=!0}this.storeFocalPointState(e),s&&this._createFocalPoint(),this._createViewport(),this.storeCropperState(),this._addControlListeners(),this.addListener(this.$croppingCanvas,"mousemove",this._handleMouseMove.bind(this)),this.addListener(this.$croppingCanvas,"mousedown",this._handleMouseDown.bind(this)),this.addListener(this.$croppingCanvas,"mouseup",this._handleMouseUp.bind(this)),this.addListener(this.$croppingCanvas,"mouseout",function(t){this._handleMouseUp(t),this._handleMouseMove(t)}.bind(this)),this._hideSpinner(),this.renderImage(),this.$tabs.first().trigger("click")},this))},_reloadImage:function(){if(!this.imageIsLoading){this.imageIsLoading=!0,this.maxImageSize=this.getMaxImageSize();var t=Craft.getActionUrl("assets/edit-image",{assetId:this.assetId,size:this.maxImageSize,cacheBust:this.cacheBust});this.image.setSrc(t,function(t){this.originalHeight=t.getHeight(),this.originalWidth=t.getWidth(),this.lastLoadedDimensions={width:this.originalHeight,height:this.originalWidth},this.updateSizeAndPosition(),this.renderImage(),this.imageIsLoading=!1}.bind(this))}},updateSizeAndPosition:function(){if(this.$container){var t=window.innerWidth,i=window.innerHeight;this.$container.css({width:t,"min-width":t,left:0,height:i,"min-height":i,top:0}),this.$body.css({height:i-58}),t<i?this.$container.addClass("vertical"):this.$container.removeClass("vertical"),this.$spinnerCanvas&&this.$spinnerCanvas.css({left:this.$spinnerCanvas.parent().width()/2-this.$spinnerCanvas.width()/2+"px",top:this.$spinnerCanvas.parent().height()/2-this.$spinnerCanvas.height()/2+"px"}),this.$editorContainer&&this.image&&this._repositionEditorElements()}},_repositionEditorElements:function(){var t={width:this.editorWidth,height:this.editorHeight};this.editorHeight=this.$editorContainer.innerHeight(),this.editorWidth=this.$editorContainer.innerWidth(),this.canvas.setDimensions({width:this.editorWidth,height:this.editorHeight});var i=this.getScaledImageDimensions();if("crop"===this.currentView){this.zoomRatio=this.getZoomToFitRatio(this.getScaledImageDimensions());var e=this._getBoundingRectangle(this.imageVerticeCoords);this._setFittedImageVerticeCoordinates(),this._repositionCropper(e)}else this.zoomRatio=this.getZoomToCoverRatio(this.getScaledImageDimensions())*this.scaleFactor;this._repositionImage(t),this._repositionViewport(),this._repositionFocalPoint(t),this._zoomImage(),this.renderImage(),(i.width/this.lastLoadedDimensions.width>1.5||i.height/this.lastLoadedDimensions.height>1.5)&&this._reloadImage()},_repositionImage:function(t){this.image.set({left:this.image.left-(t.width-this.editorWidth)/2,top:this.image.top-(t.height-this.editorHeight)/2})},_createViewport:function(){this.viewport=new fabric.Rect({width:this.image.width,height:this.image.height,fill:"rgba(127,0,0,1)",originX:"center",originY:"center",globalCompositeOperation:"destination-in",left:this.image.left,top:this.image.top}),this.canvas.add(this.viewport),this.renderImage()},_createFocalPoint:function(){var t=this.focalPointState,i=this.getScaledImageDimensions().width/t.imageDimensions.width,e=t.offsetX*i*this.zoomRatio*this.scaleFactor,s=t.offsetY*i*this.zoomRatio*this.scaleFactor;e+=this.image.left,s+=this.image.top;var h=0,o=0;this.viewport&&0===t.offsetX&&0===t.offsetY&&("crop"!==this.currentView?(h=this.viewport.left-this.image.left,o=this.viewport.top-this.image.top):(h=this.clipper.left-this.image.left,o=this.clipper.top-this.image.top),e+=h,s+=o,t.offsetX+=h/(i*this.zoomRatio*this.scaleFactor),t.offsetY+=o/(i*this.zoomRatio*this.scaleFactor)),this.focalPoint=new fabric.Group([new fabric.Circle({radius:8,fill:"rgba(0,0,0,0.5)",strokeWidth:2,stroke:"rgba(255,255,255,0.8)",left:0,top:0,originX:"center",originY:"center"}),new fabric.Circle({radius:1,fill:"rgba(255,255,255,0)",strokeWidth:2,stroke:"rgba(255,255,255,0.8)",left:0,top:0,originX:"center",originY:"center"})],{originX:"center",originY:"center",left:e,top:s}),this.storeFocalPointState(t),this.canvas.add(this.focalPoint)},toggleFocalPoint:function(){this.focalPoint?(this.canvas.remove(this.focalPoint),this.focalPoint=null):this._createFocalPoint(),this.renderImage()},_repositionViewport:function(){if(this.viewport){var t={left:this.editorWidth/2,top:this.editorHeight/2};if("crop"===this.currentView)t.width=this.editorWidth,t.height=this.editorHeight;else if(this.cropperState){var i=this.cropperState,e=this.getScaledImageDimensions().width/i.imageDimensions.width;t.width=i.width*e*this.zoomRatio,t.height=i.height*e*this.zoomRatio,this.image.set({left:this.editorWidth/2-i.offsetX*e,top:this.editorHeight/2-i.offsetY*e})}else $.extend(t,this.getScaledImageDimensions());this.viewport.set(t)}},_repositionFocalPoint:function(t){if(this.focalPoint){var i=this.focalPoint.left-this.editorWidth/2,e=this.focalPoint.top-this.editorHeight/2,s=this.image.width,h=this.getScaledImageDimensions().width*this.zoomRatio/s/this.scaleFactor;i-=(t.width-this.editorWidth)/2,e-=(t.height-this.editorHeight)/2,i*=h,e*=h,this.focalPoint.set({left:this.editorWidth/2+i,top:this.editorHeight/2+e})}},hasOrientationChanged:function(){return this.viewportRotation%180!=0},getScaledImageDimensions:function(){var t={};return this.originalHeight/this.originalWidth>this.editorHeight/this.editorWidth?(t.height=Math.min(this.editorHeight,this.originalHeight),t.width=Math.round(this.originalWidth/(this.originalHeight/t.height))):(t.width=Math.min(this.editorWidth,this.originalWidth),t.height=Math.round(this.originalHeight*(t.width/this.originalWidth))),t},_zoomImage:function(){var t=this.getScaledImageDimensions();this.image.set({width:t.width*this.zoomRatio,height:t.height*this.zoomRatio})},_addControlListeners:function(){this.addListener(this.$tabs,"click","_handleTabClick"),this.addListener($(".focal-point"),"click",function(t){this.toggleFocalPoint(t)}.bind(this)),this.addListener($(".rotate-left"),"click",function(){this.rotateImage(-90)}.bind(this)),this.addListener($(".rotate-right"),"click",function(){this.rotateImage(90)}.bind(this)),this.addListener($(".flip-vertical"),"click",function(){this.flipImage("y")}.bind(this)),this.addListener($(".flip-horizontal"),"click",function(){this.flipImage("x")}.bind(this)),this.straighteningInput=new SlideRuleInput("slide-rule",{onStart:function(){this._showGrid()}.bind(this),onChange:function(t){this.straighten(t)}.bind(this),onEnd:function(){this._hideGrid(),this._cleanupFocalPointAfterStraighten()}.bind(this)}),this.addListener(Garnish.$doc,"keydown",function(t){t.keyCode===Garnish.SHIFT_KEY&&(this.shiftKeyHeld=!0)}.bind(this)),this.addListener(Garnish.$doc,"keyup",function(t){t.keyCode===Garnish.SHIFT_KEY&&(this.shiftKeyHeld=!1)}.bind(this)),new Garnish.MenuBtn($(".crop .menubtn",this.$container),{onOptionSelect:function(t){$(".constraint",this.$container).html($(t).html()),this.setCroppingConstraint($(t).data("constraint")),this.enforceCroppingConstraint()}.bind(this)}).menu.$container.addClass("dark")},_handleTabClick:function(t){if(!this.animationInProgress){var i=$(t.currentTarget),e=i.data("view");this.$tabs.removeClass("selected"),i.addClass("selected"),this.showView(e)}},showView:function(t){this.currentView!==t&&(this.$views.addClass("hidden"),this.$views.filter('[data-view="'+t+'"]').removeClass("hidden"),"rotate"===t?this.enableSlider():this.disableSlider(),this.updateSizeAndPosition(),"crop"===this.currentView&&"crop"!==t?this.disableCropMode():"crop"!==this.currentView&&"crop"===t&&this.enableCropMode(),this.currentView=t)},storeCropperState:function(t){if(t)this.cropperState=t;else if(this.clipper){var i=1/this.zoomRatio;this.cropperState={offsetX:(this.clipper.left-this.image.left)*i,offsetY:(this.clipper.top-this.image.top)*i,height:this.clipper.height*i,width:this.clipper.width*i,imageDimensions:this.getScaledImageDimensions()}}else{var e=this.getScaledImageDimensions();this.cropperState={offsetX:0,offsetY:0,height:e.height,width:e.width,imageDimensions:e}}},storeFocalPointState:function(t){if(t)this.focalPointState=t;else if(this.focalPoint){var i=1/this.zoomRatio;this.focalPointState={offsetX:(this.focalPoint.left-this.image.left)*i/this.scaleFactor,offsetY:(this.focalPoint.top-this.image.top)*i/this.scaleFactor,imageDimensions:this.getScaledImageDimensions()}}},rotateImage:function(t){if(!this.animationInProgress){if(90!==t&&-90!==t)return!1;this.animationInProgress=!0,this.viewportRotation+=t,this.viewportRotation=parseInt((this.viewportRotation+360)%360,10);var i,e=this.image.angle+t,s=this.getScaledImageDimensions();i=this.hasOrientationChanged()?this.getZoomToCoverRatio({height:s.width,width:s.height}):this.getZoomToCoverRatio(s),this.zoomRatio>i&&(i=this.zoomRatio);var h={angle:90===t?"+=90":"-=90"},o={angle:e,width:s.width*i,height:s.height*i},a=1;this.scaleFactor<1?(a=1/this.scaleFactor,this.scaleFactor=1):(this.viewport.width>this.editorHeight?a=this.editorHeight/this.viewport.width:this.viewport.height>this.editorWidth&&(a=this.editorWidth/this.viewport.height),this.scaleFactor=a),a<1&&(o.width*=a,o.height*=a);var n=this.cropperState,r=n.offsetX,p=n.offsetY,c=t*(Math.PI/180),g=r*Math.cos(c)-p*Math.sin(c),l=r*Math.sin(c)+p*Math.cos(c),d=s.width/n.imageDimensions.width,f=g*d*this.zoomRatio*this.scaleFactor,m=l*d*this.zoomRatio*this.scaleFactor;o.left=this.editorWidth/2-f,o.top=this.editorHeight/2-m,n.offsetX=g,n.offsetY=l;var u=n.width;n.width=n.height,n.height=u,this.storeCropperState(n),this.focalPoint&&this.canvas.remove(this.focalPoint),this.viewport.animate(h,{duration:this.settings.animationDuration,onComplete:function(){var t=this.viewport.height*a;this.viewport.height=this.viewport.width*a,this.viewport.width=t,this.viewport.set({angle:0})}.bind(this)}),this.image.animate(o,{onChange:this.canvas.renderAll.bind(this.canvas),duration:this.settings.animationDuration,onComplete:function(){var i=parseFloat((this.image.angle+360)%360);this.image.set({angle:i}),this.animationInProgress=!1,this.focalPoint?(this._adjustFocalPointByAngle(t),this.straighten(this.straighteningInput),this.canvas.add(this.focalPoint)):this._resetFocalPointPosition()}.bind(this)})}},flipImage:function(t){if(!this.animationInProgress){this.animationInProgress=!0,this.hasOrientationChanged()&&(t="y"===t?"x":"y"),this.focalPoint?this.canvas.remove(this.focalPoint):this._resetFocalPointPosition();var i={x:this.editorWidth/2,y:this.editorHeight/2};this.straighteningInput.setValue(-this.imageStraightenAngle),this.imageStraightenAngle=-this.imageStraightenAngle;var e,s,h={angle:this.viewportRotation+this.imageStraightenAngle},o=this.cropperState,a=this.focalPointState;"y"===t&&this.hasOrientationChanged()||"y"!==t&&!this.hasOrientationChanged()?(o.offsetX=-o.offsetX,a.offsetX=-a.offsetX,s=this.image.left-i.x,h.left=i.x-s):(o.offsetY=-o.offsetY,a.offsetY=-a.offsetY,e=this.image.top-i.y,h.top=i.y-e),"y"===t?(h.scaleY=-1*this.image.scaleY,this.flipData.y=1-this.flipData.y):(h.scaleX=-1*this.image.scaleX,this.flipData.x=1-this.flipData.x),this.storeCropperState(o),this.storeFocalPointState(a),this.image.animate(h,{onChange:this.canvas.renderAll.bind(this.canvas),duration:this.settings.animationDuration,onComplete:function(){this.animationInProgress=!1,this.focalPoint&&(this._adjustFocalPointByAngle(0),this.canvas.add(this.focalPoint))}.bind(this)})}},straighten:function(t){if(!this.animationInProgress){this.animationInProgress=!0;var i=this.image.angle;this.imageStraightenAngle=(this.settings.allowDegreeFractions?parseFloat(t.value):Math.round(parseFloat(t.value)))%360,this.image.set({angle:this.viewportRotation+this.imageStraightenAngle}),this.zoomRatio=this.getZoomToCoverRatio(this.getScaledImageDimensions())*this.scaleFactor,this._zoomImage(),this.cropperState&&this._adjustEditorElementsOnStraighten(i),this.renderImage(),this.animationInProgress=!1}},_adjustEditorElementsOnStraighten:function(t){var i,e,s,h,o,a=this.getScaledImageDimensions(),n=this.image.angle-t,r=this.cropperState,p=this.zoomRatio,c=1;do{var g=r.offsetX,l=r.offsetY,d=n*(Math.PI/180);s=g*Math.cos(d)-l*Math.sin(d),h=g*Math.sin(d)+l*Math.cos(d),i=s*p*(o=a.width/r.imageDimensions.width),e=h*p*o;var f=this.getImageVerticeCoords(p),m={width:this.viewport.width,height:this.viewport.height,left:this.editorWidth/2-this.viewport.width/2+i,top:this.editorHeight/2-this.viewport.height/2+e};p*=c=this._getZoomRatioToFitRectangle(m,f)}while(1!==c);this.image.set({left:this.editorWidth/2-i,top:this.editorHeight/2-e}),r.offsetX=s,r.offsetY=h,r.width=this.viewport.width/p/o,r.height=this.viewport.height/p/o,this.storeCropperState(r),this.zoomRatio=p,this.focalPoint?(this._adjustFocalPointByAngle(n),this._isCenterInside(this.focalPoint,this.viewport)?this.focalPoint.set({opacity:1}):this.focalPoint.set({opacity:0})):0!==n&&this._resetFocalPointPosition(),this._zoomImage()},_cleanupFocalPointAfterStraighten:function(){if(this.focalPoint&&!this._isCenterInside(this.focalPoint,this.viewport)){this.focalPoint.set({opacity:1});var t=this.focalPointState;t.offsetX=0,t.offsetY=0,this.storeFocalPointState(t),this.toggleFocalPoint()}},_resetFocalPointPosition:function(){var t=this.focalPointState;t.offsetX=0,t.offsetY=0,this.storeFocalPointState(t)},_isCenterInside:function(t,i){return t.left>i.left-i.width/2&&t.top>i.top-i.height/2&&t.left<i.left+i.width/2&&t.top<i.top+i.height/2},_adjustFocalPointByAngle:function(t){var i=t*(Math.PI/180),e=this.focalPointState,s=e.offsetX,h=e.offsetY,o=s*Math.cos(i)-h*Math.sin(i),a=s*Math.sin(i)+h*Math.cos(i),n=this.getScaledImageDimensions().width/e.imageDimensions.width,r=o*n*this.zoomRatio,p=a*n*this.zoomRatio;this.focalPoint.left=this.image.left+r,this.focalPoint.top=this.image.top+p,e.offsetX=o,e.offsetY=a,this.storeFocalPointState(e)},_getZoomRatioToFitRectangle:function(t,i){for(var e,s=this._getRectangleVertices(t),h=0;h<s.length&&(e=s[h],this.arePointsInsideRectangle([e],i));h++)e=!1;var o;if(e){var a=this._getEdgeCrossed(i,e),n={x:t.left+t.width/2,y:t.top+t.height/2},r=Math.abs((a[1].y-a[0].y)*e.x-(a[1].x-a[0].x)*e.y+a[1].x*a[0].y-a[1].y*a[0].x)/Math.sqrt(Math.pow(a[1].y-a[0].y,2)+Math.pow(a[1].x-a[0].x,2)),p=Math.abs((a[1].y-a[0].y)*n.x-(a[1].x-a[0].x)*n.y+a[1].x*a[0].y-a[1].y*a[0].x)/Math.sqrt(Math.pow(a[1].y-a[0].y,2)+Math.pow(a[1].x-a[0].x,2));o=(r+p)/p}else o=1;return o},saveImage:function(t){var i=$(t.currentTarget);if(i.hasClass("disabled"))return!1;$(".btn",this.$buttons).addClass("disabled"),this.$buttons.append('<div class="spinner"></div>');var e={assetId:this.assetId,viewportRotation:this.viewportRotation,imageRotation:this.imageStraightenAngle,replace:i.hasClass("replace")?1:0};if(this.cropperState){var s={};s.height=this.cropperState.height,s.width=this.cropperState.width,s.offsetX=this.cropperState.offsetX,s.offsetY=this.cropperState.offsetY,e.imageDimensions=this.cropperState.imageDimensions,e.cropData=s}else e.imageDimensions=this.getScaledImageDimensions();this.focalPoint&&(e.focalPoint=this.focalPointState),e.flipData=this.flipData,e.zoom=this.zoomRatio,Craft.postActionRequest("assets/save-image",e,function(t){this.$buttons.find(".btn").removeClass("disabled").end().find(".spinner").remove(),t.error?alert(t.error):(this.onSave(),this.hide())}.bind(this))},getZoomToCoverRatio:function(t){var i=Math.abs(this.imageStraightenAngle)*(Math.PI/180),e=Math.sin(i)*t.height+Math.cos(i)*t.width,s=Math.sin(i)*t.width+Math.cos(i)*t.height;return Math.max(e/t.width,s/t.height)},getZoomToFitRatio:function(t){var i=this._getImageBoundingBox(t),e=1;if(i.height>this.editorHeight||i.width>this.editorWidth){var s=this.editorHeight/i.height,h=this.editorWidth/i.width;e=Math.min(h,s)}return e},getCombinedZoomRatio:function(t){return this.getZoomToCoverRatio(t)/this.getZoomToFitRatio(t)},_showGrid:function(){if(!this.grid){var t,i={strokeWidth:1,stroke:"rgba(255,255,255,0.5)"},e=this.viewport.width,s=this.viewport.height,h=e/9,o=s/9,a=[new fabric.Rect({strokeWidth:2,stroke:"rgba(255,255,255,1)",originX:"center",originY:"center",width:e,height:s,left:e/2,top:s/2,fill:"rgba(255,255,255,0)"})];for(t=1;t<=8;t++)a.push(new fabric.Line([t*h,0,t*h,s],i));for(t=1;t<=8;t++)a.push(new fabric.Line([0,t*o,e,t*o],i));this.grid=new fabric.Group(a,{left:this.editorWidth/2,top:this.editorHeight/2,originX:"center",originY:"center",angle:this.viewport.angle}),this.canvas.add(this.grid),this.renderImage()}},_hideGrid:function(){this.canvas.remove(this.grid),this.grid=null,this.renderImage()},onFadeOut:function(){this.removeListener(this.$croppingCanvas,"mousemove",this._handleMouseMove.bind(this)),this.removeListener(this.$croppingCanvas,"mousedown",this._handleMouseDown.bind(this)),this.removeListener(this.$croppingCanvas,"mouseup",this._handleMouseUp.bind(this)),this.removeListener(this.$croppingCanvas,"mouseout",function(t){this._handleMouseUp(t),this._handleMouseMove(t)}.bind(this)),this.destroy()},show:function(){this.base(),$("html").addClass("noscroll")},hide:function(){this.removeAllListeners(),this.straighteningInput.removeAllListeners(),$("html").removeClass("noscroll"),this.base()},onSave:function(){this.settings.onSave()},enableSlider:function(){this.$imageTools.removeClass("hidden")},disableSlider:function(){this.$imageTools.addClass("hidden")},enableCropMode:function(){var t=this.getScaledImageDimensions();this.zoomRatio=this.getZoomToFitRatio(t);var i={width:this.editorWidth,height:this.editorHeight},e={width:t.width*this.zoomRatio,height:t.height*this.zoomRatio,left:this.editorWidth/2,top:this.editorHeight/2},s=function(){this._setFittedImageVerticeCoordinates();var t=this.cropperState,i=this.getScaledImageDimensions(),e=i.width/t.imageDimensions.width,s={left:this.image.left+t.offsetX*e*this.zoomRatio,top:this.image.top+t.offsetY*e*this.zoomRatio,width:t.width*e*this.zoomRatio,height:t.height*e*this.zoomRatio};this._showCropper(s),this.focalPoint&&(e=i.width/this.focalPointState.imageDimensions.width,this.focalPoint.left=this.image.left+this.focalPointState.offsetX*e*this.zoomRatio,this.focalPoint.top=this.image.top+this.focalPointState.offsetY*e*this.zoomRatio,this.canvas.add(this.focalPoint))}.bind(this);this._editorModeTransition(s,e,i)},disableCropMode:function(){var t={},i={left:this.editorWidth/2,top:this.editorHeight/2};this._hideCropper();var e=this.getZoomToCoverRatio(this.getScaledImageDimensions())*this.scaleFactor,s=e/this.zoomRatio;this.zoomRatio=e;var h=(this.clipper.left-this.image.left)*s,o=(this.clipper.top-this.image.top)*s;i.left=this.editorWidth/2-h,i.top=this.editorHeight/2-o,t.height=this.clipper.height*s,t.width=this.clipper.width*s,(!this.focalPoint||this.focalPoint&&!this._isCenterInside(this.focalPoint,this.clipper))&&(this.focalPoint&&this.toggleFocalPoint(),this._resetFocalPointPosition());var a=function(){if(this.focalPoint){var t=this.getScaledImageDimensions().width/this.focalPointState.imageDimensions.width;this.focalPoint.left=this.image.left+this.focalPointState.offsetX*t*this.zoomRatio,this.focalPoint.top=this.image.top+this.focalPointState.offsetY*t*this.zoomRatio,this.canvas.add(this.focalPoint)}}.bind(this);this._editorModeTransition(a,i,t)},_editorModeTransition:function(t,i,e){this.animationInProgress||(this.animationInProgress=!0,this.focalPoint&&(this.canvas.remove(this.focalPoint),this.renderImage()),this.image.animate(i,{onChange:this.canvas.renderAll.bind(this.canvas),duration:this.settings.animationDuration,onComplete:function(){t(),this.animationInProgress=!1,this.renderImage()}.bind(this)}),this.viewport.animate(e,{duration:this.settings.animationDuration}))},_showSpinner:function(){this.$spinnerCanvas=$('<canvas id="spinner-canvas"></canvas>').appendTo($(".image",this.$container));var t=document.getElementById("spinner-canvas").getContext("2d"),i=new Date,e=t.canvas.width,s=t.canvas.height;this.spinnerInterval=window.setInterval(function(){var h=parseInt((new Date-i)/1e3*16)/16;t.save(),t.clearRect(0,0,e,s),t.translate(e/2,s/2),t.rotate(2*Math.PI*h);for(var o=0;o<16;o++)t.beginPath(),t.rotate(2*Math.PI/16),t.moveTo(e/10,0),t.lineTo(e/4,0),t.lineWidth=e/30,t.strokeStyle="rgba(255,255,255,"+o/16+")",t.stroke();t.restore()},1e3/30)},_hideSpinner:function(){window.clearInterval(this.spinnerInterval),this.$spinnerCanvas.remove(),this.$spinnerCanvas=null},_showCropper:function(t){this._setupCropperLayer(t),this._redrawCropperElements(),this.renderCropper()},_hideCropper:function(){this.clipper&&(this.croppingCanvas.remove(this.clipper),this.croppingCanvas.remove(this.croppingShade),this.croppingCanvas.remove(this.cropperHandles),this.croppingCanvas.remove(this.cropperGrid),this.croppingCanvas.remove(this.croppingRectangle),this.croppingCanvas=null,this.renderCropper=null)},_setupCropperLayer:function(t){this.croppingCanvas=new fabric.StaticCanvas("cropping-canvas",{backgroundColor:"rgba(0,0,0,0)",hoverCursor:"default",selection:!1}),this.croppingCanvas.setDimensions({width:this.editorWidth,height:this.editorHeight}),this.renderCropper=function(){Garnish.requestAnimationFrame(this.croppingCanvas.renderAll.bind(this.croppingCanvas))}.bind(this),$("#cropping-canvas",this.$editorContainer).css({position:"absolute",top:0,left:0}),this.croppingShade=new fabric.Rect({left:this.editorWidth/2,top:this.editorHeight/2,originX:"center",originY:"center",width:this.editorWidth,height:this.editorHeight,fill:"rgba(0,0,0,0.7)"});var i=this.getScaledImageDimensions(),e=0===this.imageStraightenAngle?1:1.2*this.getCombinedZoomRatio(i),s=i.width/e,h=i.height/e;if(this.hasOrientationChanged()){var o=h;h=s,s=o}this.clipper=new fabric.Rect({left:this.editorWidth/2,top:this.editorHeight/2,originX:"center",originY:"center",width:s,height:h,stroke:"black",fill:"rgba(128,0,0,1)",strokeWidth:0}),t&&this.clipper.set(t),this.clipper.globalCompositeOperation="destination-out",this.croppingCanvas.add(this.croppingShade),this.croppingCanvas.add(this.clipper)},_redrawCropperElements:function(){this.cropperHandles&&(this.croppingCanvas.remove(this.cropperHandles),this.croppingCanvas.remove(this.cropperGrid),this.croppingCanvas.remove(this.croppingRectangle));var t={strokeWidth:4,stroke:"rgb(255,255,255)",fill:!1},i={strokeWidth:2,stroke:"rgba(255,255,255,0.5)"},e=[new fabric.Path("M 0,10 L 0,0 L 10,0",t),new fabric.Path("M "+(this.clipper.width-8)+",0 L "+(this.clipper.width+4)+",0 L "+(this.clipper.width+4)+",10",t),new fabric.Path("M "+(this.clipper.width+4)+","+(this.clipper.height-8)+" L"+(this.clipper.width+4)+","+(this.clipper.height+4)+" L "+(this.clipper.width-8)+","+(this.clipper.height+4),t),new fabric.Path("M 10,"+(this.clipper.height+4)+" L 0,"+(this.clipper.height+4)+" L 0,"+(this.clipper.height-8),t)];this.cropperHandles=new fabric.Group(e,{left:this.clipper.left,top:this.clipper.top,originX:"center",originY:"center"}),this.croppingRectangle=new fabric.Rect({left:this.clipper.left,top:this.clipper.top,width:this.clipper.width,height:this.clipper.height,fill:"rgba(0,0,0,0)",stroke:"rgba(255,255,255,0.8)",strokeWidth:2,originX:"center",originY:"center"}),this.cropperGrid=new fabric.Group([new fabric.Line([.33*this.clipper.width,0,.33*this.clipper.width,this.clipper.height],i),new fabric.Line([.66*this.clipper.width,0,.66*this.clipper.width,this.clipper.height],i),new fabric.Line([0,.33*this.clipper.height,this.clipper.width,.33*this.clipper.height],i),new fabric.Line([0,.66*this.clipper.height,this.clipper.width,.66*this.clipper.height],i)],{left:this.clipper.left,top:this.clipper.top,originX:"center",originY:"center"}),this.croppingCanvas.add(this.cropperHandles),this.croppingCanvas.add(this.cropperGrid),this.croppingCanvas.add(this.croppingRectangle)},_repositionCropper:function(t){if(this.croppingCanvas){var i={x:this.clipper.left-this.croppingCanvas.width/2,y:this.clipper.top-this.croppingCanvas.height/2};this.croppingCanvas.setDimensions({width:this.editorWidth,height:this.editorHeight});var e=this._getBoundingRectangle(this.imageVerticeCoords).width/t.width;this.clipper.width=Math.round(this.clipper.width*e),this.clipper.height=Math.round(this.clipper.height*e),this.clipper.left=this.editorWidth/2+i.x*e,this.clipper.top=this.editorHeight/2+i.y*e,this.croppingShade.set({width:this.editorWidth,height:this.editorHeight,left:this.editorWidth/2,top:this.editorHeight/2}),this._redrawCropperElements(),this.renderCropper()}},_getBoundingRectangle:function(t){return{width:Math.max(t.a.x,t.b.x,t.c.x,t.d.x)-Math.min(t.a.x,t.b.x,t.c.x,t.d.x),height:Math.max(t.a.y,t.b.y,t.c.y,t.d.y)-Math.min(t.a.y,t.b.y,t.c.y,t.d.y)}},_handleMouseDown:function(t){var i=this.focalPoint&&this._isMouseOver(t,this.focalPoint),e=this.croppingCanvas&&this._isMouseOver(t,this.clipper),s=this.croppingCanvas&&this._cropperHandleHitTest(t);(s||e||i)&&(this.previousMouseX=t.pageX,this.previousMouseY=t.pageY,i?this.draggingFocal=!0:s?this.scalingCropper=s:e&&(this.draggingCropper=!0))},_handleMouseMove:function(t){this.focalPoint&&this.draggingFocal?(this._handleFocalDrag(t),this.storeFocalPointState(),this.renderImage()):this.draggingCropper||this.scalingCropper?(this.draggingCropper?this._handleCropperDrag(t):this._handleCropperResize(t),this._redrawCropperElements(),this.storeCropperState(),this.renderCropper()):this._setMouseCursor(t),this.previousMouseX=t.pageX,this.previousMouseY=t.pageY},_handleMouseUp:function(t){this.draggingCropper=!1,this.scalingCropper=!1,this.draggingFocal=!1},_handleCropperDrag:function(t){var i=t.pageX-this.previousMouseX,e=t.pageY-this.previousMouseY;if(0!==i||0!==e){var s={left:this.clipper.left-this.clipper.width/2,top:this.clipper.top-this.clipper.height/2,width:this.clipper.width,height:this.clipper.height},h=this._getRectangleVertices(s,i,e);this.arePointsInsideRectangle(h,this.imageVerticeCoords)&&this.clipper.set({left:this.clipper.left+i,top:this.clipper.top+e})}},_handleFocalDrag:function(t){if(this.focalPoint){var i=t.pageX-this.previousMouseX,e=t.pageY-this.previousMouseY;if(0===i&&0===e)return;var s=this.focalPoint.left+i,h=this.focalPoint.top+e;if("crop"===this.currentView){if(!this.arePointsInsideRectangle([{x:s,y:h}],this.imageVerticeCoords))return}else if(!(this.viewport.left-this.viewport.width/2-s<0&&this.viewport.left+this.viewport.width/2-s>0&&this.viewport.top-this.viewport.height/2-h<0&&this.viewport.top+this.viewport.height/2-h>0))return;this.focalPoint.set({left:this.focalPoint.left+i,top:this.focalPoint.top+e})}},setCroppingConstraint:function(t){switch(this.updateSizeAndPosition(),t){case"none":t=!1;break;case"original":t=this.originalWidth/this.originalHeight;break;case"current":t=this.clipper.width/this.clipper.height;break;default:t=parseFloat(t)}this.croppingConstraint=t},enforceCroppingConstraint:function(){if(!this.animationInProgress&&this.croppingConstraint){this.animationInProgress=!0;var t={left:this.clipper.left-this.clipper.width/2,top:this.clipper.top-this.clipper.height/2,width:this.clipper.width,height:this.clipper.height};if(this.clipper.width>this.clipper.height*this.croppingConstraint){var i=t.height;t.height=this.clipper.width/this.croppingConstraint,t.top-=(t.height-i)/2,this.arePointsInsideRectangle(this._getRectangleVertices(t),this.imageVerticeCoords)||(t.width=this.clipper.height*this.croppingConstraint,t.height=t.width/this.croppingConstraint)}else{var e=t.width;t.width=this.clipper.height*this.croppingConstraint,t.left-=(t.width-e)/2,this.arePointsInsideRectangle(this._getRectangleVertices(t),this.imageVerticeCoords)||(t.height=this.clipper.width/this.croppingConstraint,t.width=t.height*this.croppingConstraint)}var s={height:t.height,width:t.width};this.clipper.animate(s,{onChange:function(){this._redrawCropperElements(),this.croppingCanvas.renderAll()}.bind(this),duration:this.settings.animationDuration,onComplete:function(){this._redrawCropperElements(),this.animationInProgress=!1,this.renderCropper()}.bind(this)})}},_handleCropperResize:function(t){var i=t.pageX-this.previousMouseX,e=t.pageY-this.previousMouseY,s=0,h=0;if("b"!==this.scalingCropper&&"t"!==this.scalingCropper||(i=0),"l"!==this.scalingCropper&&"r"!==this.scalingCropper||(e=0),0!==i||0!==e){var o={left:this.clipper.left-this.clipper.width/2,top:this.clipper.top-this.clipper.height/2,width:this.clipper.width,height:this.clipper.height};if(this.croppingConstraint){var a=0;switch(this.scalingCropper){case"t":a=-e;break;case"b":a=e;break;case"r":a=i;break;case"l":a=-i;break;case"tr":a=-e+i;break;case"tl":a=-e-i;break;case"br":a=e+i;break;case"bl":a=e-i}this.croppingConstraint>1?e=(i=a)/this.croppingConstraint:i=(e=a)*this.croppingConstraint,o.height+=e,o.width+=i,this.scalingCropper.match(/t/)&&(o.top-=e,o.left-=i/2,s=-e/2),this.scalingCropper.match(/b/)&&(o.left+=-i/2,s=e/2),this.scalingCropper.match(/r/)&&(o.top+=-e/2,h=i/2),this.scalingCropper.match(/l/)&&(o.top-=e/2,o.left-=i,h=-i/2)}else{if(this.shiftKeyHeld&&("tl"===this.scalingCropper||"tr"===this.scalingCropper||"bl"===this.scalingCropper||"br"===this.scalingCropper)){Math.abs(i)>Math.abs(e)?(e=i/(this.clipper.width/this.clipper.height),e*="tr"===this.scalingCropper||"bl"===this.scalingCropper?-1:1):(i=e*(this.clipper.width/this.clipper.height),i*="tr"===this.scalingCropper||"bl"===this.scalingCropper?-1:1)}this.scalingCropper.match(/t/)&&(o.top+=e,o.height-=e),this.scalingCropper.match(/b/)&&(o.height+=e),this.scalingCropper.match(/r/)&&(o.width+=i),this.scalingCropper.match(/l/)&&(o.left+=i,o.width-=i),s=e/2,h=i/2}o.height<30||o.width<30||this.arePointsInsideRectangle(this._getRectangleVertices(o),this.imageVerticeCoords)&&(this.clipper.set({top:this.clipper.top+s,left:this.clipper.left+h,width:o.width,height:o.height}),this._redrawCropperElements())}},_setMouseCursor:function(t){var i="default",e=this.croppingCanvas&&this._cropperHandleHitTest(t);this.focalPoint&&this._isMouseOver(t,this.focalPoint)?i="pointer":e?"t"===e||"b"===e?i="ns-resize":"l"===e||"r"===e?i="ew-resize":"tl"===e||"br"===e?i="nwse-resize":"bl"!==e&&"tr"!==e||(i="nesw-resize"):this.croppingCanvas&&this._isMouseOver(t,this.clipper)&&(i="move"),$(".body").css("cursor",i)},_cropperHandleHitTest:function(t){var i=this.$croppingCanvas.offset(),e=t.pageX-i.left,s=t.pageY-i.top,h=this.clipper.left-this.clipper.width/2,o=h+this.clipper.width,a=this.clipper.top-this.clipper.height/2,n=a+this.clipper.height;if(e<h+10&&e>h-3){if(s<a+10&&s>a-3)return"tl";if(s<n+3&&s>n-10)return"bl"}if(e>o-13&&e<o+3){if(s<a+10&&s>a-3)return"tr";if(s<n+2&&s>n-10)return"br"}return e<h+3&&e>h-3&&s<n-10&&s>a+10?"l":e<o+1&&e>o-5&&s<n-10&&s>a+10?"r":s<a+4&&s>a-2&&e>h+10&&e<o-10?"t":s<n+2&&s>n-4&&e>h+10&&e<o-10&&"b"},_isMouseOver:function(t,i){var e=this.$croppingCanvas.offset(),s=t.pageX-e.left,h=t.pageY-e.top,o=i.left-i.width/2,a=o+i.width,n=i.top-i.height/2,r=n+i.height;return s>=o&&s<=a&&h>=n&&h<=r},_getRectangleVertices:function(t,i,e){void 0===i&&(i=0),void 0===e&&(e=0);var s={x:t.left+i,y:t.top+e},h={x:s.x+t.width,y:s.y},o={x:h.x,y:h.y+t.height};return[s,h,o,{x:s.x,y:o.y}]},_setFittedImageVerticeCoordinates:function(){this.imageVerticeCoords=this.getImageVerticeCoords("fit")},getImageVerticeCoords:function(t){var i,e=-1*((this.hasOrientationChanged()?90:0)+this.imageStraightenAngle)*(Math.PI/180),s=this.getScaledImageDimensions();i="number"==typeof t?t:"cover"===t?this.getZoomToCoverRatio(s):this.getZoomToFitRatio(s);var h=s.height*i,o=s.width*i,a=Math.cos(e)*h,n=Math.sin(e)*o,r=Math.cos(e)*o,p=Math.sin(e)*h,c=(this.editorHeight-(a+n))/2,g=(this.editorWidth-(p+r))/2;return{a:{x:g+r,y:c},b:{x:this.editorWidth-g,y:c+a},c:{x:g+p,y:this.editorHeight-c},d:{x:g,y:c+n}}},_debug:function(t){this.canvas.remove(this.debugger),this.debugger=t,this.canvas.add(this.debugger)},arePointsInsideRectangle:function(t,i){for(var e=this._getVector(i.a,i.b),s=this._getVector(i.b,i.c),h=this._getScalarProduct(e,e),o=this._getScalarProduct(s,s),a=0;a<t.length;a++){var n=t[a],r=this._getVector(i.a,n),p=this._getVector(i.b,n),c=this._getScalarProduct(e,r),g=this._getScalarProduct(s,p),l=0<=c&&c<=h,d=0<=g&&g<=o;if(!l||!d)return!1}return!0},_getVector:function(t,i){return{x:i.x-t.x,y:i.y-t.y}},_getScalarProduct:function(t,i){return t.x*i.x+t.y*i.y},_getVectorMagnitude:function(t){return Math.sqrt(t.x*t.x+t.y*t.y)},_getAngleBetweenVectors:function(t,i){return Math.round(180*Math.acos(Math.min(1,this._getScalarProduct(t,i)/(this._getVectorMagnitude(t)*this._getVectorMagnitude(i))))/Math.PI*100)/100},_getEdgeCrossed:function(t,i){for(var e=[[t.a,t.b],[t.b,t.c],[t.c,t.d],[t.d,t.a]],s={x:this.editorWidth/2,y:this.editorHeight/2},h=180,o=null,a=0;a<e.length;a++){var n=e[a],r=this._getVector(n[0],s),p=this._getVector(n[0],n[1]),c=this._getVector(n[0],i),g=Math.abs(this._getAngleBetweenVectors(r,c)-(this._getAngleBetweenVectors(r,p)+this._getAngleBetweenVectors(p,c)));g<h&&(h=g,o=n)}return o},_getImageBoundingBox:function(t){var i={},e=Math.abs(this.imageStraightenAngle)*(Math.PI/180),s=t.height/t.width;if(i.height=t.width*(Math.sin(e)+Math.cos(e)*s),i.width=t.width*(Math.cos(e)+Math.sin(e)*s),this.hasOrientationChanged()){var h=i.width;i.width=i.height,i.height=h}return i}},{defaults:{animationDuration:100,allowSavingAsNew:!0,onSave:$.noop,allowDegreeFractions:!0}});
//# sourceMappingURL=AssetImageEditor.min.js.map